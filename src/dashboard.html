<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EASEPrint Admin Dashboard</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Other libraries -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Your Custom Stylesheet (Last) -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /* --- FONT FIXES START --- */
    
    /* 1. Restore the original font for the entire app */
    body {
        font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* 2. Apply the new 'Inter' font ONLY to the transactions section */
    #transactions {
        font-family: 'Inter', sans-serif;
    }

    /* 3. Explicitly re-style headings that were reset by Tailwind */
    .sidebar h2 {
        color: #FBB3C8;
        text-align: center;
        margin: 0 0 30px 0;
        padding: 0 20px;
        font-size: 1.5rem;
        font-weight: 700; /* Restore bold weight */
    }
    
    .main > div:not(#transactions) h1,
    .main > div:not(#transactions) h2,
    .main > div:not(#transactions) h3 {
        font-weight: 700; 
        color: #3F1A2B;  
    }
    .main > div:not(#transactions) h1 {
        font-size: 2rem;
        border-bottom: 2px solid #FBB3C8;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .main > div:not(#transactions) h2 {
        font-size: 1.5rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    /* --- FONT FIXES END --- */

    .hidden { display: none; }
    #editModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #editModal form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 100%;
    }

    .main > div:not(#transactions) {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    img { max-width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 10px; text-align: left; }
    button { padding: 5px 10px; margin: 2px; cursor: pointer; }
    textarea { width: 100%; height: 40px; }
    .approved { background-color: #d4f8d4; }
    .rejected { background-color: #ffdada; }
    .pending { background-color: #fff5d1; }
    .filter-box { margin-bottom: 15px; }
    select { padding: 5px; }
    
    /* Toast */
    #toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #1f2937;
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        font-size: 0.875rem;
        transition: opacity 0.3s, transform 0.3s;
        opacity: 0;
        z-index: 100;
    }
    @keyframes fadeInOut {
        0%, 100% { opacity: 0; transform: translateY(20px); }
        10%, 90% { opacity: 1; transform: translateY(0); }
    }
    .toast-active {
        animation: fadeInOut 3s forwards;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="sidebar">
  <h2>EASEPrint</h2>
  <ul>
    <li onclick="showSection('home')"><i class="fas fa-home"></i> Dashboard</li>
    <li onclick="showSection('products')"><i class="fas fa-box-open"></i> Products</li>
    <li onclick="showSection('orders')"><i class="fas fa-shopping-cart"></i> Orders</li>
    <li onclick="showSection('appointments')"><i class="fas fa-calendar-alt"></i> Appointments</li>
    <li onclick="showSection('tracking')"><i class="fas fa-truck"></i> Tracking</li>
    <li onclick="showSection('transactions')"><i class="fas fa-receipt"></i> Transactions</li>
    <li onclick="showSection('analytics')"><i class="fas fa-chart-line"></i> Analytics</li>
    <li onclick="showSection('chat')"><i class="fas fa-comments"></i> Chat</li>
    <li onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</li>
  </ul>
</div>

  <div class="main">
    <div id="home">
      <h1>Dashboard</h1>
      <p>Overview of orders, sales, and top products.</p>

<div id="topSalesSection" class="hidden">
  <h2><i class="fas fa-trophy"></i> Top Sales</h2>
  <ul id="topSalesList"></ul>

  <div id="topSalesChartSection">
    <h2><i class="fas fa-chart-pie"></i> Top Sales Pie Chart</h2>
    <canvas id="topSalesChart" width="400" height="400"></canvas>
  </div>
</div>

    </div>

    <div id="products" class="hidden">
      <h1>Product Upload</h1>
      <form id="productForm">
        <input type="text" id="productName" placeholder="Product Name" required>
        <input type="number" id="productPrice" placeholder="Price" required>
        <input type="number" id="productStock" placeholder="Stock" required>
        <textarea id="productDescription" placeholder="Description"></textarea>
        <input type="file" id="productImage" required>

        <select id="productCategory" required>
          <option value="">Select Category</option>
          <option value="1">Jerseys</option>
          <option value="2">Shirts</option>
          <option value="3">Shorts</option>
          <option value="4">Jackets</option>
          <option value="5">Others</option>
        </select>

        <button type="submit">Upload</button>
      </form>


      <h2>Uploaded Products</h2>
      <table id="productTable" border="1">
        <thead>
          <tr>
            <th>Image</th>
            <th>Name</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

<div id="orders" class="hidden">
  <h1>Orders</h1>

  <button class="refresh-btn" onclick="fetchOrders()">
    <i class="fas fa-sync-alt"></i> Refresh
  </button>

  <table id="ordersTable" border="1" style="width: 100%; margin-top: 15px; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>User</th>
        <th>Phone</th>
        <th>Total</th>
        <th>Items</th>
        <th>Status</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="8">Loading orders...</td></tr>
    </tbody>
  </table>
</div>


  <div id="appointments" class="hidden"><h1>Appointments</h1>
  <h1>Custom Shirt Requests</h1>

  <div class="filter-box">
    <label for="statusFilter">Show: </label>
    <select id="statusFilter" onchange="fetchRequests()">
      <option value="All">All</option>
      <option value="Pending">Pending</option>
      <option value="Approved">Approved</option>
      <option value="Rejected">Rejected</option>
    </select>
  </div>

  <table id="requestsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Full Name</th>
        <th>Phone</th>
        <th>Email</th>
        <th>Design</th>
        <th>Size</th>
        <th>Quantity</th>
        <th>Notes</th>
        <th>Status</th>
        <th>Admin Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="requestsBody">
      <tr><td colspan="11">Loading...</td></tr>
    </tbody>
  </table>


<h2>Appointments Schedule</h2>
<div class="controls">
  <label>
    Filter:
    <select id="appointmentsStatusFilter">
      <option value="">All</option>
      <option value="pending">Pending</option>
      <option value="approved">Approved</option>
      <option value="rejected">Rejected</option>
    </select>
  </label>
  <button id="appointmentsReloadBtn">Reload</button>
</div>

<table id="appointmentsTbl">
  <thead>
    <tr>
      <th>ID</th><th>Name</th><th>Phone</th><th>Email</th>
      <th>Date</th><th>Status</th><th>QR</th><th>PDF</th><th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>




<div id="tracking" class="hidden">
    <h1>Order Tracking</h1>
    <div id="tracking-section">
        </div>
</div>


 <div id="transactions" class="hidden">
        <div>
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Sales & Transactions</h1>
                <p class="text-gray-500 mt-1">Manually record sales and view the complete transaction history.</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-900 border-b pb-3 mb-6">Record a New Sale</h3>
                    
                    <div class="space-y-5">
                        <div>
                            <label for="item" class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                            <input type="text" id="item" placeholder="e.g., Custom Jersey Print" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                        </div>

                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
                                <input type="number" id="price" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                            </div>
                            <div class="flex-1">
                                <label for="qty" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                <input type="number" id="qty" placeholder="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="orderStatus" class="block text-sm font-medium text-gray-700 mb-1">Order Status</label>
                                <select id="orderStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                                    <option value="Pending">Pending</option>
                                    <option value="Successful">Successful</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label for="paymentStatus" class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                                <select id="paymentStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                                    <option value="Pending">Pending</option>
                                    <option value="Done">Done</option>
                                </select>
                            </div>
                        </div>

                        <button onclick="submitTransaction()" class="w-full bg-[#ED4A69] text-white font-semibold py-3 px-4 rounded-lg hover:bg-[#d4435d] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#ED4A69] transition-transform transform hover:scale-105">
                            <i class="fas fa-plus-circle mr-2"></i> Add Transaction
                        </button>
                        <div id="response" class="text-center mt-2"></div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white rounded-xl shadow-md">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-semibold text-gray-900">Sales History</h3>
                    </div>
                    <div class="table-container max-h-[600px] overflow-y-auto">
                        <table class="w-full text-sm text-left text-gray-500" style="border: none;">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0" style="border: none;">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Date</th>
                                    <th scope="col" class="px-6 py-3">Item Name</th>
                                    <th scope="col" class="px-6 py-3 text-right">Unit Price</th>
                                    <th scope="col" class="px-6 py-3 text-center">Quantity</th>
                                    <th scope="col" class="px-6 py-3 text-center">Order Status</th>
                                    <th scope="col" class="px-6 py-3 text-center">Payment Status</th>
                                    <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="transactionModal" class="hidden">
      <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
        <h3 class="text-xl font-semibold text-gray-900 border-b pb-3 mb-6">Edit Transaction</h3>
        <input id="editTransactionId" type="hidden" />
        <div class="space-y-5">
            <div>
                <label for="editItem" class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                <input type="text" id="editItem" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
            </div>
            <div class="flex space-x-4">
                <div class="flex-1">
                    <label for="editPrice" class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
                    <input type="number" id="editPrice" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                </div>
                <div class="flex-1">
                    <label for="editQty" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                    <input type="number" id="editQty" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                </div>
            </div>
            <div class="flex space-x-4">
                <div class="flex-1">
                    <label for="editOrderStatus" class="block text-sm font-medium text-gray-700 mb-1">Order Status</label>
                    <select id="editOrderStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                        <option value="Pending">Pending</option>
                        <option value="Successful">Successful</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label for="editPaymentStatus" class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                    <select id="editPaymentStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                        <option value="Pending">Pending</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button onclick="closeTransactionModal()" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button onclick="saveEdit()" class="px-6 py-2 bg-[#ED4A69] text-white rounded-lg hover:bg-[#d4435d] transition">Save Changes</button>
            </div>
        </div>
      </div>
    </div>



    <div id="analytics" class="hidden">
      <h1>Analytics</h1>
      
    <div>
  <label for="salesPeriod">Select Period:</label>
  <select id="salesPeriod">
    <option value="day">Daily</option>
    <option value="week">Weekly</option>
    <option value="month" selected>Monthly</option>
    <option value="year">Yearly</option>
  </select>
</div>

  <div id="salesTrendsSection">
    <h2><i class="fas fa-chart-bar"></i> Sales Trends</h2>
    <canvas id="salesLineChart" width="600" height="300"></canvas>
    <canvas id="salesBarChart" width="600" height="300" style="margin-top:20px;"></canvas>
  </div>
  </div>
    
  <div id="chat" class="hidden">
    <div class="chat-header">
      <h1 id="chatTitle">Customer Support Chat</h1>
    </div>

    <div class="chat-header-row">
      <div id="activeCustomer" class="active-customer">No customer selected</div>

      <div class="custom-select" id="customerSelectWrapper">
        <button id="customerSelectBtn" class="select-btn" aria-haspopup="listbox" aria-expanded="false">
          -- Select a Customer -- <i class="fas fa-caret-down" style="margin-left:8px"></i>
        </button>
        <ul id="customerList" class="select-list hidden" role="listbox" tabindex="-1"></ul>
      </div>
    </div>

    <div id="chatBox"></div>

    <div class="chat-input-row">
      <input id="chatInput" type="text" placeholder="Type a message..." />
      <button id="sendMsgBtn" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <div id="settings" class="hidden">
    <h1>Account Settings</h1>
    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </div>
  </div>

  <div id="editModal">
    <form id="editForm" enctype="multipart/form-data">
      <h3>Edit Product</h3>
      <input type="hidden" id="editProductId" />
      <input type="text" id="editName" placeholder="Product Name" required />
      <input type="number" id="editprice" placeholder="Price (e.g. 99.99)" step="0.01" min="0" required />
      <input type="number" id="editStock" placeholder="Stock" required />
      <textarea id="editDescription" placeholder="Description" required></textarea>
      <input type="file" id="editImage" accept="image/*" />
      <button type="submit">Save</button>
      <button type="button" onclick="closeEditModal()">Cancel</button>
    </form>
  </div>

  <div id="toast-notification">
      <p id="toast-message"></p>
  </div>


  <script>
    const token = localStorage.getItem('adminToken');
    if (!token) window.location.href = './index.html';

    function showSection(id) {
      document.querySelectorAll('.main > div').forEach(div => div.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if (id === 'products') loadProducts();
      if (id === 'transactions') fetchTransactions();
      if (id === 'tracking') initializeTracking();
    }

    function logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminEmail');
      window.location.href = './index.html';
    }

// Product Upload
document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const formData = new FormData();
  formData.append('name', document.getElementById('productName').value);
  formData.append('price', document.getElementById('productPrice').value);
  formData.append('stock', document.getElementById('productStock').value);
  formData.append('description', document.getElementById('productDescription').value);
  formData.append('image', document.getElementById('productImage').files[0]);
  formData.append('category_id', document.getElementById('productCategory').value);

  try {
    const res = await fetch('http://127.0.0.1:8000/api/admin/products', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${token}`
      },
      body: formData
    });

    const result = await res.json();
    if (!res.ok) throw new Error(result.message || 'Upload failed');

    // Reset form and reload
    e.target.reset();
    loadProducts();

    // Show success toast
    showToast('Product uploaded successfully!', 'success');
  } catch (err) {
    console.error('Upload error:', err);

    // Show error toast
    showToast('Upload failed: ' + err.message, 'error');
  }
});

// Load categories into the dropdown
async function loadCategories() {
  const res = await fetch('http://127.0.0.1:8000/api/categories', {
    headers: { Authorization: `Bearer ${token}` }
  });
  const categories = await res.json();

  const categorySelect = document.getElementById('productCategory');
  categorySelect.innerHTML = '<option value="">-- Select Category --</option>';

  categories.forEach(c => {
    categorySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
  });
}

// Call it when the page loads
loadCategories();


async function loadProducts() {
  const res = await fetch('http://127.0.0.1:8000/api/admin/products', {
    headers: { Authorization: `Bearer ${token}` }
  });
  const products = await res.json();
  const tbody = document.querySelector('#productTable tbody');
  tbody.innerHTML = '';

  products.forEach(p => {
    const imageSrc = p.image_url || 'placeholder.png'; // fallback if no image
    const row = `
      <tr>
        <td><img src="${imageSrc}" width="50" /></td>
        <td>${p.name}</td>
        <td>${p.price}</td>
        <td>${p.stock}</td>
        <td>${p.description}</td>
        <td>
          <button class="edit-btn" onclick="editProduct(${p.id})">
            <i class="fas fa-edit"></i> Edit
          </button>
          <button class="delete-btn" onclick="deleteProduct(${p.id})">
            <i class="fas fa-trash"></i> Delete
          </button>
        </td>
      </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', row);
  });
}

    function editProduct(id) {
      fetch('http://127.0.0.1:8000/api/admin/products', {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(products => {
        const p = products.find(prod => prod.id === id);
        if (!p) return alert('Product not found.');
        document.getElementById('editProductId').value = p.id;
        document.getElementById('editName').value = p.name;
        document.getElementById('editprice').value = p.price;
        document.getElementById('editStock').value = p.stock;
        document.getElementById('editDescription').value = p.description;
        document.getElementById('editModal').style.display = 'flex';
      });
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

document.getElementById('editForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = document.getElementById('editProductId').value;
  const formData = new FormData();
  formData.append('name', document.getElementById('editName').value);
  formData.append('price', document.getElementById('editprice').value);
  formData.append('stock', document.getElementById('editStock').value);
  formData.append('description', document.getElementById('editDescription').value);

  const newImage = document.getElementById('editImage').files[0];
  if (newImage) {
    formData.append('image', newImage);
  }
  formData.append('_method', 'PUT');

  try {
    const res = await fetch(`http://127.0.0.1:8000/api/admin/products/${id}`, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${token}`
      },
      body: formData
    });

    const result = await res.json();
    if (!res.ok) {
      throw new Error(result.message || 'Failed to update product');
    }

    closeEditModal();
    loadProducts();
    alert('Product updated successfully!');
  } catch (err) {
    console.error('Update error:', err);
    alert('Error updating product: ' + err.message);
  }
});


async function deleteProduct(id) {
  if (!confirm('Are you sure you want to delete this product?')) return;

  try {
    const res = await fetch(`http://127.0.0.1:8000/api/admin/products/${id}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });

    const result = await res.json();
    
    if (!res.ok) {
      throw new Error(result.message || 'Delete failed');
    }
    
    // Reset the product form
    document.getElementById('productForm').reset();
    
    // Reload products after a short delay
    loadProducts();
  } catch (err) {
    console.error('Delete error:', err);
    alert('Delete failed: ' + err.message);
  }
}


document.addEventListener('DOMContentLoaded', () => {
  loadCustomers();
  setInterval(fetchMessages, 3000); // auto refresh
  setInterval(checkAllCustomersForNewMessages, 3000);
});
const hasNewMessageMap = {};

let selectedCustomerId = null;

async function loadCustomers() {
  const res = await fetch('http://127.0.0.1:8000/api/customers');
  const customers = await res.json();
  const select = document.getElementById('customerSelect');

  select.innerHTML = '<option disabled selected value="">-- Select a Customer --</option>';

  customers.forEach(c => {
    const option = document.createElement('option');
    option.value = c.id;
    option.textContent = c.name;

    // Initialize lastReadMessageId for new customers
    if (!(c.id in lastReadMessageIdPerCustomer)) {
      lastReadMessageIdPerCustomer[c.id] = 0;
    }

    select.appendChild(option);
  });

  updateCustomerUnreadIndicators();
}

// escape helper
function escapeHtml(str) {
  return String(str).replace(/[&<>"'`=\/]/g, function(s) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s];
  });
}

async function loadCustomers() {
  try {
    const res = await fetch('http://127.0.0.1:8000/api/customers');
    const customers = await res.json();

    const list = document.getElementById('customerList');
    const btn = document.getElementById('customerSelectBtn');

    // reset
    list.innerHTML = '';
    btn.textContent = '-- Select a Customer -- ';
    btn.removeAttribute('data-id');
    btn.setAttribute('aria-expanded', 'false');

    customers.forEach(c => {
      const li = document.createElement('li');
      li.className = 'customer-item';
      li.dataset.id = c.id;
      li.innerHTML = `
        <span class="customer-name">${escapeHtml(c.name)}</span>
        <span class="unread-dot"></span>
      `;
      li.addEventListener('click', () => selectCustomer(c));
      list.appendChild(li);
    });

    updateCustomerUnreadIndicators();
  } catch (err) {
    console.error('Failed to load customers:', err);
  }
}

function selectCustomer(c) {
  const btn = document.getElementById('customerSelectBtn');
  const list = document.getElementById('customerList');

  btn.textContent = c.name;
  btn.dataset.id = c.id;
  btn.setAttribute('aria-expanded', 'false');
  list.classList.add('hidden');

  selectedCustomerId = c.id;

  // âœ… Update header
  document.getElementById('activeCustomer').textContent = c.name;

  // clear unread dot for this customer
  const dot = document.querySelector(`#customerList li[data-id="${c.id}"] .unread-dot`);
  if (dot) dot.innerHTML = '';

  // remove button dot if no other unread
  const stillUnread = Array.from(document.querySelectorAll('#customerList .unread-dot'))
    .some(d => d.innerHTML.trim() !== '');
  const btnDot = btn.querySelector('.btn-unread-dot');
  if (btnDot && !stillUnread) btnDot.remove();

  fetchMessages();
  markMessagesRead(c.id);
}

async function updateCustomerUnreadIndicators() {
  const items = Array.from(document.querySelectorAll('#customerList li'));
  for (const li of items) {
    const id = li.dataset.id;
    const placeholder = li.querySelector('.unread-dot');

    let unread = !!hasNewMessageMap[id];
    if (!unread) {
      try { unread = await hasUnread(id); } catch { unread = false; }
    }

    if (unread) {
      placeholder.innerHTML = `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle></svg>`;
    } else {
      placeholder.innerHTML = '';
    }
  }

  // button dot
  const anyUnread = items.some(li => li.querySelector('.unread-dot').innerHTML.trim() !== '');
  const btn = document.getElementById('customerSelectBtn');
  if (btn) {
    if (anyUnread) {
      if (!btn.querySelector('.btn-unread-dot')) {
        const dot = document.createElement('span');
        dot.className = 'btn-unread-dot';
        dot.style.cssText = 'display:inline-block;width:10px;height:10px;border-radius:50%;background:#28a745;margin-left:8px;';
        btn.appendChild(dot);
      }
    } else {
      const old = btn.querySelector('.btn-unread-dot');
      if (old) old.remove();
    }
  }
}

// dropdown toggle
document.addEventListener('click', function(e) {
  const wrapper = document.getElementById('customerSelectWrapper');
  const btn = document.getElementById('customerSelectBtn');
  const list = document.getElementById('customerList');
  if (!wrapper) return;

  if (e.target.closest('#customerSelectBtn')) {
    const isOpen = !list.classList.contains('hidden');
    list.classList.toggle('hidden', isOpen);
    btn.setAttribute('aria-expanded', String(!isOpen));
    return;
  }

  if (!e.target.closest('#customerSelectWrapper')) {
    list.classList.add('hidden');
    btn.setAttribute('aria-expanded', 'false');
  }
});

document.addEventListener('DOMContentLoaded', loadCustomers);

async function hasUnread(customerId) {
  if (hasNewMessageMap[customerId]) {
    return true;
  }

  try {
    const res = await fetch(`http://127.0.0.1:8000/api/messages/${customerId}`);
    const messages = await res.json();
    if (messages.length === 0) return false;

    const lastReadId = lastReadMessageIdPerCustomer[customerId] || 0;
    const latestMsgId = messages[messages.length - 1].id;
    return latestMsgId > lastReadId;
  } catch {
    return false;
  }
}


function handleCustomerChange() {
  selectedCustomerId = document.getElementById('customerSelect').value;
  fetchMessages();

  // When switching customer, mark messages as read by updating lastReadMessageId
  markMessagesRead(selectedCustomerId);
  updateCustomerUnreadIndicators();
}

function formatTimestamp(dateString) {
  const date = new Date(dateString);
  const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const day = date.toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' });
  return `${day} at ${time}`;
}

let lastReadMessageIdPerCustomer = JSON.parse(localStorage.getItem('lastReadIds')) || {};
let lastFetchedMessageId = 0;

async function fetchMessages() {
  if (!selectedCustomerId) return;

  const res = await fetch(`http://127.0.0.1:8000/api/messages/${selectedCustomerId}`);
  const messages = await res.json();
  const chatBox = document.getElementById('chatBox');

  const isAtBottom = chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 50;

  // Detect new messages
  if (messages.length > 0) {
    const latestMsgId = messages[messages.length - 1].id;
    if (latestMsgId > lastFetchedMessageId) {
      if (selectedCustomerId !== null && latestMsgId !== lastFetchedMessageId) {
        notifyNewMessage(messages[messages.length - 1]);
      }
      lastFetchedMessageId = latestMsgId;
    }
  }

  chatBox.innerHTML = '';

  messages.forEach(msg => {
    const isSent = msg.is_admin;
    const timestamp = formatTimestamp(msg.created_at);

    const lastReadId = lastReadMessageIdPerCustomer[selectedCustomerId] || 0;
    const isUnread = msg.id > lastReadId;

    const wrapper = document.createElement('div');
    wrapper.classList.add('message-wrapper', isSent ? 'sent-wrapper' : 'received-wrapper');

    wrapper.innerHTML = `
      <div class="message ${isSent ? 'sent' : 'received'} ${isUnread ? 'unread' : 'read'}">
        ${msg.message}
      </div>
      <div class="timestamp-only">${timestamp}</div>
    `;


    chatBox.appendChild(wrapper);
  });

  // Mark messages as read and persist to localStorage
  if (messages.length > 0) {
    const lastMsgId = messages[messages.length - 1].id;
    lastReadMessageIdPerCustomer[selectedCustomerId] = lastMsgId;
    localStorage.setItem('lastReadIds', JSON.stringify(lastReadMessageIdPerCustomer));
  }

  if (isAtBottom) {
    chatBox.scrollTop = chatBox.scrollHeight;
  }
}



function markMessagesRead(customerId) {
  fetch(`http://127.0.0.1:8000/api/messages/${customerId}`)
    .then(res => res.json())
    .then(messages => {
      if (messages.length === 0) return;
      lastReadMessageIdPerCustomer[customerId] = messages[messages.length - 1].id;

      hasNewMessageMap[customerId] = false; // âœ… clear red dot flag

      updateCustomerUnreadIndicators();
    });
}


async function sendMessage() {
  const msg = document.getElementById('chatInput').value;
  if (!selectedCustomerId || !msg.trim()) return;

  await fetch('http://127.0.0.1:8000/api/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      sender_id: 0,
      receiver_id: selectedCustomerId,
      message: msg,
      is_admin: true
    })
  });

  document.getElementById('chatInput').value = '';
  fetchMessages();
}

// Desktop notification for new messages
function notifyNewMessage(msg) {
  console.log("ðŸ”” Notification triggered:", msg);
  if (document.hidden && Notification.permission === 'granted') {
    const notification = new Notification(`New message from ${msg.is_admin ? 'Admin' : msg.sender.name}`, {
      body: msg.message,
      icon: 'chat-icon.png', // optional: path to your icon
    });

    notification.onclick = () => {
      window.focus();
      // Optionally, switch to customer chat if you have UI for that
    };
  }
}




let lastFetchedMessageIdMap = {}; // per customer

async function checkAllCustomersForNewMessages() {
  const res = await fetch('http://127.0.0.1:8000/api/customers');
  const customers = await res.json();

  for (const customer of customers) {
    try {
      const res = await fetch(`http://127.0.0.1:8000/api/messages/${customer.id}`);
      const messages = await res.json();

      if (messages.length === 0) continue;

      const latestMsg = messages[messages.length - 1];

      // Only notify if the message is NOT from admin
      if (!latestMsg.is_admin) {
        const lastFetchedId = lastFetchedMessageIdMap[customer.id] || 0;

        if (latestMsg.id > lastFetchedId) {
          lastFetchedMessageIdMap[customer.id] = latestMsg.id;

          hasNewMessageMap[customer.id] = true;
          updateCustomerUnreadIndicators(); // âœ… Add this


          notifyNewMessage(latestMsg);
        }
      }
    } catch (err) {
      console.error(`Failed to check messages for customer ${customer.id}:`, err);
    }
  }
}

// Request notification permission once on page load
if ('Notification' in window && Notification.permission !== 'granted') {
  Notification.requestPermission();
}


let selectedTransactionId = null;

// TRANSACTIONS SYSTEM
 fetchTransactions();

async function fetchTransactions() {
Â  const res = await fetch('http://127.0.0.1:8000/api/transactions', {
Â  Â  headers: { Authorization: `Bearer ${token}` }
Â  });
Â  const transactions = await res.json();
Â  const list = document.getElementById('transactionsList');
Â  list.innerHTML = '';

Â  transactions.forEach(tx => {
Â  Â  const date = new Date(tx.created_at).toLocaleString('en-US', {
Â  Â    month: 'short', day: 'numeric', year: 'numeric',
Â  Â    hour: 'numeric', minute: 'numeric', hour12: true
Â  Â  });

    const itemNameEscaped = tx.item_name.replace(/'/g, "\\'");

Â  Â  const row = document.createElement('tr');
    row.className = "bg-white border-b hover:bg-gray-50";
    row.style.border = "none";

Â  Â  row.innerHTML = `
        <td class="px-6 py-4 text-gray-900 whitespace-nowrap" style="border:none">${date}</td>
        <td class="px-6 py-4 font-medium text-gray-900" style="border:none">${tx.item_name}</td>
        <td class="px-6 py-4 text-right" style="border:none">â‚±${parseFloat(tx.unit_price).toFixed(2)}</td>
        <td class="px-6 py-4 text-center" style="border:none">${tx.quantity}</td>
        <td class="px-6 py-4 text-center" style="border:none">
            <span class="status-pill ${tx.order_status === 'Successful' ? 'status-successful' : 'status-pending'}">${tx.order_status}</span>
        </td>
        <td class="px-6 py-4 text-center" style="border:none">
            <span class="status-pill ${tx.payment_status === 'Done' ? 'status-done' : 'status-pending'}">${tx.payment_status}</span>
        </td>
        <td class="px-6 py-4 text-right" style="border:none">
            <button onclick="openEditModal(${tx.id}, '${itemNameEscaped}', ${tx.unit_price}, ${tx.quantity}, '${tx.order_status}', '${tx.payment_status}')" class="text-[#ED4A69] hover:text-[#c13b56]"><i class="fas fa-edit fa-fw"></i></button>
            <button onclick="deleteTransaction(${tx.id})" class="text-red-600 hover:text-red-900 ml-2"><i class="fas fa-trash fa-fw"></i></button>
        </td>
Â  Â  `;
Â  Â  list.appendChild(row);
Â  });
}

async function submitTransaction() {
Â  const item = document.getElementById("item").value;
Â  const price = parseFloat(document.getElementById("price").value);
Â  const qty = parseInt(document.getElementById("qty").value);
Â  const orderStatus = document.getElementById("orderStatus").value;
Â  const paymentStatus = document.getElementById("paymentStatus").value;

Â  const responseDiv = document.getElementById("response");

Â  try {
Â  Â  Â  const res = await fetch('http://127.0.0.1:8000/api/transactions', {
Â  Â  method: "POST",
Â  Â  headers: {
Â  Â  Â  "Content-Type": "application/json",
Â  Â  Â  Authorization: `Bearer ${token}`
Â  Â  },
Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  item_name: item,
Â  Â  Â  Â  unit_price: price,
Â  Â  Â  Â  quantity: qty,
Â  Â  Â  Â  order_status: orderStatus,
Â  Â  Â  Â  payment_status: paymentStatus
Â  Â  Â  })
Â  Â  });

Â  Â  const data = await res.json();
Â  Â  responseDiv.innerText = data.message || 'Transaction added!';
Â  Â  responseDiv.style.color = "green";

Â  Â  document.getElementById("item").value = '';
Â  Â  document.getElementById("price").value = '';
Â  Â  document.getElementById("qty").value = '';
Â  Â  document.getElementById("orderStatus").value = 'Pending';
Â  Â  document.getElementById("paymentStatus").value = 'Pending';

Â  Â  fetchTransactions();
Â  } catch (err) {
Â  Â  responseDiv.innerText = 'Error saving transaction.';
Â  Â  responseDiv.style.color = "red";
Â  Â  console.error(err);
Â  }
}

function openEditModal(id, item_name, unit_price, quantity, order_status, payment_status) {
Â  selectedTransactionId = id;
Â  document.getElementById('editTransactionId').value = id;
Â  document.getElementById('editItem').value = item_name;
Â  document.getElementById('editPrice').value = unit_price;
Â  document.getElementById('editQty').value = quantity;
Â  document.getElementById('editOrderStatus').value = order_status;
Â  document.getElementById('editPaymentStatus').value = payment_status;
Â  const modal = document.getElementById('transactionModal');
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
}

function closeTransactionModal() {
Â  const modal = document.getElementById('transactionModal');
  modal.classList.add('hidden');
  modal.style.display = 'none';
}

async function saveEdit() {
Â  const id = document.getElementById('editTransactionId').value;
Â  const item = document.getElementById('editItem').value;
Â  const price = parseFloat(document.getElementById('editPrice').value);
Â  const qty = parseInt(document.getElementById('editQty').value);
Â  const orderStatus = document.getElementById('editOrderStatus').value;
Â  const paymentStatus = document.getElementById('editPaymentStatus').value;

Â  try {
Â  Â  await fetch(`http://127.0.0.1:8000/api/transactions/${id}`, {
Â  Â  method: "PUT",
Â  Â  headers: {
Â  Â  Â  "Content-Type": "application/json",
Â  Â  Â  Authorization: `Bearer ${token}`
Â  Â  },
Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  item_name: item,
Â  Â  Â  Â  unit_price: price,
Â  Â  Â  Â  quantity: qty,
Â  Â  Â  Â  order_status: orderStatus,
Â  Â  Â  Â  payment_status: paymentStatus
Â  Â  Â  })
Â  Â  });

Â  Â  closeTransactionModal();
Â  Â  fetchTransactions();
Â  } catch (err) {
Â  Â  console.error("Update failed:", err);
Â  }
}

async function deleteTransaction(id) {
Â  if (!confirm("Are you sure you want to delete this transaction?")) return;

Â  try {
Â  Â  const res = await fetch(`http://127.0.0.1:8000/api/transactions/${id}`, {
Â  Â  Â  method: 'DELETE',
Â  Â  Â  headers: { Authorization: `Bearer ${token}` }
Â  Â  });

Â  Â  if (!res.ok) {
Â  Â  Â  throw new Error('Failed to delete transaction');
Â  Â  }

Â  Â  document.getElementById("response").innerText = 'Transaction deleted successfully!';
Â  Â  document.getElementById("response").style.color = 'green';
Â  Â  
Â  Â  fetchTransactions();
Â  } catch (err) {
Â  Â  console.error("Delete error:", err);
Â  Â  alert("Error deleting transaction: " + err.message);
Â  }
}

// TOP SALES SECTION
async function fetchTopSales() {
  try {
    const res = await fetch('http://127.0.0.1:8000/api/top-sales');
    const data = await res.json();

    const section = document.getElementById('topSalesSection');
    const list = document.getElementById('topSalesList');
    list.innerHTML = ''; 

    if (data.length > 0) {
      section.classList.remove('hidden'); // ðŸ‘ˆ Show the section if there's data
    } else {
      section.classList.add('hidden'); // ðŸ‘ˆ Hide if no data
    }

    data.forEach((item, index) => {
      const li = document.createElement('li');
      li.textContent = `${index + 1}. ${item.item_name} â€” ${item.total_quantity} pcs`;
      list.appendChild(li);
    });
  } catch (err) {
    console.error('Error fetching top sales:', err);
  }
}


setInterval(() => {
  fetchTopSales();
}, 1000);


let topSalesChartInstance = null;

async function renderTopSalesPieChart() {
  try {
    const res = await fetch('http://127.0.0.1:8000/api/top-sales');
    const data = await res.json();

    const labels = data.map(item => item.item_name);
    const quantities = data.map(item => item.total_quantity);

    const ctx = document.getElementById('topSalesChart').getContext('2d');

    // Destroy old chart if it exists
    if (topSalesChartInstance) {
      topSalesChartInstance.destroy();
    }

    topSalesChartInstance = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          label: 'Top Sales',
          data: quantities,
          backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56',
            '#4BC0C0', '#9966FF', '#FF9F40'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
          },
          title: {
            display: true,
            text: 'Top Selling Products'
          }
        }
      }
    });

  } catch (err) {
    console.error('Error rendering Top Sales Pie Chart:', err);
  }
}

// Auto-refresh every 5 seconds
setInterval(renderTopSalesPieChart, 5000);

// Load once on page load
document.addEventListener('DOMContentLoaded', renderTopSalesPieChart);

//chartttsss

let salesLineChartInstance = null;
let salesBarChartInstance = null;

async function renderSalesTrendsCharts() {
  const period = document.getElementById('salesPeriod').value;

  try {
    const res = await fetch(`http://127.0.0.1:8000/api/sales-trends?period=${period}`);
    const data = await res.json();

    const labels = data.map(entry => entry.period);
    const sales = data.map(entry => parseFloat(entry.total_sales));

    // ===== Line Chart =====
    const ctxLine = document.getElementById('salesLineChart').getContext('2d');
    if (salesLineChartInstance) salesLineChartInstance.destroy();
    salesLineChartInstance = new Chart(ctxLine, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: `Sales (${period})`,
          data: sales,
          borderColor: '#36A2EB',
          backgroundColor: 'rgba(54,162,235,0.2)',
          fill: true,
          tension: 0.3
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    // ===== Bar Chart =====
    const ctxBar = document.getElementById('salesBarChart').getContext('2d');
    if (salesBarChartInstance) salesBarChartInstance.destroy();
    salesBarChartInstance = new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: `Sales (${period})`,
          data: sales,
          backgroundColor: '#FF6384'
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

  } catch (err) {
    console.error('Error rendering sales trends charts:', err);
  }
}

// Refresh when dropdown changes
document.getElementById('salesPeriod').addEventListener('change', renderSalesTrendsCharts);

// Auto-refresh every 10 seconds
setInterval(renderSalesTrendsCharts, 10000);

// Initial load
document.addEventListener('DOMContentLoaded', renderSalesTrendsCharts);



  const API_URL = "http://localhost:8000/api/custom-shirts"; // Laravel API

    async function fetchRequests() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        const tbody = document.getElementById("requestsBody");
        tbody.innerHTML = "";

        const filterValue = document.getElementById("statusFilter").value;

        const filteredData = filterValue === "All"
          ? data
          : data.filter(req => req.status === filterValue);

        if (filteredData.length === 0) {
          tbody.innerHTML = `<tr><td colspan="11">No ${filterValue} requests found.</td></tr>`;
          return;
        }

        filteredData.forEach(req => {
          const row = document.createElement("tr");
          row.className = req.status.toLowerCase();

          row.innerHTML = `
            <td>${req.id}</td>
            <td>${req.full_name}</td>
            <td>${req.phone}</td>
            <td>${req.email}</td>
            <td>${req.design ? `<a href="http://localhost:8000/storage/${req.design}" target="_blank">View</a>` : 'No Design'}</td>
            <td>${req.size}</td>
            <td>${req.quantity}</td>
            <td>${req.notes || ''}</td>
            <td>${req.status}</td>
            <td><textarea id="note-${req.id}">${req.admin_note || ''}</textarea></td>
            <td>
              ${req.status === "Pending" ? `
                <button onclick="approveRequest(${req.id})">Approve</button>
                <button onclick="rejectRequest(${req.id})">Reject</button>
              ` : 'â€”'}
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error("Error fetching requests:", err);
      }
    }

    async function approveRequest(id) {
      const note = document.getElementById(`note-${id}`).value;
      await fetch(`${API_URL}/${id}/approve`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ admin_note: note })
      });
      fetchRequests();
    }

    async function rejectRequest(id) {
      const note = document.getElementById(`note-${id}`).value;
      await fetch(`${API_URL}/${id}/reject`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ admin_note: note })
      });
      fetchRequests();
    }

    fetchRequests();
    




  const API_BASE = 'http://localhost:8000/api';

const appointmentsTbody = document.querySelector('#appointmentsTbl tbody');
const appointmentsStatusFilter = document.getElementById('appointmentsStatusFilter');

function originOf(url) { 
  try { return new URL(url).origin; } 
  catch { return ''; } 
}

function fileUrl(path) { 
  return `${originOf(API_BASE)}/storage/${path}`; 
}

async function loadAppointments() {
  const query = appointmentsStatusFilter.value ? `?status=${appointmentsStatusFilter.value}` : '';
  const res = await fetch(`${API_BASE}/appointments${query}`);
  const json = await res.json();
  const items = json.data || json;
  appointmentsTbody.innerHTML = '';

  items.forEach(a => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${a.id}</td>
      <td>${a.full_name}</td>
      <td>${a.phone}</td>
      <td>${a.email}</td>
      <td>${a.schedule_date}</td>
      <td><span class="badge ${a.status}">${a.status}</span></td>
      <td>${a.qr_code_path ? `<a href="${fileUrl(a.qr_code_path)}" target="_blank">QR</a>` : ''}</td>
      <td>${a.pdf_path ? `<a href="${fileUrl(a.pdf_path)}" target="_blank">PDF</a>` : ''}</td>
      <td>
        <button onclick="approveAppointment(${a.id})" ${a.status!=='pending' ? 'disabled' : ''}>Approve</button>
        <button onclick="rejectAppointment(${a.id})" ${a.status!=='pending' ? 'disabled' : ''}>Reject</button>
      </td>
    `;
    appointmentsTbody.appendChild(tr);
  });
}

async function approveAppointment(id) {
  try {
    const response = await fetch(`http://127.0.0.1:8000/api/appointments/${id}/approve`, {
      method: 'PUT',   // âœ… match Laravel route
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      }
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      console.error("Server error:", errorData);
      alert(`Failed: ${errorData.message || 'Something went wrong.'}`);
      return;
    }

    const data = await response.json();
    console.log("âœ… Appointment approved:", data);

    alert(`âœ… ${data.message}\nðŸ“„ PDF: ${data.pdf_url}\nðŸ”— QR: ${data.qr_url}`);

    // reload table after approve
    loadAppointments();

  } catch (err) {
    console.error("Request failed:", err);
    alert("âŒ Could not connect to server. Please try again.");
  }
}

async function rejectAppointment(id) {
  if (!confirm('Reject this appointment?')) return;
  const res = await fetch(`${API_BASE}/appointments/${id}/reject`, { method: 'PUT' });
  let msg = 'Rejected.';
  if (!res.ok) {
    const j = await res.json().catch(()=>({message:'Failed'}));
    msg = 'Error: ' + (j.message || res.status);
  }
  alert(msg);
  loadAppointments();
}

// Orders
async function fetchOrders() {
  const ordersTableBody = document.querySelector('#ordersTable tbody');
  ordersTableBody.innerHTML = '<tr><td colspan="8">Loading orders...</td></tr>';

  try {
    const token = localStorage.getItem('adminToken'); 
    const response = await fetch('http://127.0.0.1:8000/api/admin/orders', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    const data = await response.json();
    console.log("Fetched orders:", data);

    if (data.length === 0) {
      ordersTableBody.innerHTML = '<tr><td colspan="8">No orders found.</td></tr>';
      return;
    }

    ordersTableBody.innerHTML = '';
    data.forEach(order => {
      // Status colors
      let statusColor;
      switch (order.status) {
        case 'Approved': statusColor = 'green'; break;
        case 'Rejected': statusColor = 'red'; break;
        default: statusColor = 'orange'; // Pending
      }

      // Format created_at
      const createdAt = new Date(order.created_at).toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      // Format items
      const items = order.items.map(i => `${i.product.name} x${i.quantity}`).join('<br>');

      // Actions
      let actions = '';
      const normalizedStatus = (order.status || '').toLowerCase();

      if (normalizedStatus === 'pending') {
        actions += `
          <button onclick="updateOrderStatus(${order.id}, 'Approved')" 
            class="order-action-btn approve">
            <i class="fas fa-check"></i> Approve
          </button>
          <button onclick="updateOrderStatus(${order.id}, 'Rejected')" 
            class="order-action-btn reject">
            <i class="fas fa-times"></i> Reject
          </button>
        `;
      } else if (normalizedStatus === 'approved' || normalizedStatus === 'rejected') {
        const statusClass = normalizedStatus === 'approved' ? 'approved' : 'rejected';
        actions += `
          <select onchange="handleEditStatus(${order.id}, this.value)" 
            class="order-status-dropdown ${statusClass}">
            <option value="">âœ Edit Status</option>
            <option value="Approved" ${order.status === 'Approved' ? 'selected' : ''}>
              âœ” Approved
            </option>
            <option value="Rejected" ${order.status === 'Rejected' ? 'selected' : ''}>
              âœ– Rejected
            </option>
          </select>
        `;
      }

      // Delete button
      actions += `
        <button onclick="deleteOrder(${order.id})" 
          class="order-action-btn delete">
          <i class="fas fa-trash"></i> Delete
        </button>
      `;

      // Row with copy button
      const row = `
        <tr>
            <td style="padding: 6px 10px; white-space: nowrap;">
              <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <span>${order.order_id}</span>
                <button 
                  onclick="copyOrderId('${order.order_id}', this)"
                  style="display: flex; align-items: center; gap: 6px; background: none; border: none; cursor: pointer; padding: 0; padding-right: 8px;"
                  title="Copy Order ID"
                  onmouseover="this.querySelector('i').style.color='#000'"
                  onmouseout="this.querySelector('i').style.color='#666'"
                >
                  <i class="fas fa-clipboard" style="color: #666; font-size: 15px; transition: color 0.2s;"></i>
                  <span style="font-size: 12px; color: black; opacity: 0.7; line-height: 1;">Copy ID</span>
                </button>
              </div>
            </td>
          <td>${order.delivery_name ?? order.user?.name ?? 'Unknown'}</td>
          <td>${order.delivery_phone ?? 'N/A'}</td>
          <td>${order.total}</td>
          <td>${items}</td>
          <td><span style="color: ${statusColor}; font-weight: bold;">${order.status}</span></td>
          <td>${createdAt}</td>
          <td>${actions}</td>
        </tr>
      `;
      ordersTableBody.insertAdjacentHTML('beforeend', row);
    });
  } catch (error) {
    console.error("Error fetching orders:", error);
    ordersTableBody.innerHTML = '<tr><td colspan="8">Error loading orders.</td></tr>';
  }
}

// Copy Order ID to clipboard
function copyOrderId(orderId, btn) {
  navigator.clipboard.writeText(orderId)
    .then(() => {
      showToast(`Order ID ${orderId} copied`, "success");
      
      const icon = btn.querySelector('i');
      const originalClass = icon.className;
      icon.className = 'fas fa-check';
      icon.style.color = '#4CAF50';

      setTimeout(() => {
        icon.className = originalClass;
        icon.style.color = '#888';
      }, 1000);
    })
    .catch(err => {
      console.error("Failed to copy Order ID:", err);
      showToast("Failed to copy Order ID", "error");
    });
}

// Toast function
function showToast(message, type = "success") {
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.innerText = message;

  document.body.appendChild(toast);

  setTimeout(() => toast.classList.add("show"), 100);

  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Update order status
async function updateOrderStatus(orderId, status) {
  try {
    const token = localStorage.getItem('adminToken'); 
    const response = await fetch(`http://127.0.0.1:8000/api/admin/orders/${orderId}/status`, {
      method: 'PUT',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}` 
      },
      body: JSON.stringify({ status })
    });

    if (response.ok) {
      const data = await response.json();
      const order = data.order;

      showToast(`Order ${order.order_id} marked as ${status}`, "success");

      const message = `Hello ${order.delivery_name ?? order.user?.name ?? 'Customer'}, your order ${order.order_id} has been ${status}.`;
      if (order.delivery_phone) {
        try {
          window.electronAPI.sendSMS(order.delivery_phone, message);
          console.log(`SMS sent to ${order.delivery_phone}`);
        } catch (smsError) {
          console.error('Failed to send SMS:', smsError);
        }
      } else {
        console.warn('No phone number found for this order.');
      }

      fetchOrders();
    } else {
      console.error("Failed to update order status");
      showToast("Error updating order status", "error");
    }
  } catch (error) {
    if (error.response) {
      console.error("API response error:", error.response);
    } else if (error.request) {
      console.error("No response from API:", error.request);
    } else {
      console.error("Error in request setup:", error.message);
    }
    showToast("Something went wrong while updating status.", "error");
  }
}

// Handle edit dropdown
function handleEditStatus(orderId, newStatus) {
  if (!newStatus) return;
  updateOrderStatus(orderId, newStatus);
}

// Delete order
async function deleteOrder(orderId) {
  // Grab the order_id from the table row for nicer message
  const row = document.querySelector(`#ordersTable tbody tr button[onclick="deleteOrder(${orderId})"]`)?.closest('tr');
  const orderCode = row?.querySelector('td span')?.textContent || orderId;

  if (!confirm(`Are you sure you want to delete Order ${orderCode}?`)) return;

  try {
    const token = localStorage.getItem('adminToken'); 
    const response = await fetch(`http://127.0.0.1:8000/api/admin/orders/${orderId}`, {
      method: 'DELETE',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}` 
      },
    });

    if (response.ok) {
      showToast(`Order ${orderCode} has been deleted`, "success");
      fetchOrders();
    } else {
      console.error("Failed to delete order");
      showToast("Error deleting order", "error");
    }
  } catch (error) {
    console.error("Error deleting order:", error);
    showToast("Something went wrong while deleting the order", "error");
  }
}

// Auto-load
document.addEventListener('DOMContentLoaded', () => {
  fetchOrders();
});




document.getElementById('appointmentsReloadBtn').addEventListener('click', loadAppointments);
appointmentsStatusFilter.addEventListener('change', loadAppointments);

loadAppointments();


// Enable Enter key to submit forms properly
document.addEventListener('keydown', function(event) {
    if (event.key === "Enter") {
      const active = document.activeElement;

      // Product form
      if (active.closest("#productForm")) {
        event.preventDefault();
        document.getElementById("productForm").dispatchEvent(new Event("submit"));
      }

      // Edit form
      if (active.closest("#editForm")) {
        event.preventDefault();
        document.getElementById("editForm").dispatchEvent(new Event("submit"));
      }

      // Transactions form
      if (active.closest("#transactions")) {
        event.preventDefault();
        submitTransaction();
      }

      // Chat
      if (active.closest("#chat")) {
        event.preventDefault();
        sendMessage();
      }
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
  const loginForm = document.getElementById("loginForm");
  if (loginForm) {
    loginForm.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("loginBtn").click();
      }
    });
  }
});


// TRACKING SYSTEM
async function initializeTracking() {
    // --- DATA & CONFIGURATION ---
    const STAGES = ['Approved', 'Preparing', 'Shipment', 'Shipped Out', 'On Delivery', 'Delivered'];
    const STAGE_ICONS = {
        'Approved': 'check-circle-2', 'Preparing': 'package-search', 'Shipment': 'truck',
        'Shipped Out': 'send', 'On Delivery': 'map-pin', 'Delivered': 'home'
    };
    let orders = [];

    // --- DOM ELEMENTS ---
    const trackingSection = document.getElementById('tracking-section');
    const toastElement = document.getElementById('toast-notification');
    const toastMessage = document.getElementById('toast-message');

    // --- FUNCTIONS ---

    // ADDED: Helper function to format the timestamp string.
    const formatOrderTimestamp = (isoString) => {
        if (!isoString) return 'Not available';
        const date = new Date(isoString);
        const options = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        };
        return date.toLocaleString('en-US', options);
    };

    const showTrackingToast = (message) => {
        toastMessage.textContent = message;
        toastElement.classList.add('toast-active');
        setTimeout(() => {
            toastElement.classList.remove('toast-active');
        }, 3000);
    };

    const updateTrackerUI = (orderCard, currentStage) => {
        const currentStageIndex = STAGES.indexOf(currentStage);
        const steps = orderCard.querySelectorAll('.progress-step');
        steps.forEach((step, index) => {
            step.classList.remove('current', 'completed', 'tracking-pending');
            
            if (index < currentStageIndex) {
                step.classList.add('completed');
            } else if (index === currentStageIndex) {
                step.classList.add('current');
            } else {
                step.classList.add('tracking-pending');
            }
        });
        
        const dropdown = orderCard.querySelector('.stage-select');
        const nextButton = orderCard.querySelector('.next-stage-btn');
        const isDelivered = currentStage === 'Delivered';
        const isAtFinalAdminStage = currentStage === 'On Delivery';

        if (dropdown) {
            dropdown.value = currentStage;
            dropdown.disabled = isDelivered;
        }
        if (nextButton) {
            nextButton.disabled = isAtFinalAdminStage || isDelivered;
        }
    };

    const renderOrders = () => {
        trackingSection.innerHTML = '';
        if (orders.length === 0) {
            trackingSection.innerHTML = `<p style="text-align: center; color: #6b7280;">No approved orders to track at the moment.</p>`;
            return;
        }
        orders.forEach(order => {
            const orderCard = document.createElement('div');
            orderCard.className = 'tracking-order-card';
            orderCard.dataset.orderDbId = order.id;
            orderCard.dataset.orderPublicId = order.orderId;
            // MODIFIED: Updated text, class, and used the new formatting function.
            orderCard.innerHTML = `
                <div class="tracking-header">
                    <div>
                        <h2 class="tracking-order-id">${order.orderId}</h2>
                        <p class="tracking-customer-name">Customer: ${order.customerName}</p>
                        <p class="tracking-timestamp">Created order time: ${formatOrderTimestamp(order.createdAt)}</p>
                    </div>
                    <div class="tracking-actions">
                        <select class="stage-select">
                            ${STAGES.map(stage => `<option value="${stage}" ${order.currentStage === stage ? 'selected' : ''}>${stage}</option>`).join('')}
                        </select>
                        <button class="next-stage-btn">Next Stage</button>
                    </div>
                </div>
                <div class="progress-tracker-container">
                    ${STAGES.map(stage => `
                        <div class="progress-step" data-stage="${stage}">
                            <div class="status-icon">
                                <i data-lucide="${STAGE_ICONS[stage]}" style="width:20px; height:20px;"></i>
                            </div>
                            <p class="status-text">${stage}</p>
                        </div>`).join('')}
                </div>`;
            trackingSection.appendChild(orderCard);
            updateTrackerUI(orderCard, order.currentStage);
        });
        lucide.createIcons();
    };

    const updateOrderStatusAPI = async (orderDbId, newStage) => {
        console.log(`ðŸš€ API Request: Updating order ${orderDbId} to "${newStage}"...`);
        try {
            const res = await fetch(`http://127.0.0.1:8000/api/tracking/orders/${orderDbId}/tracking-stage`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ tracking_stage: newStage })
            });
            if (!res.ok) throw new Error('API update failed');
            console.log('âœ… API Update Successful');
            return true;
        } catch (error) {
            console.error('âŒ API Update Failed:', error);
            return false;
        }
    };
    
    // --- EVENT LISTENERS ---
    trackingSection.addEventListener('click', async (event) => {
        if (event.target.classList.contains('next-stage-btn')) {
            const button = event.target;
            const orderCard = button.closest('.tracking-order-card');
            const orderDbId = orderCard.dataset.orderDbId;
            const order = orders.find(o => o.id == orderDbId);
            const currentStageIndex = STAGES.indexOf(order.currentStage);
            
            if (currentStageIndex < STAGES.indexOf('On Delivery')) {
                const newStage = STAGES[currentStageIndex + 1];
                button.disabled = true;
                const success = await updateOrderStatusAPI(order.id, newStage);
                if (success) {
                    order.currentStage = newStage;
                    updateTrackerUI(orderCard, newStage);
                    showTrackingToast(`Order ${order.orderId} moved to ${newStage}.`);
                } else {
                    showTrackingToast(`Failed to update ${order.orderId}.`);
                    button.disabled = false;
                }
            }
        }
    });

    trackingSection.addEventListener('change', async (event) => {
        if (event.target.classList.contains('stage-select')) {
            const dropdown = event.target;
            const newStage = dropdown.value;
            const orderCard = dropdown.closest('.tracking-order-card');
            const orderDbId = orderCard.dataset.orderDbId;
            const order = orders.find(o => o.id == orderDbId);

            if (newStage === 'Delivered') {
                showTrackingToast("'Delivered' status can only be set by the customer.");
                dropdown.value = order.currentStage;
                return;
            }

            if (order.currentStage !== newStage) {
                dropdown.disabled = true;
                const success = await updateOrderStatusAPI(order.id, newStage);
                if (success) {
                    order.currentStage = newStage;
                    updateTrackerUI(orderCard, newStage);
                    showTrackingToast(`Order ${order.orderId} updated to ${newStage}.`);
                } else {
                    showTrackingToast(`Failed to update ${order.orderId}.`);
                    dropdown.value = order.currentStage;
                }
                dropdown.disabled = newStage === 'Delivered';
            }
        }
    });

    // --- INITIALIZATION ---
    try {
        const response = await fetch('http://127.0.0.1:8000/api/admin/orders', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if(!response.ok) throw new Error('Failed to fetch orders for tracking.');
        const allOrders = await response.json();
        
        orders = allOrders
            .filter(o => o.status === 'Approved')
            .map(order => ({
                id: order.id,
                orderId: order.order_id,
                customerName: order.delivery_name ?? order.user?.name ?? 'Unknown',
                currentStage: order.tracking_stage || 'Approved',
                createdAt: order.created_at
            }));
        renderOrders();
    } catch (error) {
        console.error("Error initializing tracking section:", error);
        trackingSection.innerHTML = `<p style="text-align: center; color: red;">Could not load tracking data.</p>`;
    }
}
  </script>
</body>
</html>
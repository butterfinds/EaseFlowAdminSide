<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EASEPrint Admin Dashboard</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Other libraries -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- PDF Generation Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- Excel Generation Library -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- Your Custom Stylesheet (Last) -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /* --- FONT FIXES START --- */
    
    /* 1. Restore the original font for the entire app */
    body {
        font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* 2. APPLY THE NEW 'INTER' FONT TO ALL UPDATED UI SECTIONS */
    #home, #transactions, #appointments, #orders, #products {
        font-family: 'Inter', sans-serif;
    }

    /* 3. EXPLICITLY RE-STYLE HEADINGS THAT WERE RESET BY TAILWIND */
    .sidebar h2 {
        color: #FBB3C8;
        text-align: center;
        margin: 0 0 30px 0;
        padding: 0 20px;
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    /* UPDATE: EXCLUDE NEW UI SECTIONS FROM OLD HEADING STYLES */
    .main > div:not(#home):not(#transactions):not(#appointments):not(#orders):not(#products) h1,
    .main > div:not(#home):not(#transactions):not(#appointments):not(#orders):not(#products) h2,
    .main > div:not(#home):not(#transactions):not(#appointments):not(#orders):not(#products) h3 {
        font-weight: 700; 
        color: #3F1A2B;  
    }
    /* UPDATE: EXCLUDE NEW UI SECTIONS FROM OLD HEADING STYLES */
    .main > div:not(#home):not(#transactions):not(#appointments):not(#orders):not(#products) h1 {
        font-size: 2rem;
        border-bottom: 2px solid #FBB3C8;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .main > div:not(#home):not(#transactions):not(#appointments):not(#orders):not(#products) h2 {
        font-size: 1.5rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    /* --- FONT FIXES END --- */

    /* UPDATE: ADDED #products TO THIS RULE TO FIX TABLE SPACING */
    #orders table th, #orders table td,
    #products table th, #products table td {
        border: 1vh;
        padding: 1.5vh;               
    }

    #appointments table th, #appointments table td{
        border: 1px solid #ebced7; 
        padding: 16px;        
    }


    .hidden { display: none; }
    #editModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #editModal form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 100%;
    }

    .main > div:not(#home):not(#transactions):not(#appointments):not(#orders):not(#products) {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    img { max-width: 100%; }
    /* UI UPDATE: OLD TABLE STYLES KEPT FOR SECTIONS THAT STILL USE THEM */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 10px; text-align: left; }
    button { padding: 5px 10px; margin: 2px; cursor: pointer; }
    textarea { width: 100%; height: 40px; }
    .approved { background-color: #d4f8d4; }
    .rejected { background-color: #ffdada; }
    .pending { background-color: #fff5d1; }
    .filter-box { margin-bottom: 15px; }
    select { padding: 5px; }
    
    /* Toast */
    #toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #1f2937;
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        font-size: 0.875rem;
        transition: opacity 0.3s, transform 0.3s;
        opacity: 0;
        z-index: 100;
    }
    @keyframes fadeInOut {
        0%, 100% { opacity: 0; transform: translateY(20px); }
        10%, 90% { opacity: 1; transform: translateY(0); }
    }
    .toast-active {
        animation: fadeInOut 3s forwards;
    }
    
    /* UI UPDATE: Added custom scrollbar style from the new design */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    ::-webkit-scrollbar-track {
        background: #f1f5f9;
    }
    ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* UI UPDATE: ADDED CUSTOM STYLES FOR FILE INPUT FROM DRAFT */
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        cursor: pointer;
    }
    .file-input-wrapper input[type=file] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
    }
    .file-input-button {
        display: flex;
        align-items: center;
        gap: 8px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Datalabels Plugin for displaying labels on the chart -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>
<body>
<div class="sidebar fixed top-0 left-0 h-screen w-60 bg-[#3F1A2B] text-white flex flex-col transition-all duration-300 z-50 shadow-lg">
    <div class="flex items-center justify-center h-20 border-b border-gray-700">
        <h2 class="text-2xl font-bold">EasePrint</h2>
    </div>

    <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
        <a onclick="showSection('home')" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:bg-[#5a2e41] hover:text-white transition-colors cursor-pointer sidebar-link" data-section="home">
            <i class="fas fa-home w-5 h-5 mr-3"></i> Dashboard
        </a>
        <a onclick="showSection('pos')" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:bg-[#5a2e41] hover:text-white transition-colors cursor-pointer sidebar-link" data-section="pos">
            <i class="fas fa-cash-register w-5 h-5 mr-3"></i> Point of Sale
        </a>
        <a onclick="showSection('products')" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:bg-[#5a2e41] hover:text-white transition-colors cursor-pointer sidebar-link" data-section="products">
            <i class="fas fa-box-open w-5 h-5 mr-3"></i> Products
        </a>
        <a onclick="showSection('orders')" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:bg-[#5a2e41] hover:text-white transition-colors cursor-pointer sidebar-link" data-section="orders">
            <i class="fas fa-shopping-cart w-5 h-5 mr-3"></i> Orders
        </a>
        <a onclick="showSection('appointments')" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:bg-[#5a2e41] hover:text-white transition-colors cursor-pointer sidebar-link" data-section="appointments">
            <i class="fas fa-calendar-alt w-5 h-5 mr-3"></i> Appointments
        </a>
        <a onclick="showSection('tracking')" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:bg-[#5a2e41] hover:text-white transition-colors cursor-pointer sidebar-link" data-section="tracking">
            <i class="fas fa-truck w-5 h-5 mr-3"></i> Tracking
        </a>
        <a onclick="showSection('transactions')" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:bg-[#5a2e41] hover:text-white transition-colors cursor-pointer sidebar-link" data-section="transactions">
            <i class="fas fa-receipt w-5 h-5 mr-3"></i> Transactions
        </a>
        <a onclick="showSection('analytics')" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:bg-[#5a2e41] hover:text-white transition-colors cursor-pointer sidebar-link" data-section="analytics">
            <i class="fas fa-chart-line w-5 h-5 mr-3"></i> Analytics
        </a>
        <a onclick="showSection('chat')" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:bg-[#5a2e41] hover:text-white transition-colors cursor-pointer sidebar-link" data-section="chat">
            <i class="fas fa-comments w-5 h-5 mr-3"></i> Chat
        </a>
    </nav>

    <div class="p-4 border-t border-gray-700">
        <a onclick="logout()" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-red-400 hover:bg-[#5a2e41] hover:text-red-300 transition-colors cursor-pointer">
            <i class="fas fa-sign-out-alt w-5 h-5 mr-3"></i> Logout
        </a>
    </div>
</div>

<div class="main">
    <!-- ================================================================== -->
    <!-- ====================  DASHBOARD SECTION  ==================== -->
    <!-- ================================================================== -->
    <div id="home">
     <div class="p-4 sm:p-6 lg:p-8">
        <!-- Dashboard Header -->
        <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Dashboard</h1>
            </div>
             <div class="flex items-center space-x-4">
                <div id="live-clock" class="text-lg font-semibold text-slate-600"></div>
                <div class="flex items-center space-x-3 mt-4 sm:mt-0">
                    <button onclick="showSection('transactions')" class="font-semibold text-sm bg-[#EF534F] text-white py-2 px-4 rounded-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#EF534F] transition">
                        + Add Sale
                    </button>

                    <button id="exportReportBtn" class="font-semibold text-sm bg-slate-600 text-white py-2 px-4 rounded-lg hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-600 transition">
                        <i class="fas fa-file-export mr-2"></i> Export Report
                    </button>
                </div>
            </div>
        </header>

        <!-- Stat Cards Widget Row -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- Stat Card 1: Total Revenue -->
            <div class="widget glass-effect text-white">
                <p class="font-medium">Total Revenue</p>
                <p id="total-revenue" class="text-4xl font-bold mt-2">₱0.00</p>
                <div class="flex items-center text-sm mt-2 text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" /></svg>
                    <span>Calculating...</span>
                </div>
            </div>
            <!-- Stat Card 2: Total Sales -->
            <div class="widget">
                <p class="font-medium text-slate-500">Total Sales</p>
                <p id="total-sales" class="text-4xl font-bold text-slate-800 mt-2">0</p>
                 <div class="flex items-center text-sm mt-2 text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" /></svg>
                    <span>Calculating...</span>
                </div>
            </div>
            <!-- Stat Card 3: Pending Orders -->
            <div class="widget">
                <p class="font-medium text-slate-500">Pending Orders</p>
                <p id="pending-orders" class="text-4xl font-bold text-slate-800 mt-2">0</p>
                 <div class="flex items-center text-sm mt-2 text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" /></svg>
                    <span>Awaiting processing</span>
                </div>
            </div>
            <!-- Stat Card 4: Mini Calendar -->
            <div class="widget">
                 <div id="calendar-widget">
                    <div class="flex items-center justify-between mb-2">
                        <h2 id="calendar-month-year" class="text-sm font-semibold text-slate-800"></h2>
                        <div class="flex space-x-1">
                            <button id="prev-month" class="p-1 rounded-full hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-[#EF534F]">
                                <svg class="w-4 h-4 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                            </button>
                            <button id="next-month" class="p-1 rounded-full hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-[#EF534F]">
                                <svg class="w-4 h-4 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </button>
                        </div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-y-1 text-center text-xs"></div>
                </div>
            </div>
        </div>

<main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

    <div class="widget lg:col-span-2">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">Recent Activity</h2>
        <ul id="activity-feed" class="divide-y divide-slate-100">
            <li class="flex items-center justify-center text-slate-500 py-10">Loading activities...</li>
        </ul>
    </div>

    <div class="widget lg:col-span-2">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">Top Products Overview</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
            <div class="relative h-48 w-48 mx-auto">
                <canvas id="salesDonutChart"></canvas>
                <div class="absolute inset-0 flex items-center justify-center text-center pointer-events-none">
                    <div>
                        <span id="total-sales-value" class="text-3xl font-bold text-slate-800"></span>
                        <span class="text-sm text-slate-500 block">Total Items Sold</span>
                    </div>
                </div>
            </div>
            <div id="sales-legend" class="space-y-2">
                </div>
        </div>
    </div>

    <div class="widget lg:col-span-2">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">Top Products Volume</h2>
        <div class="h-64">
            <canvas id="salesBarChart"></canvas>
        </div>
    </div>

    <div class="widget lg:col-span-2">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">Top Products Sales Value</h2>
        <div class="h-64">
            <canvas id="salesValueBarChart"></canvas>
        </div>
    </div>

</main>
    </div>
</div>

<!-- ================================================================== -->
<!-- ==================== EXPORT REPORT MODAL ===================== -->
<!-- ================================================================== -->
<!-- ================================================================== -->
<!-- ==================== EXPORT REPORT MODAL ===================== -->
<!-- ================================================================== -->
<!-- [REPLACED] This entire modal div is replaced with the new, cleaner UI -->
<div id="exportReportModal" class="hidden fixed top-0 left-0 w-full h-full bg-black/50 flex justify-center items-center z-[1001]">
    
    <!-- Modal Card (New UI) -->
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full">
        
        <h1 class="text-2xl font-bold text-gray-900 mb-6">
            Export Sales Report
        </h1>

        <!-- [UPDATED] Kept your id="exportReportForm" and used space-y-6 from the draft -->
        <form id="exportReportForm" class="space-y-6">

            <!-- Report Type -->
            <div>
                <label for="exportReportType" class="block text-sm font-medium text-gray-700 mb-1">
                    Report Type
                </label>
                <div class="relative">
                    <!-- [UPDATED] Kept your id="exportReportType" and <option> values -->
                    <select id="exportReportType" name="report-type" class="w-full appearance-none rounded-lg border border-gray-300 bg-white px-4 py-3 pr-10 text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="summary">Sales Summary (Totals)</option>
                        <option value="detailed">Detailed Transactions</option>
                        <option value="category">Sales by Category</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-400">
                        <i data-lucide="chevron-down" class="h-5 w-5"></i>
                    </div>
                </div>
            </div>

            <!-- Date Range -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Start Date -->
                <div>
                    <label for="exportStartDate" class="block text-sm font-medium text-gray-700 mb-1">
                        Start Date
                    </label>
                      <div class="relative">
                            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-start pt-3 pl-3 text-gray-400">  <i data-lucide="calendar-days" class="h-5 w-5"></i>
                            </div>
                            <input type="text" id="exportStartDate" name="start-date" class="w-full rounded-lg border border-gray-300 bg-white p-3 pl-10 text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="YYYY-MM-DD" required>
                      </div>
                </div>
                <!-- End Date -->
                <div>
                    <label for="exportEndDate" class="block text-sm font-medium text-gray-700 mb-1">
                        End Date
                    </label>
                     <div class="relative">
                            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-start pt-3 pl-3 text-gray-400">  <i data-lucide="calendar-days" class="h-5 w-5"></i>
                            </div>
                            <input type="text" id="exportEndDate" name="end-date" class="w-full rounded-lg border border-gray-300 bg-white p-3 pl-10 text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="YYYY-MM-DD" required>
                      </div>
                </div>
            </div>

            <!-- Date Presets -->
            <!-- [UPDATED] Kept your onclick="setExportDateRange(...)" functions on the new buttons -->
            <div class="flex flex-wrap gap-2">
                <button type="button" onclick="setExportDateRange('week')" class="rounded-full bg-gray-100 px-4 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                    This Week
                </button>
                <button type="button" onclick="setExportDateRange('lastWeek')" class="rounded-full bg-gray-100 px-4 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                    Last Week
                </button>
                <button type="button" onclick="setExportDateRange('month')" class="rounded-full bg-gray-100 px-4 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                    This Month
                </button>
                <button type="button" onclick="setExportDateRange('lastMonth')" class="rounded-full bg-gray-100 px-4 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                    Last Month
                </button>
                <button type="button" onclick="setExportDateRange('year')" class="rounded-full bg-gray-100 px-4 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                    This Year
                </button>
            </div>

            <!-- Note -->
            <div class="flex items-start gap-3 rounded-lg bg-gray-50 p-4">
                <div class="flex-shrink-0 text-gray-400">
                    <i data-lucide="info" class="h-5 w-5"></i>
                </div>
                <p class="text-sm text-gray-600">
                    Note: The report will be generated as an Excel (.xlsx) file.
                </p>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col-reverse sm:flex-row sm:justify-end sm:gap-3 pt-4">
                <!-- [UPDATED] Kept your onclick="closeExportModal()" -->
                <button type="button" onclick="closeExportModal()" class="flex w-full items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-5 py-3 text-sm font-semibold text-gray-700 shadow-sm transition hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 sm:mt-0 sm:w-auto">
                    <i data-lucide="x" class="h-4 w-4"></i>
                    Cancel
                </button>
                <!-- [UPDATED] Kept your id="generateReportBtn" -->
                <button type="submit" id="generateReportBtn" class="flex w-full items-center justify-center gap-2 rounded-lg border border-transparent bg-green-600 px-5 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-1 sm:w-auto mb-3 sm:mb-0">
                    <i data-lucide="download" class="h-4 w-4"></i>
                    Generate Report
                </button>
            </div>

        </form>
    </div>
</div>

<!-- Your main script continues below -->
<!-- ================================================================== -->
<!-- ==================== END OF DASHBOARD SECTION ==================== -->
<!-- ================================================================== -->


<!-- ================================================================== -->
<!-- ====================    POS SYSTEM SECTION   == ================== -->
<!-- ================================================================== -->
<div id="pos" class="hidden">
    <div class="p-4 sm:p-6 lg:p-8 h-screen flex flex-col font-sans">
        <!-- POS Header -->
        <header class="mb-4">
            <h1 class="text-3xl font-bold text-gray-900">Point of Sale</h1>
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 mt-4">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button onclick="switchPosTab('register')" id="tab-register" class="pos-tab active">Register</button>
                    <button onclick="switchPosTab('sales')" id="tab-sales" class="pos-tab">Sales History</button>
                    <button onclick="switchPosTab('inventory')" id="tab-inventory" class="pos-tab">Inventory</button>
                </nav>
            </div>
        </header>

        <!-- Tab Content: Register -->
        <div id="content-register" class="pos-tab-content active flex-grow overflow-hidden">
            <div class="grid grid-cols-3 gap-6 h-full">
                <!-- Left Side: Product Grid -->
                <div class="col-span-2 bg-white rounded-xl shadow-md flex flex-col overflow-hidden">
                    <div class="p-4 border-b">
                        <input type="text" id="pos-product-search" placeholder="Search products..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69]">
                    </div>
                    <div id="pos-product-grid" class="p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto">
                        <p class="col-span-full text-center text-gray-500">Loading products...</p>
                    </div>
                </div>
                <!-- Right Side: Cart and Actions -->
                <div class="col-span-1 bg-white rounded-xl shadow-md flex flex-col">
                    <div class="p-6 border-b"><h3 class="text-xl font-semibold text-gray-900">Current Sale</h3></div>
                    <div id="pos-cart-items" class="flex-grow p-4 space-y-3 overflow-y-auto">
                        <p class="text-center text-gray-400 pt-4">Select a product to begin.</p>
                    </div>
                    <div class="p-6 border-t bg-gray-50">
                        <div class="space-y-2 mb-6">
                            <div class="flex justify-between text-gray-600"><span>Subtotal</span><span id="pos-subtotal">₱0.00</span></div>
                            <div class="flex justify-between text-xl font-bold text-gray-900"><span>Total</span><span id="pos-total">₱0.00</span></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="pos-clear-sale" class="w-full bg-red-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-700 transition">Clear Sale</button>
                            <button id="pos-record-sale" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition">Record Sale</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Sales History -->
        <div id="content-sales" class="pos-tab-content flex-grow overflow-hidden bg-white rounded-xl shadow-md">
            <div class="p-6 border-b"><h3 class="text-xl font-semibold text-gray-900">POS Sales History</h3></div>
            <div class="overflow-y-auto h-full">
                <table class="min-w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Items</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th>
                        </tr>
                    </thead>
                    <tbody id="sales-history-body" class="divide-y divide-gray-200">
                        <tr><td colspan="4" class="text-center py-10 text-gray-500">Loading sales history...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab Content: Inventory -->
        <div id="content-inventory" class="pos-tab-content flex-grow overflow-hidden bg-white rounded-xl shadow-md">
            <div class="p-6 border-b"><h3 class="text-xl font-semibold text-gray-900">Product Inventory</h3></div>
            <div class="overflow-y-auto h-full">
                <table class="min-w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stock Count</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body" class="divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center py-10 text-gray-500">Loading inventory...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- ================================================================== -->
<!-- ================== END OF POS SYSTEM SECTION  ==================== -->
<!-- ================================================================== -->


<!-- ================================================================== -->
<!-- =================== PRODUCTS SECTION  ==================== -->
<!-- ================================================================== -->
<div id="products" class="hidden">
    <div class="p-4 sm:p-6 lg:p-8" style="padding: 0; max-width: 100%;">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Product Upload</h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md overflow-y-auto max-h-[calc(100vh-10rem)]"> 
                <h3 class="text-xl font-semibold text-gray-900 border-b pb-4 mb-6">Add New Product</h3>
                <form id="productForm" class="space-y-5">
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <input type="text" id="productName" placeholder="e.g., Custom Jersey" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="productPrice" class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                            <input type="number" id="productPrice" placeholder="0.00" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition" required>
                        </div>
                        <div>
                            <label for="productStock" class="block text-sm font-medium text-gray-700 mb-1">Stock</label>
                            <input type="number" id="productStock" placeholder="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition" required>
                        </div>
                    </div>
                    <div>
                        <label for="productDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="productDescription" rows="4" placeholder="Enter product details..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition"></textarea>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Product Image</label>
                        <div class="file-input-wrapper w-full px-4 py-3 border border-gray-300 rounded-lg">
                            <input type="file" id="productImage" required>
                            <div class="file-input-button text-gray-500">
                               <i data-feather="upload" class="w-4 h-4"></i>
                                <span id="fileName">Choose file</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="productCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="productCategory" class="w-full px-4 py-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition" required>
                            <option value="">Select Category</option>
                            <option value="1">Jerseys</option>
                            <option value="2">Shirts</option>
                            <option value="3">Shorts</option>
                            <option value="4">Jackets</option>
                            <option value="5">Others</option>
                        </select>
                    </div>
                        <button type="submit" class="w-full bg-[#ED4A69] text-white font-semibold py-3 px-4 rounded-lg hover:bg-[#d4435d] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#ED4A69] transition-transform transform hover:scale-105">
                            <i class="fas fa-plus-circle mr-2"></i> Upload Product
                        </button>
                </form>
            </div>

            <div class="lg:col-span-2 bg-white rounded-xl shadow-md overflow-hidden">
                 <div class="p-6 border-b">
                    <h3 class="text-xl font-semibold text-gray-900">Uploaded Products</h3>
                </div>
                <div class="overflow-x-auto"> <table id="productTable" class="min-w-full"> <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                           </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ================================================================== -->
<!-- ==================== END OF PRODUCTS SECTION  ==================== -->
<!-- ================================================================== -->



<!-- ================================================================== -->
<!-- ====================   ORDERS SECTION      ==================== -->
<!-- ================================================================== -->
<div id="orders" class="hidden">
    <div class="w-full p-4 sm:p-6 lg:p-8" style="padding: 0; max-width: 100%;">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Orders</h1>
        </header>

        <div class="mb-6">
             <button onclick="fetchOrders()" class="flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                 <i data-feather="refresh-cw" class="w-4 h-4"></i>
                 <span>Refresh</span>
             </button>
        </div>

        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table id="ordersTable" class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Proof</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="9" class="text-center py-6">Loading orders...</td></tr>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- ================================================================== -->
<!-- =======================END OF ORDER SECTION======================= -->
<!-- ================================================================== -->



<!-- ================================================================== -->
<!-- ======================= APPOINTMENT SECTION ====================== -->
<!-- ================================================================== -->

<div id="appointments" class="hidden">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8" style="padding: 0; max-width: 100%;">
        <!-- PAGE HEADER UPDATED: PINK LINE REMOVED -->
        <header class="mb-8">
             <h1 class="text-3xl font-bold text-gray-900">Appointments</h1>
        </header>

        <!-- Main Content Grid -->
        <div class="flex flex-col gap-8">

            <!-- Custom Shirt Requests Card -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="p-6">
                    <!-- Card Header with Theme Line -->
                    <div class="border-b-2 border-pink-500 pb-4 mb-4">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Custom Shirt Requests</h2>
                            <div class="flex items-center space-x-2">
                                <label for="statusFilter" class="text-sm font-medium">Show:</label>
                                <!-- ID is kept as "statusFilter" to match your existing JS -->
                                <select id="statusFilter" onchange="fetchRequests()" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                                    <option>All</option>
                                    <option>Pending</option>
                                    <option>Approved</option>
                                    <option>Rejected</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Requests Table -->
                    <div>
                        <!-- Table ID and tbody ID are kept to match your existing JS -->
                        <table id="requestsTable" class="w-full divide-y divide-gray-200" style="border: none;">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Design / Specs</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admin Note</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="requestsBody" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="text-center py-4">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Appointments Schedule Card -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="p-6">
                    <!-- Card Header with Theme Line -->
                    <div class="border-b-2 border-pink-500 pb-4 mb-4">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Appointments Schedule</h2>
                            <div class="flex items-center space-x-2">
                                <label for="appointmentsStatusFilter" class="text-sm font-medium">Filter:</label>
                                <!-- ID is kept as "appointmentsStatusFilter" to match your existing JS -->
                                <select id="appointmentsStatusFilter" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                                    <option value="">All</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <!-- ID is kept as "appointmentsReloadBtn" to match your existing JS -->
                                <button id="appointmentsReloadBtn" class="p-2 rounded-md hover:bg-gray-100 active:bg-gray-200">
                                    <i data-feather="refresh-cw" class="w-4 h-4 text-gray-500"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Table -->
                    <!-- Table ID is kept as "appointmentsTbl" to match your existing JS -->
                    <table id="appointmentsTbl" class="w-full divide-y divide-gray-200" style="border: none;">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assets</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- This will be populated by your loadAppointments() function -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ================================================================== -->
<!-- ================ END OF APPOINTMENT SECTION ====================== -->
<!-- ================================================================== -->



<!-- ================================================================== -->
<!-- ================   TRACKING SECTION      ====================== -->
<!-- ================================================================== -->
<div id="tracking" class="hidden">
    <h1>Order Tracking</h1>
    <div id="tracking-section">
    </div>
</div>
<!-- ================================================================== -->
<!-- ================  END OF TRACKING SECTION   ====================== -->
<!-- ================================================================== -->



<!-- ================================================================== -->
<!-- ================   TRANSACTION SECTION    ====================== -->
<!-- ================================================================== -->
 <div id="transactions" class="hidden">
        <div>
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Sales & Transactions</h1>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-900 border-b pb-3 mb-6">Record a New Sale</h3>
                    
                    <div class="space-y-5">
                        <div>
                            <label for="item" class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                            <input type="text" id="item" placeholder="e.g., Custom Jersey Print" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                        </div>

                        <div>
                        <label for="transactionCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="transactionCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                          <option value="">Select Category</option>
                            <option value="1">Jerseys</option>
                            <option value="2">Shirts</option>
                            <option value="3">Shorts</option>
                            <option value="4">Jackets</option>
                            <option value="5">Others</option>
                        </select>
                        </div>

                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
                                <input type="number" id="price" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                            </div>
                            <div class="flex-1">
                                <label for="qty" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                <input type="number" id="qty" placeholder="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="orderStatus" class="block text-sm font-medium text-gray-700 mb-1">Order Status</label>
                                <select id="orderStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                                    <option value="Pending">Pending</option>
                                    <option value="Successful">Successful</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label for="paymentStatus" class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                                <select id="paymentStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                                    <option value="Pending">Pending</option>
                                    <option value="Done">Done</option>
                                </select>
                            </div>
                        </div>

                        <button onclick="submitTransaction()" class="w-full bg-[#ED4A69] text-white font-semibold py-3 px-4 rounded-lg hover:bg-[#d4435d] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#ED4A69] transition-transform transform hover:scale-105">
                            <i class="fas fa-plus-circle mr-2"></i> Add Transaction
                        </button>
                        <div id="response" class="text-center mt-2"></div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white rounded-xl shadow-md">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-semibold text-gray-900">Sales History</h3>
                    </div>
                    <div class="table-container max-h-[600px] overflow-y-auto">
                        <table class="w-full text-sm text-left text-gray-500" style="border: none;">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0" style="border: none;">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Date</th>
                                    <th scope="col" class="px-6 py-3">Item Name</th>
                                    <th scope="col" class="px-6 py-3 text-center">Category</th> 
                                    <th scope="col" class="px-6 py-3 text-right">Unit Price</th>
                                    <th scope="col" class="px-6 py-3 text-center">Quantity</th>
                                    <th scope="col" class="px-6 py-3 text-center">Order Status</th>
                                    <th scope="col" class="px-6 py-3 text-center">Payment Status</th>
                                    <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="transactionModal" class="hidden">
      <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
        <h3 class="text-xl font-semibold text-gray-900 border-b pb-3 mb-6">Edit Transaction</h3>
        <input id="editTransactionId" type="hidden" />
        <div class="space-y-5">
            <div>
                <label for="editItem" class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                <input type="text" id="editItem" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
            </div>
            <div class="flex space-x-4">
                <div class="flex-1">
                    <label for="editPrice" class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
                    <input type="number" id="editPrice" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                </div>
                <div class="flex-1">
                    <label for="editQty" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                    <input type="number" id="editQty" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                </div>
            </div>
            <div class="flex space-x-4">
                <div class="flex-1">
                    <label for="editOrderStatus" class="block text-sm font-medium text-gray-700 mb-1">Order Status</label>
                    <select id="editOrderStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                        <option value="Pending">Pending</option>
                        <option value="Successful">Successful</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label for="editPaymentStatus" class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                    <select id="editPaymentStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                        <option value="Pending">Pending</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button onclick="closeTransactionModal()" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button onclick="saveEdit()" class="px-6 py-2 bg-[#ED4A69] text-white rounded-lg hover:bg-[#d4435d] transition">Save Changes</button>
            </div>
        </div>
      </div>
    </div>
<!-- ================================================================== -->
<!-- ================ END OF TRANSACTION SECTION ====================== -->
<!-- ================================================================== -->



<!-- ================================================================== -->
<!-- ================   ANALYTICS SECTION       ====================== -->
<!-- ================================================================== -->
<div id="analytics" class="hidden">
    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Sales Analytics</h1>
        </header>

        <!-- Main Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Sales Trend Line Chart -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold">Orders Analytics</h2>
                        <p class="text-sm text-gray-500 mt-1">This chart shows sales totals over time. It helps track the performance of your different sales channels.</p>
                    </div>

                    <select id="salesPeriod" class="border border-gray-200 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="day">Daily</option>
                        <option value="week">Weekly</option>
                        <option value="month" selected>Monthly</option>
                        <option value="year">Yearly</option>
                    </select>
                </div>

                <div class="h-80">
                    <canvas id="salesTrendChart"></canvas>
                </div>
            </div>

            <!-- Earnings Donut Chart -->
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <div>
                    <h2 class="text-xl font-semibold">Earnings Breakdown</h2>
                    <p class="text-sm text-gray-500 mt-1">A breakdown of daily earnings from different sources. This helps identify which channels are most profitable.</p>
                </div>

                <div class="relative mx-auto mt-4" style="max-width: 250px;">
                    <canvas id="earningsChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <p id="earningsTotal" class="text-3xl font-bold">₱0</p>
                            <p class="text-sm text-gray-500">Today</p>
                        </div>
                    </div>
                </div>

                <div id="earningsLegend" class="mt-6 space-y-2 text-sm text-gray-600">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full bg-blue-500 mr-2"></span>
                            <span>Offline</span>
                        </div>
                        <span id="offlineEarnings">₱0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full bg-orange-400 mr-2"></span>
                            <span>Online</span>
                        </div>
                        <span id="onlineEarnings">₱0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row of Charts -->
        <div class="mt-8">
            <!-- Sales by Category Bar Chart -->
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h2 class="text-xl font-semibold">Sales by Category</h2>
                <p class="text-sm text-gray-500 mt-1">This chart displays the sales performance of different product categories, helping you identify top-performing items.</p>
                <div class="h-80 mt-4">
                    <canvas id="salesByCategoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================================================================== -->
<!-- =======================END OF ANALYTICS SECTION ================== -->
<!-- ================================================================== -->


<!-- ================================================================== -->
<!-- ================       CHAT SECTION         ====================== -->
<!-- ================================================================== -->
  <div id="chat" class="hidden">
    <div class="chat-header">
      <h1 id="chatTitle">Customer Support Chat</h1>
    </div>

    <div class="chat-header-row">
      <div id="activeCustomer" class="active-customer">No customer selected</div>

      <div class="custom-select" id="customerSelectWrapper">
        <button id="customerSelectBtn" class="select-btn" aria-haspopup="listbox" aria-expanded="false">
          -- Select a Customer -- <i class="fas fa-caret-down" style="margin-left:8px"></i>
        </button>
        <ul id="customerList" class="select-list hidden" role="listbox" tabindex="-1"></ul>
      </div>
    </div>

    <div id="chatBox"></div>

    <div class="chat-input-row">
      <input id="chatInput" type="text" placeholder="Type a message..." />
      <button id="sendMsgBtn" onclick="sendMessage()">Send</button>
    </div>
  </div>
<!-- ================================================================== -->
<!-- ================  END OF CHAT SECTION       ====================== -->
<!-- ================================================================== -->


  <div id="settings" class="hidden">
    <h1>Account Settings</h1>
    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </div>
  </div>


<div id="editModal">
    <form id="editForm" enctype="multipart/form-data">
      <h3>Edit Product</h3>
      <input type="hidden" id="editProductId" />
            <input type="hidden" id="editSquareId" />
      <input type="text" id="editName" placeholder="Product Name" required />
      <input type="number" id="editprice" placeholder="Price (e.g. 99.99)" step="0.01" min="0" required />
      <input type="number" id="editStock" placeholder="Stock" required />
      <textarea id="editDescription" placeholder="Description" required></textarea>
      <select id="editCategory" required>
        <option value="">Select Category</option>
        <option value="1">Jerseys</option>
        <option value="2">Shirts</option>
        <option value="3">Shorts</option>
        <option value="4">Jackets</option>
        <option value="5">Others</option>
      </select>
      <input type="file" id="editImage" accept="image/*" />
      <button type="submit">Save</button>
      <button type="button" onclick="closeEditModal()">Cancel</button>
    </form>
  </div>

  <div id="toast-notification">
      <p id="toast-message"></p>
  </div>


  <script>
    const token = localStorage.getItem('adminToken');
    if (!token) window.location.href = './index.html';
    // Calendar variable
    let fpStartDateInstance = null;
    let fpEndDateInstance = null;

function showSection(id) {
      document.querySelectorAll('.main > div').forEach(div => div.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if (id === 'home') updateDashboard();
      if (id === 'products') loadProducts();
      if (id === 'orders') fetchOrders();
      if (id === 'transactions') fetchTransactions();
      if (id === 'tracking') initializeTracking();
      if (id === 'pos') initializePOS();
      // ADDED: This line initializes the analytics charts when the section is shown.
      if (id === 'analytics') initializeAnalyticsCharts(); 
      if (id === 'appointments' || id === 'orders' || id === 'products' || id === 'tracking') {
          feather.replace();
      }
}

    function logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminEmail');
      window.location.href = './index.html';
    }

// ==================================================================
    // =================== POINT OF SALE SCRIPT =========================
    // ==================================================================
let posAllProducts = [];
let posCartItems = [];
let isPOSInitialized = false;

function switchPosTab(tabName) {
    document.querySelectorAll('.pos-tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');

    document.querySelectorAll('.pos-tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(`content-${tabName}`).classList.add('active');

    if (tabName === 'sales') {
        loadSalesHistory();
    } else if (tabName === 'inventory') {
        loadInventory();
    }
}

async function loadSalesHistory() {
    const tbody = document.getElementById('sales-history-body');
    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-10 text-gray-500">Loading sales history...</td></tr>';
    
    // **UPDATE:** Removed the "Actions" column from the header
    const theadRow = document.querySelector('#content-sales thead tr');
    theadRow.innerHTML = `
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Items</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th>
    `;
    
    try {
        const response = await fetch('http://127.0.0.1:8000/api/square/sales', { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await response.json();

        if (!response.ok) throw new Error(data.details || 'Failed to load sales history.');
        
        const activeOrders = data.orders ? data.orders.filter(order => order.state !== 'CANCELED') : [];

        if (activeOrders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-10 text-gray-500">No active sales have been recorded yet.</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        activeOrders.forEach(order => {
            const row = tbody.insertRow();
            const items = (order.line_items || []).map(item => `${item.name} x${item.quantity}`).join(', ');
            
            // **UPDATE:** Removed the "Actions" cell and "Cancel" button
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">${new Date(order.created_at).toLocaleString()}</td>
                <td class="px-6 py-4">${items}</td>
                <td class="px-6 py-4 whitespace-nowrap">₱${(order.total_money.amount / 100).toFixed(2)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-xs">${order.id}</td>
            `;
        });
    } catch (error) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-red-500">Error: ${error.message}</td></tr>`;
    }
}

async function loadInventory() {
    const tbody = document.getElementById('inventory-body');
    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-10 text-gray-500">Loading inventory...</td></tr>';

    const theadRow = document.querySelector('#content-inventory thead tr');
    theadRow.innerHTML = `
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product Name</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stock Count</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
    `;

    try {
        const response = await fetch('http://127.0.0.1:8000/api/square/inventory', { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to load inventory data.');

        if (!data.inventory || data.inventory.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-10 text-gray-500">No inventory data found.</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        data.inventory.forEach(item => {
            const row = tbody.insertRow();
            const stock = parseInt(item.quantity, 10); 
            const stockStatus = isNaN(stock) || stock <= 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
            
            row.innerHTML = `
                <td class="px-6 py-4 font-medium">${item.name}</td>
                <td class="px-6 py-4">${isNaN(stock) ? 'N/A' : stock}</td>
                <td class="px-6 py-4">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${stockStatus}">${isNaN(stock) || stock <= 0 ? 'Out of Stock' : 'In Stock'}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${item.local_id ? `<button onclick="deleteProduct(${item.local_id})" class="text-red-600 hover:text-red-800">Delete</button>` : ''}
                </td>
            `;
        });
    } catch (error) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-red-500">Error: ${error.message}</td></tr>`;
    }
}

function initializePOS() {
    if (isPOSInitialized) {
        fetchProductsFromBackend();
        return;
    }

    const posProductGrid = document.getElementById('pos-product-grid');
    const posClearSaleBtn = document.getElementById('pos-clear-sale');
    const posRecordSaleBtn = document.getElementById('pos-record-sale');
    const posSearchInput = document.getElementById('pos-product-search');

    async function fetchProductsFromBackend() {
    posProductGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">Loading products...</p>`;
    try {
        const [squareResponse, localResponse] = await Promise.all([
            fetch('http://127.0.0.1:8000/api/square/products', {
                headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
            }),
            fetch('http://127.0.0.1:8000/api/admin/products', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
        ]);
        
        if (!squareResponse.ok) {
            const errorData = await squareResponse.json();
            throw new Error(errorData.error || 'Failed to fetch products from Square.');
        }
        const squareData = await squareResponse.json();
        const localProducts = localResponse.ok ? await localResponse.json() : [];

        // ✅ NEW: Create maps for stock and category lookup
        const localProductStock = new Map(localProducts.map(p => [p.name, p.stock]));
        const localProductCategory = new Map(localProducts.map(p => [p.name, p.category?.name || 'Uncategorized']));

        if (squareData.error) throw new Error(squareData.error);

        if (!squareData.objects || squareData.objects.length === 0) {
            posProductGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">No products found in Square.</p>`;
            return;
        }

        posAllProducts = squareData.objects.map(item => {
            const variation = item.item_data.variations[0];
            const priceData = variation.item_variation_data.price_money;
            return {
                id: variation.id,
                name: item.item_data.name,
                price: priceData ? Number(priceData.amount) / 100 : 0,
                imageUrl: item.image_url || 'https://placehold.co/150x150/E2E8F0/475569?text=No+Image',
                stock: localProductStock.get(item.item_data.name) || 0,
                // ✅ NEW: Include category
                category: localProductCategory.get(item.item_data.name) || 'Uncategorized'
            };
        });
        renderPOSProducts();
    } catch (error) {
        console.error('Error:', error);
        posProductGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Error: ${error.message}.</p>`;
    }
}

    function renderPOSProducts(filter = '') {
        posProductGrid.innerHTML = '';
        const filtered = posAllProducts.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
        if (filtered.length === 0) {
            posProductGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">No products found.</p>`;
            return;
        }
        filtered.forEach(product => {
            // **MODIFIED**: Add visual indicators and logic for out-of-stock items
            const card = document.createElement('div');
            card.className = 'pos-product-card';
            if (product.stock <= 0) {
                card.classList.add('out-of-stock');
            }
            card.innerHTML = `<img src="${product.imageUrl}" alt="${product.name}"><p class="name">${product.name}</p><p class="price">₱${product.price.toFixed(2)}</p>`;
            card.addEventListener('click', () => {
                if (product.stock > 0) {
                    addToPOSCart(product.id);
                } else {
                    showToast('This product is out of stock.');
                }
            });
            posProductGrid.appendChild(card);
        });
    }

    function addToPOSCart(productId) {
        // **MODIFIED**: Check stock before adding or incrementing quantity
        const product = posAllProducts.find(p => p.id === productId);
        if (!product) return;
        
        const existingItem = posCartItems.find(item => item.id === productId);
        if (existingItem) {
            if (existingItem.quantity >= product.stock) {
                showToast(`Stock limit reached for ${product.name}. Only ${product.stock} items available.`);
                return;
            }
            existingItem.quantity++;
        } else {
            if (product.stock <= 0) {
                showToast(`${product.name} is out of stock.`);
                return;
            }
            posCartItems.push({ ...product, quantity: 1 });
        }
        renderPOSCart();
    }

    function renderPOSCart() {
        const container = document.getElementById('pos-cart-items');
        container.innerHTML = '';
        if (posCartItems.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-400 pt-4">Select a product to begin.</p>`;
            updatePOSTotals(); return;
        }
        posCartItems.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = 'pos-cart-item';
            itemEl.innerHTML = `
                <div class="name">${item.name}</div>
                                <div class="quantity"><input type="number" value="${item.quantity}" min="1" onchange="updatePOSQuantity('${item.id}', this)"></div>
                <div class="price">₱${(item.price * item.quantity).toFixed(2)}</div>
                <div class="remove-btn" onclick="removeFromPOSCart('${item.id}')"><i data-feather="x-circle"></i></div>`;
            container.appendChild(itemEl);
        });
        feather.replace();
        updatePOSTotals();
    }

    function updatePOSTotals() {
        const subtotal = posCartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        document.getElementById('pos-subtotal').textContent = `₱${subtotal.toFixed(2)}`;
        document.getElementById('pos-total').textContent = `₱${subtotal.toFixed(2)}`;
    }
    
    async function recordPOSSale() {
        if (posCartItems.length === 0) {
            showToast("Please add products to the sale.");
            return;
        }

        posRecordSaleBtn.disabled = true;
        posRecordSaleBtn.textContent = 'Recording...';

        const saleData = {
            items: posCartItems,
            totalAmount: posCartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0)
        };

        try {
            const squareResponse = await fetch('http://127.0.0.1:8000/api/square/record-sale', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(saleData)
            });

            if (!squareResponse.ok) {
                const errorData = await squareResponse.json();
                throw new Error(errorData.details || 'Failed to record sale with Square.');
            }
            const squareResult = await squareResponse.json();

            const localStockResponse = await fetch('http://127.0.0.1:8000/api/admin/products/record-sale', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ items: saleData.items })
            });

            if (!localStockResponse.ok) {
                console.error('Failed to update local stock, but Square sale was successful.');
            }

            const transactionPromises = posCartItems.map(item => {
                const transactionData = {
                    item_name: item.name,
                    unit_price: item.price,
                    quantity: item.quantity,
                    order_status: 'Successful',
                    payment_status: 'Done'
                };
                return fetch('http://127.0.0.1:8000/api/transactions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(transactionData)
                });
            });

            await Promise.all(transactionPromises);
            console.log('POS sale successfully recorded in the main transactions table.');

            if (typeof fetchTransactions === 'function') {
                fetchTransactions();
            }
            
            showToast(`Sale recorded successfully! Order ID: ${squareResult.order.id}`);
            clearPOSSale();
            loadInventory();

        } catch (error) {
            console.error('Failed to record sale:', error);
            showToast(`Error: ${error.message}`);
        } finally {
            posRecordSaleBtn.disabled = false;
            posRecordSaleBtn.textContent = 'Record Sale';
        }
    }
    
    // **MODIFIED**: This function now validates quantity against stock
    window.updatePOSQuantity = (productId, inputElement) => {
        const item = posCartItems.find(i => i.id === productId);
        const product = posAllProducts.find(p => p.id === productId);
        let newQuantity = parseInt(inputElement.value) || 1;

        if (product && newQuantity > product.stock) {
            showToast(`Stock limit reached. Only ${product.stock} items available for ${product.name}.`);
            newQuantity = product.stock;
            inputElement.value = newQuantity; // Correct the input value in the UI
        }

        if (item) {
            item.quantity = Math.max(1, newQuantity);
        }
        renderPOSCart();
    };

    window.removeFromPOSCart = (productId) => {
        posCartItems = posCartItems.filter(item => item.id !== productId);
        renderPOSCart();
    };
    const clearPOSSale = () => {
        posCartItems = [];
        renderPOSCart();
    };

    fetchProductsFromBackend();
    posClearSaleBtn.addEventListener('click', clearPOSSale);
    posRecordSaleBtn.addEventListener('click', recordPOSSale);
    posSearchInput.addEventListener('input', (e) => renderPOSProducts(e.target.value));
    isPOSInitialized = true;
}


        
// <!-- ================================================================== -->
// <!-- ====================   POS END OF SCRIPT    ====================== -->
// <!-- ================================================================== -->


// <!-- ================================================================== -->
// <!-- ==================== PRODUCT SCRIPT UPDATED ====================== -->
// <!-- ================================================================== -->

// Product Upload
document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const formData = new FormData();
  formData.append('name', document.getElementById('productName').value);
  formData.append('price', document.getElementById('productPrice').value);
  formData.append('stock', document.getElementById('productStock').value);
  formData.append('description', document.getElementById('productDescription').value);
  formData.append('image', document.getElementById('productImage').files[0]);
  formData.append('category_id', document.getElementById('productCategory').value);

  try {
    const res = await fetch('http://127.0.0.1:8000/api/admin/products', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${token}`
      },
      body: formData
    });

    const result = await res.json();
    if (!res.ok) throw new Error(result.message || 'Upload failed');

    // Reset form and reload
    e.target.reset();
    document.getElementById('fileName').textContent = 'Choose file'; // RESET FILENAME SPAN
    loadProducts();

    // Show success toast
    showToast('Product uploaded successfully!', 'success');
  } catch (err) {
    console.error('Upload error:', err);

    // Show error toast
    showToast('Upload failed: ' + err.message, 'error');
  }
});

// Load categories into the dropdown
async function loadCategories() {
  const res = await fetch('http://127.0.0.1:8000/api/categories', {
    headers: { Authorization: `Bearer ${token}` }
  });
  const categories = await res.json();

  const categorySelect = document.getElementById('productCategory');
  categorySelect.innerHTML = '<option value="">-- Select Category --</option>';

  categories.forEach(c => {
    categorySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
  });
}

// Call it when the page loads
loadCategories();


async function loadProducts() {
    const res = await fetch('http://127.0.0.1:8000/api/admin/products', {
        headers: { Authorization: `Bearer ${token}` }
    });
    const products = await res.json();
    const tbody = document.querySelector('#productTable tbody');
    tbody.innerHTML = '';

    if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-6">No products uploaded yet.</td></tr>';
        return;
    }

    products.forEach(p => {
        const imageSrc = p.image_url || 'https://placehold.co/100x100/e2e8f0/334155?text=No+Img';
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4">
                <img class="h-12 w-12 object-cover rounded-md" src="${imageSrc}" alt="Product Image">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">₱${p.price}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.stock}</td>
            <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${p.description}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                <button onclick="editProduct(${p.id})" class="inline-flex items-center gap-2 px-4 py-3 text-xs font-medium text-white bg-yellow-500 rounded-lg hover:bg-yellow-600">
                    <i data-feather="edit-2" class="w-4 h-4"></i> Edit
                </button>
                <button onclick="deleteProduct(${p.id})" class="inline-flex items-center gap-2 px-4 py-3 text-xs font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">
                    <i data-feather="trash-2" class="w-4 h-4"></i> Delete
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    feather.replace(); // INITIALIZE ICONS
}

function editProduct(id) {
    fetch('http://127.0.0.1:8000/api/admin/products', {
        headers: { Authorization: `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(products => {
        const p = products.find(prod => prod.id === id);
        if (!p) {
            showToast('Product not found.');
            return;
        }

        document.getElementById('editProductId').value = p.id;
        document.getElementById('editName').value = p.name;
        document.getElementById('editprice').value = p.price;
        document.getElementById('editStock').value = p.stock;
        document.getElementById('editDescription').value = p.description;
        document.getElementById('editCategory').value = p.category_id;  
        document.getElementById('editSquareId').value = p.square_item_id || ''; 
        document.getElementById('editModal').style.display = 'flex';
    })
    .catch(err => {
        console.error("Error fetching product data:", err);
        showToast("Could not load product data for editing.");
    });
}

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

// Your submit function is correct and does NOT need to be changed.
document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = document.getElementById('editProductId').value;
    const formData = new FormData();
    formData.append('name', document.getElementById('editName').value);
    formData.append('price', document.getElementById('editprice').value);
    formData.append('stock', document.getElementById('editStock').value);
    formData.append('description', document.getElementById('editDescription').value);
    formData.append('category_id', document.getElementById('editCategory').value);
    formData.append('square_id', document.getElementById('editSquareId').value);

    const newImage = document.getElementById('editImage').files[0];
    if (newImage) {
        formData.append('image', newImage);
    }
    formData.append('_method', 'PUT');

    try {
        const res = await fetch(`http://127.0.0.1:8000/api/admin/products/${id}`, {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${token}`,
                'Accept': 'application/json'
            },
            body: formData
        });

        if (!res.ok) {
            const errorResult = await res.json();
            throw new Error(errorResult.message || 'Failed to update product');
        }
        
        await res.json();

        closeEditModal();
        loadProducts(); 
        initializePOS(); 
        showToast('Product updated successfully!');
    } catch (err) {
        console.error('Update error:', err);
        showToast('Error updating product: ' + err.message);
    }
});


async function deleteProduct(id) {
  if (!confirm('Are you sure you want to delete this product?')) return;

  try {
    const res = await fetch(`http://127.0.0.1:8000/api/admin/products/${id}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });

    const result = await res.json();
    
    if (!res.ok) {
      throw new Error(result.message || 'Delete failed');
    }
    
    // Reset the product form
    document.getElementById('productForm').reset();
    
    // Reload products after a short delay
    loadProducts();
  } catch (err) {
    console.error('Delete error:', err);
    showToast('Delete failed: ' + err.message);
  }
}

// SCRIPT TO DISPLAY THE CHOSEN FILE NAME
const fileInput = document.getElementById('productImage');
const fileNameSpan = document.getElementById('fileName');
if (fileInput) {
    fileInput.addEventListener('change', function() {
        if (fileInput.files.length > 0) {
            fileNameSpan.textContent = fileInput.files[0].name;
        } else {
            fileNameSpan.textContent = 'Choose file';
        }
    });
}
// <!-- ================================================================== -->
// <!-- =================== END OF PRODUCT SCRIPT ====================== -->
// <!-- ================================================================== -->



document.addEventListener('DOMContentLoaded', () => {
  loadCustomers();
  setInterval(fetchMessages, 3000); // auto refresh
  setInterval(checkAllCustomersForNewMessages, 3000);
});
const hasNewMessageMap = {};

let selectedCustomerId = null;

async function loadCustomers() {
  const res = await fetch('http://127.0.0.1:8000/api/customers');
  const customers = await res.json();
  const select = document.getElementById('customerSelect');

  select.innerHTML = '<option disabled selected value="">-- Select a Customer --</option>';

  customers.forEach(c => {
    const option = document.createElement('option');
    option.value = c.id;
    option.textContent = c.name;

    // Initialize lastReadMessageId for new customers
    if (!(c.id in lastReadMessageIdPerCustomer)) {
      lastReadMessageIdPerCustomer[c.id] = 0;
    }

    select.appendChild(option);
  });

  updateCustomerUnreadIndicators();
}

// escape helper
function escapeHtml(str) {
  return String(str).replace(/[&<>"'`=\/]/g, function(s) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s];
  });
}

async function loadCustomers() {
  try {
    const res = await fetch('http://127.0.0.1:8000/api/customers');
    const customers = await res.json();

    const list = document.getElementById('customerList');
    const btn = document.getElementById('customerSelectBtn');

    // reset
    list.innerHTML = '';
    btn.textContent = '-- Select a Customer -- ';
    btn.removeAttribute('data-id');
    btn.setAttribute('aria-expanded', 'false');

    customers.forEach(c => {
      const li = document.createElement('li');
      li.className = 'customer-item';
      li.dataset.id = c.id;
      li.innerHTML = `
        <span class="customer-name">${escapeHtml(c.name)}</span>
        <span class="unread-dot"></span>
      `;
      li.addEventListener('click', () => selectCustomer(c));
      list.appendChild(li);
    });

    updateCustomerUnreadIndicators();
  } catch (err) {
    console.error('Failed to load customers:', err);
  }
}

function selectCustomer(c) {
  const btn = document.getElementById('customerSelectBtn');
  const list = document.getElementById('customerList');

  btn.textContent = c.name;
  btn.dataset.id = c.id;
  btn.setAttribute('aria-expanded', 'false');
  list.classList.add('hidden');

  selectedCustomerId = c.id;

  // ✅ Update header
  document.getElementById('activeCustomer').textContent = c.name;

  // clear unread dot for this customer
  const dot = document.querySelector(`#customerList li[data-id="${c.id}"] .unread-dot`);
  if (dot) dot.innerHTML = '';

  // remove button dot if no other unread
  const stillUnread = Array.from(document.querySelectorAll('#customerList .unread-dot'))
    .some(d => d.innerHTML.trim() !== '');
  const btnDot = btn.querySelector('.btn-unread-dot');
  if (btnDot && !stillUnread) btnDot.remove();

  fetchMessages();
  markMessagesRead(c.id);
}

async function updateCustomerUnreadIndicators() {
  const items = Array.from(document.querySelectorAll('#customerList li'));
  for (const li of items) {
    const id = li.dataset.id;
    const placeholder = li.querySelector('.unread-dot');

    let unread = !!hasNewMessageMap[id];
    if (!unread) {
      try { unread = await hasUnread(id); } catch { unread = false; }
    }

    if (unread) {
      placeholder.innerHTML = `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle></svg>`;
    } else {
      placeholder.innerHTML = '';
    }
  }

  // button dot
  const anyUnread = items.some(li => li.querySelector('.unread-dot').innerHTML.trim() !== '');
  const btn = document.getElementById('customerSelectBtn');
  if (btn) {
    if (anyUnread) {
      if (!btn.querySelector('.btn-unread-dot')) {
        const dot = document.createElement('span');
        dot.className = 'btn-unread-dot';
        dot.style.cssText = 'display:inline-block;width:10px;height:10px;border-radius:50%;background:#28a745;margin-left:8px;';
        btn.appendChild(dot);
      }
    } else {
      const old = btn.querySelector('.btn-unread-dot');
      if (old) old.remove();
    }
  }
}

// dropdown toggle
document.addEventListener('click', function(e) {
  const wrapper = document.getElementById('customerSelectWrapper');
  const btn = document.getElementById('customerSelectBtn');
  const list = document.getElementById('customerList');
  if (!wrapper) return;

  if (e.target.closest('#customerSelectBtn')) {
    const isOpen = !list.classList.contains('hidden');
    list.classList.toggle('hidden', isOpen);
    btn.setAttribute('aria-expanded', String(!isOpen));
    return;
  }

  if (!e.target.closest('#customerSelectWrapper')) {
    list.classList.add('hidden');
    btn.setAttribute('aria-expanded', 'false');
  }
});

document.addEventListener('DOMContentLoaded', loadCustomers);

async function hasUnread(customerId) {
  if (hasNewMessageMap[customerId]) {
    return true;
  }

  try {
    const res = await fetch(`http://127.0.0.1:8000/api/messages/${customerId}`);
    const messages = await res.json();
    if (messages.length === 0) return false;

    const lastReadId = lastReadMessageIdPerCustomer[customerId] || 0;
    const latestMsgId = messages[messages.length - 1].id;
    return latestMsgId > lastReadId;
  } catch {
    return false;
  }
}


function handleCustomerChange() {
  selectedCustomerId = document.getElementById('customerSelect').value;
  fetchMessages();

  // When switching customer, mark messages as read by updating lastReadMessageId
  markMessagesRead(selectedCustomerId);
  updateCustomerUnreadIndicators();
}

function formatTimestamp(dateString) {
  const date = new Date(dateString);
  const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const day = date.toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' });
  return `${day} at ${time}`;
}

let lastReadMessageIdPerCustomer = JSON.parse(localStorage.getItem('lastReadIds')) || {};
let lastFetchedMessageId = 0;

async function fetchMessages() {
  if (!selectedCustomerId) return;

  const res = await fetch(`http://127.0.0.1:8000/api/messages/${selectedCustomerId}`);
  const messages = await res.json();
  const chatBox = document.getElementById('chatBox');

  const isAtBottom = chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 50;

  // Detect new messages
  if (messages.length > 0) {
    const latestMsgId = messages[messages.length - 1].id;
    if (latestMsgId > lastFetchedMessageId) {
      if (selectedCustomerId !== null && latestMsgId !== lastFetchedMessageId) {
        notifyNewMessage(messages[messages.length - 1]);
      }
      lastFetchedMessageId = latestMsgId;
    }
  }

  chatBox.innerHTML = '';

  messages.forEach(msg => {
    const isSent = msg.is_admin;
    const timestamp = formatTimestamp(msg.created_at);

    const lastReadId = lastReadMessageIdPerCustomer[selectedCustomerId] || 0;
    const isUnread = msg.id > lastReadId;

    const wrapper = document.createElement('div');
    wrapper.classList.add('message-wrapper', isSent ? 'sent-wrapper' : 'received-wrapper');

    wrapper.innerHTML = `
      <div class="message ${isSent ? 'sent' : 'received'} ${isUnread ? 'unread' : 'read'}">
        ${msg.message}
      </div>
      <div class="timestamp-only">${timestamp}</div>
    `;


    chatBox.appendChild(wrapper);
  });

  // Mark messages as read and persist to localStorage
  if (messages.length > 0) {
    const lastMsgId = messages[messages.length - 1].id;
    lastReadMessageIdPerCustomer[selectedCustomerId] = lastMsgId;
    localStorage.setItem('lastReadIds', JSON.stringify(lastReadMessageIdPerCustomer));
  }

  if (isAtBottom) {
    chatBox.scrollTop = chatBox.scrollHeight;
  }
}



function markMessagesRead(customerId) {
  fetch(`http://127.0.0.1:8000/api/messages/${customerId}`)
    .then(res => res.json())
    .then(messages => {
      if (messages.length === 0) return;
      lastReadMessageIdPerCustomer[customerId] = messages[messages.length - 1].id;

      hasNewMessageMap[customerId] = false; // ✅ clear red dot flag

      updateCustomerUnreadIndicators();
    });
}


async function sendMessage() {
  const msg = document.getElementById('chatInput').value;
  if (!selectedCustomerId || !msg.trim()) return;

  await fetch('http://127.0.0.1:8000/api/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      sender_id: 0,
      receiver_id: selectedCustomerId,
      message: msg,
      is_admin: true
    })
  });

  document.getElementById('chatInput').value = '';
  fetchMessages();
}

// Desktop notification for new messages
function notifyNewMessage(msg) {
  console.log("🔔 Notification triggered:", msg);
  if (document.hidden && Notification.permission === 'granted') {
    const notification = new Notification(`New message from ${msg.is_admin ? 'Admin' : msg.sender.name}`, {
      body: msg.message,
      icon: 'chat-icon.png', // optional: path to your icon
    });

    notification.onclick = () => {
      window.focus();
      // Optionally, switch to customer chat if you have UI for that
    };
  }
}


let lastFetchedMessageIdMap = {}; // per customer

async function checkAllCustomersForNewMessages() {
  const res = await fetch('http://127.0.0.1:8000/api/customers');
  const customers = await res.json();

  for (const customer of customers) {
    try {
      const res = await fetch(`http://127.0.0.1:8000/api/messages/${customer.id}`);
      const messages = await res.json();

      if (messages.length === 0) continue;

      const latestMsg = messages[messages.length - 1];

      // Only notify if the message is NOT from admin
      if (!latestMsg.is_admin) {
        const lastFetchedId = lastFetchedMessageIdMap[customer.id] || 0;

        if (latestMsg.id > lastFetchedId) {
          lastFetchedMessageIdMap[customer.id] = latestMsg.id;

          hasNewMessageMap[customer.id] = true;
          updateCustomerUnreadIndicators(); // ✅ Add this


          notifyNewMessage(latestMsg);
        }
      }
    } catch (err) {
      console.error(`Failed to check messages for customer ${customer.id}:`, err);
    }
  }
}

// Request notification permission once on page load
if ('Notification' in window && Notification.permission !== 'granted') {
  Notification.requestPermission();
}


let selectedTransactionId = null;


// <!-- ================================================================== -->
// <!-- ====================    TRANSACTION SCRIPT     =================== -->
// <!-- ================================================================== -->
fetchTransactions();
loadCategoriesForTransactions();

let categoryMap = new Map(); 

// Fetch transactions list
async function fetchTransactions() {
  const res = await fetch('http://127.0.0.1:8000/api/transactions', {
    headers: { Authorization: `Bearer ${token}` }
  });
  const transactions = await res.json();
  const list = document.getElementById('transactionsList');
  list.innerHTML = '';

  transactions.forEach(tx => {
    const date = new Date(tx.created_at).toLocaleString('en-US', {
      month: 'short', day: 'numeric', year: 'numeric',
      hour: 'numeric', minute: 'numeric', hour12: true
    });

    const itemNameEscaped = tx.item_name.replace(/'/g, "\\'");

    // ✅ get category name using stored categoryMap
    const categoryName = categoryMap.get(tx.category_id) || 'N/A';

    const row = document.createElement('tr');
    row.className = "bg-white border-b hover:bg-gray-50";
    row.style.border = "none";

    row.innerHTML = `
      <td class="px-6 py-4 text-gray-900 whitespace-nowrap" style="border:none">${date}</td>
      <td class="px-6 py-4 font-medium text-gray-900" style="border:none">${tx.item_name}</td>
      <td class="px-6 py-4 text-center" style="border:none">${categoryName}</td>
      <td class="px-6 py-4 text-right" style="border:none">₱${parseFloat(tx.unit_price).toFixed(2)}</td>
      <td class="px-6 py-4 text-center" style="border:none">${tx.quantity}</td>
      <td class="px-6 py-4 text-center" style="border:none">
        <span class="status-pill ${tx.order_status === 'Successful' ? 'status-successful' : 'status-pending'}">${tx.order_status}</span>
      </td>
      <td class="px-6 py-4 text-center" style="border:none">
        <span class="status-pill ${tx.payment_status === 'Done' ? 'status-done' : 'status-pending'}">${tx.payment_status}</span>
      </td>
      <td class="px-6 py-4 text-right" style="border:none">
        <button onclick="openEditModal(${tx.id}, '${itemNameEscaped}', ${tx.unit_price}, ${tx.quantity}, '${tx.order_status}', '${tx.payment_status}')" class="text-[#ED4A69] hover:text-[#c13b56]"><i class="fas fa-edit fa-fw"></i></button>
        <button onclick="deleteTransaction(${tx.id})" class="text-red-600 hover:text-red-900 ml-2"><i class="fas fa-trash fa-fw"></i></button>
      </td>
    `;
    list.appendChild(row);
  });
}

// Submit new transaction
async function submitTransaction() {
  const item = document.getElementById("item").value;
  const price = parseFloat(document.getElementById("price").value);
  const qty = parseInt(document.getElementById("qty").value);
  const orderStatus = document.getElementById("orderStatus").value;
  const paymentStatus = document.getElementById("paymentStatus").value;
  const categoryId = document.getElementById("transactionCategory").value; // ✅ added category

  const responseDiv = document.getElementById("response");

  try {
    const res = await fetch('http://127.0.0.1:8000/api/transactions', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({
        item_name: item,
        unit_price: price,
        quantity: qty,
        order_status: orderStatus,
        payment_status: paymentStatus,
        category_id: categoryId // ✅ include category
      })
    });

    const data = await res.json();
    responseDiv.innerText = data.message || 'Transaction added!';
    responseDiv.style.color = "green";

    // Reset form
    document.getElementById("item").value = '';
    document.getElementById("price").value = '';
    document.getElementById("qty").value = '';
    document.getElementById("orderStatus").value = 'Pending';
    document.getElementById("paymentStatus").value = 'Pending';
    document.getElementById("transactionCategory").value = ''; // ✅ reset category

    fetchTransactions();
  } catch (err) {
    responseDiv.innerText = 'Error saving transaction.';
    responseDiv.style.color = "red";
    console.error(err);
  }
}

// Edit modal logic
function openEditModal(id, item_name, unit_price, quantity, order_status, payment_status) {
  selectedTransactionId = id;
  document.getElementById('editTransactionId').value = id;
  document.getElementById('editItem').value = item_name;
  document.getElementById('editPrice').value = unit_price;
  document.getElementById('editQty').value = quantity;
  document.getElementById('editOrderStatus').value = order_status;
  document.getElementById('editPaymentStatus').value = payment_status;
  const modal = document.getElementById('transactionModal');
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
}

function closeTransactionModal() {
  const modal = document.getElementById('transactionModal');
  modal.classList.add('hidden');
  modal.style.display = 'none';
}

// Save edits
async function saveEdit() {
  const id = document.getElementById('editTransactionId').value;
  const item = document.getElementById('editItem').value;
  const price = parseFloat(document.getElementById('editPrice').value);
  const qty = parseInt(document.getElementById('editQty').value);
  const orderStatus = document.getElementById('editOrderStatus').value;
  const paymentStatus = document.getElementById('editPaymentStatus').value;

  try {
    await fetch(`http://127.0.0.1:8000/api/transactions/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({
        item_name: item,
        unit_price: price,
        quantity: qty,
        order_status: orderStatus,
        payment_status: paymentStatus
      })
    });

    closeTransactionModal();
    fetchTransactions();
  } catch (err) {
    console.error("Update failed:", err);
  }
}

// Delete transaction
async function deleteTransaction(id) {
  if (!confirm("Are you sure you want to delete this transaction?")) return;

  try {
    const res = await fetch(`http://127.0.0.1:8000/api/transactions/${id}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });

    if (!res.ok) {
      throw new Error('Failed to delete transaction');
    }

    document.getElementById("response").innerText = 'Transaction deleted successfully!';
    document.getElementById("response").style.color = 'green';
    
    fetchTransactions();
  } catch (err) {
    console.error("Delete error:", err);
    showToast("Error deleting transaction: " + err.message);
  }
}

// Load categories for transaction dropdown
async function loadCategoriesForTransactions() {
  const res = await fetch('http://127.0.0.1:8000/api/categories', {
    headers: { Authorization: `Bearer ${token}` }
  });
  const categories = await res.json();
  const select = document.getElementById('transactionCategory');
  select.innerHTML = '<option value="">-- Select Category --</option>';

  categories.forEach(c => {
    select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    categoryMap.set(c.id, c.name); // store for later use
  });
}
// <!-- ================================================================== -->
// <!-- ==================== END OF TRANSACTION SCRIPT =================== -->
// <!-- ================================================================== -->

// <!-- ================================================================== -->
// <!-- ==================== DASHBOARD SCRIPT LOGIC ====================== -->
// <!-- ================================================================== -->
let salesDonutChartInstance = null;
let salesBarChartInstance = null;
let salesValueBarChartInstance = null;

// --- LIVE CLOCK ---
function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
    const clockElement = document.getElementById('live-clock');
    if (clockElement) {
        clockElement.textContent = timeString;
    }
}

// --- MAIN DASHBOARD UPDATE FUNCTION ---
async function updateDashboard() {

    // ADDED: Check if the token exists. This is a common source of errors.
    if (typeof token === 'undefined' || !token) {
        console.error("Authentication token is missing or undefined. Cannot fetch dashboard data.");
        // This stops the function from running without a token.
        return;
    }

    try {
        const [ordersResponse, appointmentsResponse, summaryResponse, topProductsResponse] = await Promise.all([
            fetch('http://127.0.0.1:8000/api/admin/orders', { headers: { Authorization: `Bearer ${token}` } }),
            fetch('http://127.0.0.1:8000/api/appointments', { headers: { Authorization: `Bearer ${token}` } }),
            fetch('http://127.0.0.1:8000/api/reports/dashboard-summary', { headers: { Authorization: `Bearer ${token}` } }),
            fetch('http://127.0.0.1:8000/api/reports/top-products', { headers: { Authorization: `Bearer ${token}` } })
        ]);

        if (!summaryResponse.ok) {
            console.error(`Error fetching dashboard summary: ${summaryResponse.status} ${summaryResponse.statusText}`);
            throw new Error('Failed to fetch dashboard summary');
        }
        if (!topProductsResponse.ok) {
            console.error(`Error fetching top products: ${topProductsResponse.status} ${topProductsResponse.statusText}`);
            throw new Error('Failed to fetch top products');
        }

        const orders = ordersResponse.ok ? await ordersResponse.json() : [];
        const appointmentsData = appointmentsResponse.ok ? await appointmentsResponse.json() : { data: [] };
        const appointments = appointmentsData.data || appointmentsData;
        const summaryData = await summaryResponse.json();
        const topProductsData = await topProductsResponse.json();

        updateStatCards(orders, summaryData);

        // MODIFIED: Added a check in case the API wraps the array in a 'data' object
        const validTopProductsData = topProductsData.data || (Array.isArray(topProductsData) ? topProductsData : []);

        // **IMPORTANT**: Your API for 'top-products' MUST return 'total_revenue'.
        // If it's named 'total_sales' or something else, you must change it here.
        const combinedTopSales = validTopProductsData.map(product => ({
            item_name: product.product_name,
            total_quantity: product.total_quantity,
            total_revenue: product.total_revenue // This assumes your API provides this field
        }));

        updateSalesCharts(combinedTopSales);
        updateActivityFeed(orders, appointments);

    } catch (error) {
        console.error("Failed to update dashboard:", error);
        const totalRevenueEl = document.getElementById('total-revenue');
        if (totalRevenueEl) totalRevenueEl.textContent = '₱Error';
        const totalSalesEl = document.getElementById('total-sales');
        if (totalSalesEl) totalSalesEl.textContent = 'Error';
        const pendingOrdersEl = document.getElementById('pending-orders');
        if (pendingOrdersEl) pendingOrdersEl.textContent = 'Error';
        const legendContainer = document.getElementById('sales-legend');
        if (legendContainer) legendContainer.innerHTML = '<p class="text-slate-500 text-center text-red-500">Error loading chart data.</p>';
        const feed = document.getElementById('activity-feed');
        if (feed) feed.innerHTML = '<li class="flex items-center justify-center text-red-500 py-10">Error loading activities.</li>';
    }
}

// --- UPDATE STAT CARDS ---
function updateStatCards(orders, summaryData) {
    if (typeof summaryData !== 'object' || summaryData === null) {
        console.error("Invalid summary data received:", summaryData);
    }

    const now = new Date();
    const startOfCurrentMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const startOfPreviousMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const endOfPreviousMonth = new Date(now.getFullYear(), now.getMonth(), 0);

    let currentMonthRevenue = summaryData?.current_month?.total_revenue ?? 0;
    let previousMonthRevenue = summaryData?.previous_month?.total_revenue ?? 0;
    let currentMonthSalesCount = summaryData?.current_month?.total_sales_count ?? 0;
    let previousMonthSalesCount = summaryData?.previous_month?.total_sales_count ?? 0;

    let pendingOrders = 0;
    if (Array.isArray(orders)) {
        orders.forEach(order => {
            if (order.tracking_stage !== 'Delivered') {
                pendingOrders++;
            }
        });
    }

    const getComparisonText = (current, previous, element, isRevenue = false) => {
        if (!element) return;
        const parentDiv = element.nextElementSibling;
        if (!parentDiv || typeof parentDiv.querySelector !== 'function') return;

        const spanElement = parentDiv.querySelector('span');
        const svgElement = parentDiv.querySelector('svg');

        if (!spanElement || !svgElement) return;

        if (previous === 0) {
            if (current > 0) {
                spanElement.textContent = 'Up from last month';
                svgElement.style.transform = 'rotate(0deg)';
                svgElement.style.color = '#10B981';
            } else {
                spanElement.textContent = 'No change from last month';
                svgElement.style.transform = 'rotate(90deg)';
                svgElement.style.color = '#64748B';
            }
            return;
        }

        const percentageChange = ((current - previous) / previous) * 100;
        if (percentageChange > 0) {
            spanElement.textContent = `+${percentageChange.toFixed(0)}% from last month`;
            svgElement.style.transform = 'rotate(0deg)';
            svgElement.style.color = '#10B981';
        } else if (percentageChange < 0) {
            spanElement.textContent = `${percentageChange.toFixed(0)}% from last month`;
            svgElement.style.transform = 'rotate(180deg)';
            svgElement.style.color = '#EF4444';
        } else {
            spanElement.textContent = 'No change from last month';
            svgElement.style.transform = 'rotate(90deg)';
            svgElement.style.color = '#64748B';
        }
    };

    const totalRevenueEl = document.getElementById('total-revenue');
    if (totalRevenueEl) {
        totalRevenueEl.textContent = `₱${Number(currentMonthRevenue).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        getComparisonText(Number(currentMonthRevenue), Number(previousMonthRevenue), totalRevenueEl, true);
    }

    const totalSalesEl = document.getElementById('total-sales');
    if (totalSalesEl) {
        totalSalesEl.textContent = currentMonthSalesCount;
        getComparisonText(currentMonthSalesCount, previousMonthSalesCount, totalSalesEl);
    }

    const pendingOrdersEl = document.getElementById('pending-orders');
    if (pendingOrdersEl) {
        pendingOrdersEl.textContent = pendingOrders;
    }
}

// --- CHART UPDATE FUNCTION ---
function updateSalesCharts(topSales) {
    const salesLabels = topSales.map(item => item.item_name);
    const salesValues = topSales.map(item => item.total_quantity); // For volume

    // **IMPORTANT**: This relies on 'total_revenue' from the 'combinedTopSales' map.
    const salesRevenueValues = topSales.map(item => item.total_revenue); // For sales value

    const totalItemsSold = salesValues.reduce((sum, value) => sum + parseInt(value || 0, 10), 0);

    const themeColors = {
        primary: '#EF534F', secondary: '#FB7E96', accent: '#FFCDD2',
        dark: '#4C4141', neutral: '#64748b', grid: '#e2e8f0'
    };
    const donutColors = [themeColors.primary, themeColors.secondary, themeColors.accent, themeColors.dark, '#FB923C', '#A78BFA', '#60A5FA'];

    // ADDED: Consistent animation options for all charts
    const chartAnimation = {
        duration: 800,
        easing: 'easeInOutQuart'
    };

    // ADDED: Reusable hover function for cursor
    const onChartHover = (event, chartElement) => {
        const canvas = event.native.target;
        canvas.style.cursor = chartElement[0] ? 'pointer' : 'default';
    };

    const totalSalesValueEl = document.getElementById('total-sales-value');
    if (totalSalesValueEl) totalSalesValueEl.textContent = totalItemsSold;

    // Legend (remains based on volume/quantity)
    const legendContainer = document.getElementById('sales-legend');
    if (legendContainer) {
        legendContainer.innerHTML = '';
        if (topSales.length > 0 && totalItemsSold > 0) { // Added check for totalItemsSold
            topSales.forEach((item, index) => {
                const quantity = parseInt(item.total_quantity || 0, 10);
                const percentage = totalItemsSold > 0 ? ((quantity / totalItemsSold) * 100).toFixed(0) : 0;
                const legendItem = `
                        <div class="flex items-center justify-between px-3 py-1 rounded-lg hover:bg-slate-50 transition">
                            <div class="flex items-center gap-2">
                                <span class="w-2.5 h-2.5 rounded-full" style="background-color: ${donutColors[index % donutColors.length]}"></span>
                                <span class="font-medium text-slate-600 text-sm truncate">${item.item_name || 'Unknown'}</span>
                            </div>
                            <span class="font-semibold text-slate-800 text-sm">${percentage}%</span>
                        </div>`;
                legendContainer.innerHTML += legendItem;
            });
        } else {
            legendContainer.innerHTML = '<p class="text-slate-500 text-center">No sales data available.</p>';
        }
    }

    // Donut Chart (remains based on volume/quantity)
    const donutCanvas = document.getElementById('salesDonutChart');
    const donutCtx = donutCanvas?.getContext('2d');
    if (donutCtx) {
        if (salesDonutChartInstance) {
            // IMPROVED: Update existing chart for smooth animation (no flicker)
            salesDonutChartInstance.data.labels = salesLabels;
            salesDonutChartInstance.data.datasets[0].data = salesValues;
            salesDonutChartInstance.update();
        } else {
            // Create new chart if it doesn't exist
            salesDonutChartInstance = new Chart(donutCtx, {
                type: 'doughnut',
                data: {
                    labels: salesLabels,
                    datasets: [{
                        data: salesValues,
                        backgroundColor: donutColors,
                        borderColor: '#fff',
                        borderWidth: 4,
                        hoverOffset: 12, // ADDED: Makes slice pop out
                        hoverBorderWidth: 6, // ADDED: Cleans up border on hover
                        hoverBorderColor: '#fff' // ADDED: Cleans up border on hover
                    }]
                },
                options: {
                    cutout: '80%',
                    plugins: { legend: { display: false } },
                    animation: chartAnimation, // Animation enabled
                    onHover: onChartHover // ADDED: Cursor pointer
                }
            });
        }
    }

    // Bar Chart (Volume)
    const barCtx = document.getElementById('salesBarChart')?.getContext('2d');
    if (barCtx) {
        if (salesBarChartInstance) {
            // IMPROVED: Update existing chart
            salesBarChartInstance.data.labels = salesLabels;
            salesBarChartInstance.data.datasets[0].data = salesValues;
            salesBarChartInstance.update();
        } else {
            // Create new chart
            salesBarChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: salesLabels,
                    datasets: [{
                        data: salesValues,
                        backgroundColor: themeColors.primary,
                        borderRadius: 6,
                        barThickness: 20,
                        hoverBackgroundColor: themeColors.dark, // ADDED: Bar color change
                        hoverBorderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { beginAtZero: true } },
                    animation: chartAnimation, // Animation enabled
                    onHover: onChartHover // ADDED: Cursor pointer
                }
            });
        }
    }

    // ADDED: Bar Chart (Sales Value / Revenue)
    const valueBarCtx = document.getElementById('salesValueBarChart')?.getContext('2d'); // Assumes new canvas ID
    if (valueBarCtx) {
        if (salesValueBarChartInstance) {
            // IMPROVED: Update existing chart
            salesValueBarChartInstance.data.labels = salesLabels;
            salesValueBarChartInstance.data.datasets[0].data = salesRevenueValues;
            salesValueBarChartInstance.update();
        } else {
            // Create new chart
            salesValueBarChartInstance = new Chart(valueBarCtx, {
                type: 'bar',
                data: {
                    labels: salesLabels,
                    datasets: [{
                        data: salesRevenueValues, // Use new sales revenue data
                        backgroundColor: themeColors.secondary, // Use a different color
                        borderRadius: 6,
                        barThickness: 20,
                        hoverBackgroundColor: themeColors.dark, // ADDED: Bar color change
                        hoverBorderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', {
                                            style: 'currency',
                                            currency: 'PHP' // Set to Philippine Peso
                                        }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, ticks) {
                                    return '₱' + Number(value).toLocaleString('en-US');
                                }
                            }
                        }
                    },
                    animation: chartAnimation, // Animation enabled
                    onHover: onChartHover // ADDED: Cursor pointer
                }
            });
        }
    }
}


// --- FIXED ACTIVITY FEED UI ---
// MODIFIED: Removed the fade-in/out animation for an instant update.
function updateActivityFeed(orders, appointments) {
    const feed = document.getElementById('activity-feed');
    if (!feed) return;

    feed.innerHTML = ''; // Clear content

    const recentOrders = (Array.isArray(orders) ? orders : []).slice(-5).map(o => ({
        type: 'order', date: new Date(o.updated_at), data: o
    }));

    const recentAppointments = (Array.isArray(appointments) ? appointments : []).slice(-5).map(a => ({
        type: 'appointment', date: new Date(a.updated_at), data: a
    }));

    const activities = [...recentOrders, ...recentAppointments].sort((a, b) => b.date - a.date).slice(0, 5);

    if (activities.length === 0) {
        feed.innerHTML = '<li class="flex items-center justify-center text-slate-500 py-6">No recent activities.</li>';
        return; // Return early
    }

    activities.forEach(activity => {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-3 py-2 px-2 rounded-lg hover:bg-slate-50 transition';

        const timeAgo = (date) => {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 5) return "just now";
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        };

        let iconHtml = '';
        let textHtml = '';

        if (activity.type === 'order') {
            iconHtml = `
                        <div class="flex items-center justify-center h-8 w-8 rounded-full bg-green-100 text-green-600">
                            <i data-feather="package" class="w-4 h-4"></i>
                        </div>`;
            let statusText = `New order #${activity.data.order_id} was placed.`;
            if (activity.data.created_at !== activity.data.updated_at) {
                statusText = `Order #${activity.data.order_id} status updated to ${activity.data.tracking_stage || activity.data.status}.`;
            }
            textHtml = `
                        <div>
                            <p class="text-sm font-medium text-slate-700">${statusText}</p>
                            <p class="text-xs text-slate-500">${timeAgo(activity.date)}</p>
                        </div>`;
        } else if (activity.type === 'appointment') {
            iconHtml = `
                        <div class="flex items-center justify-center h-8 w-8 rounded-full bg-purple-100 text-purple-600">
                            <i data-feather="calendar" class="w-4 h-4"></i>
                        </div>`;
            let statusText = `New appointment from ${activity.data.full_name}.`;
            if (activity.data.created_at !== activity.data.updated_at) {
                statusText = `Appointment for ${activity.data.full_name} was ${activity.data.status}.`;
            }
            textHtml = `
                        <div>
                            <p class="text-sm font-medium text-slate-700">${statusText}</p>
                            <p class="text-xs text-slate-500">${timeAgo(activity.date)}</p>
                        </div>`;
        }

        li.innerHTML = iconHtml + textHtml;
        feed.appendChild(li);
    });

    feather.replace(); // Re-initialize feather icons
}

// --- MINI CALENDAR WIDGET ---
function initializeCalendar() {
    const calendarHeader = document.getElementById('calendar-month-year');
    const calendarGrid = document.getElementById('calendar-grid');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    let currentDate = new Date();

    const renderCalendar = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        if (!calendarHeader || !calendarGrid) return;
        calendarHeader.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
        calendarGrid.innerHTML = '';

        const daysOfWeek = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
        daysOfWeek.forEach(day => {
            const dayEl = document.createElement('div');
            dayEl.className = 'font-semibold text-slate-500';
            dayEl.textContent = day;
            calendarGrid.appendChild(dayEl);
        })

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDayOfMonth; i++) {
            calendarGrid.appendChild(document.createElement('div'));
        }
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.textContent = i;
            dayEl.className = 'p-1 cursor-pointer rounded-full hover:bg-slate-100 flex items-center justify-center h-6 w-6';
            const today = new Date();
            if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayEl.style.backgroundColor = '#EF534F';
                dayEl.className += ` text-white font-bold`;
            }
            calendarGrid.appendChild(dayEl);
        }
    }

    if (prevMonthBtn) {
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
    }
    if (nextMonthBtn) {
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
    }
    renderCalendar();
}
// // // // Add listeners for the new modal
document.addEventListener('DOMContentLoaded', () => {
    // [NEW] Initialize Flatpickr Date Pickers
    fpStartDateInstance = flatpickr("#exportStartDate", {
        dateFormat: "Y-m-d",
        disableMobile: true,
        onChange: function(selectedDates, dateStr, instance) {
            // When start date changes, set the minimum date for the end date picker
            if (fpEndDateInstance && selectedDates[0]) {
                fpEndDateInstance.set('minDate', selectedDates[0]);
            }
        }
    });
    
    fpEndDateInstance = flatpickr("#exportEndDate", {
        dateFormat: "Y-m-d",
        disableMobile: true,
        maxDate: "today",
        onChange: function(selectedDates, dateStr, instance) {
            // When end date changes, set the maximum date for the start date picker
            if (fpStartDateInstance && selectedDates[0]) {
                fpStartDateInstance.set('maxDate', selectedDates[0]);
            }
        }
    });
});

    // Export Report Listeners
    const exportBtn = document.getElementById('exportReportBtn');

function openExportModal() {
    const modal = document.getElementById('exportReportModal');
    
    // Set default dates to the current month
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
    const todayStr = today.toISOString().split('T')[0];
    
    document.getElementById('exportStartDate').value = firstDayOfMonth;
    document.getElementById('exportEndDate').value = todayStr;
    
    modal.classList.remove('hidden');
}

function closeExportModal() {
    const modal = document.getElementById('exportReportModal');
    modal.classList.add('hidden');
}

// --- INITIALIZE DASHBOARD ---
document.addEventListener('DOMContentLoaded', () => {
    const homeElement = document.getElementById('home');
    if (homeElement && !homeElement.classList.contains('hidden')) {
        updateDashboard();
    }
    initializeCalendar();
    updateClock();
    // REMOVED: setInterval(updateDashboard, 5000);
    setInterval(updateClock, 1000);
});
// <!-- ================================================================== -->
// <!-- ==================== END OF DASHBOARD SCRIPT ===================== -->
// <!-- ================================================================== -->


// <!-- ================================================================== -->
// <!-- ====================      EXPORT REPORT      ===================== -->
// <!-- ================================================================== -->
  // --- Opens the export modal and sets default dates ---
  function openExportModal() {
      const modal = document.getElementById('exportReportModal');
      if (!modal) {
           console.error("Export modal element (#exportReportModal) not found!");
           // Assuming showToast is defined elsewhere
           // showToast("Error: Export dialog could not be opened.", "error"); 
           return;
      }
      
      const startDateInput = document.getElementById('exportStartDate');
      const endDateInput = document.getElementById('exportEndDate');
      
      if (!startDateInput || !endDateInput) {
           console.error("Date input elements (#exportStartDate or #exportEndDate) not found inside the modal!");
           // Assuming showToast is defined elsewhere
           // showToast("Error: Date inputs missing in the export dialog.", "error");
           return; 
      }

      // Set default dates to the current month
      const today = new Date();
      const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
      const todayStr = today.toISOString().split('T')[0];
      
      // Use flatpickr.setDate() to update the calendars
      if (fpStartDateInstance && fpEndDateInstance) {
          fpStartDateInstance.setDate(firstDayOfMonth, false); // false = don't trigger change event
          fpEndDateInstance.setDate(todayStr, false);
          // Ensure date constraints are set correctly when opening
          fpEndDateInstance.set('maxDate', todayStr); 
          fpStartDateInstance.set('maxDate', todayStr); 
          // Ensure minDate is reset or set appropriately if needed, e.g., based on firstDayOfMonth
          fpEndDateInstance.set('minDate', firstDayOfMonth); 
      } else {
          // Fallback if flatpickr failed to init
          console.warn("Flatpickr instances not ready during openExportModal");
          startDateInput.value = firstDayOfMonth;
          endDateInput.value = todayStr;
      }
      
      modal.classList.remove('hidden');
      modal.style.display = 'flex'; // Explicitly set display

      // Call lucide to render icons (like the calendar) inside the modal
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      } else {
        console.warn("Lucide library not available when trying to create icons in modal.");
      }
  }

  // --- Closes the export modal ---
  function closeExportModal() {
      const modal = document.getElementById('exportReportModal');
      if (modal) {
          modal.classList.add('hidden');
          modal.style.display = 'none'; // Explicitly hide
      }
  }

  // --- Sets the date range based on preset buttons ---
  function setExportDateRange(period) {
      const today = new Date();
      const startDateInput = document.getElementById('exportStartDate'); // Still needed for reference?
      const endDateInput = document.getElementById('exportEndDate'); // Still needed for reference?

      // Get Flatpickr instances
      const fpStartDate = fpStartDateInstance;
      const fpEndDate = fpEndDateInstance;

      // Check if instances exist
      if (!startDateInput || !endDateInput || !fpStartDate || !fpEndDate) {
          console.error("Date input elements or flatpickr instances not found in setExportDateRange.");
          return;
      }

      // Adjust for timezone offset to get local date string correctly
      const tzoffset = today.getTimezoneOffset() * 60000; // offset in milliseconds
      const localISOTime = (date) => {
          if (!date || isNaN(date.getTime())) return ''; // Handle invalid dates
          try {
            return new Date(date.getTime() - tzoffset).toISOString().split('T')[0];
          } catch (e) {
            console.error("Error formatting date:", date, e);
            return '';
          }
      }

      let startDate, endDate;
      // Use a new date object for end date manipulation to avoid modifying 'today'
      let tempEndDate = new Date(); 

      try {
          switch (period) {
              case 'week': // This Week (Mon-Today)
                  const dayOfWeek = today.getDay(); // 0=Sunday, 1=Monday...
                  startDate = new Date(today);
                  // Adjust to start of week (Monday)
                  startDate.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
                  endDate = today; // Keep end date as today
                  break;
              case 'lastWeek': // Previous Week (Mon-Sun)
                   startDate = new Date(today);
                  // Go back to previous Monday (adjusts for Sunday being 0)
                  startDate.setDate(today.getDate() - (today.getDay() === 0 ? 7 : today.getDay()) - 6);
                  endDate = new Date(startDate);
                  // Go forward to Sunday
                  endDate.setDate(startDate.getDate() + 6);
                  break;
              case 'month': // This Month (1st - Today)
                  startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                  endDate = today; // Keep end date as today
                  break;
              case 'lastMonth': // Previous Full Month
                   startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                   // Last day of previous month
                   endDate = new Date(today.getFullYear(), today.getMonth(), 0); 
                   break;
              case 'year': // This Year (Jan 1st - Today)
                  startDate = new Date(today.getFullYear(), 0, 1);
                  endDate = today; // Keep end date as today
                  break;
              default: // Default to This Month
                   startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                   endDate = today;
                   break;
          }

          const startDateStr = localISOTime(startDate);
          const endDateStr = localISOTime(endDate);
          const todayStr = localISOTime(new Date()); // Today's date string for maxDate

          // Use flatpickr.setDate() to update the calendars
          fpStartDate.setDate(startDateStr, true); // true = trigger onChange
          fpEndDate.setDate(endDateStr, true);

          // Re-apply constraints after setting dates
          fpEndDate.set('maxDate', todayStr); 
          fpStartDate.set('maxDate', endDateStr); // Max start date is the selected end date
          fpEndDate.set('minDate', startDateStr); // Min end date is the selected start date


      } catch (error) {
          console.error("Error setting date range:", error);
          const defaultStart = localISOTime(new Date(today.getFullYear(), today.getMonth(), 1));
          const defaultEnd = localISOTime(today);
          const todayStr = localISOTime(new Date());

          // Fallback using flatpickr
          fpStartDate.setDate(defaultStart, true);
          fpEndDate.setDate(defaultEnd, true);
          fpEndDate.set('maxDate', todayStr);
          fpStartDate.set('maxDate', defaultEnd);
          fpEndDate.set('minDate', defaultStart);
      }
  }

  // --- Handles the report generation request ---
  async function handleReportGeneration(event) {
      event.preventDefault(); // Prevent default form submission

      const generateBtn = document.getElementById('generateReportBtn');
      const reportTypeSelect = document.getElementById('exportReportType');
      const startDateInput = document.getElementById('exportStartDate'); // The input element itself
      const endDateInput = document.getElementById('exportEndDate'); // The input element itself

      // Double check elements exist before accessing values
      if (!generateBtn || !reportTypeSelect || !startDateInput || !endDateInput) {
           console.error("Form elements missing in export modal.");
           // Assuming showToast is defined elsewhere
           // showToast("Error: Cannot generate report due to missing form elements.", "error");
           return;
      }

      generateBtn.disabled = true;
      generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating...'; // Add loading indicator


      const reportType = reportTypeSelect.value;
      // Get values directly from input elements, Flatpickr updates these
      const startDate = startDateInput.value; 
      const endDate = endDateInput.value;

      // Validate dates
      if (!startDate || !endDate) {
          // Assuming showToast is defined elsewhere
          // showToast("Please select both start and end dates.", "error"); 
          generateBtn.disabled = false;
          generateBtn.innerHTML = '<i data-lucide="download" class="h-4 w-4"></i> Generate Report';
           if (typeof lucide !== 'undefined') lucide.createIcons(); // Re-render icon
          return;
      }
      
      // Prevent future dates (double check, Flatpickr should handle this too)
      const today = new Date();
      const tzoffset = today.getTimezoneOffset() * 60000;
      const todayMax = new Date(today.getTime() - tzoffset).toISOString().split('T')[0];
      
      if (endDate > todayMax) {
           // Assuming showToast is defined elsewhere
           // showToast("End date cannot be in the future.", "error");
           // Correct the value via Flatpickr instance if available
           if(fpEndDateInstance) fpEndDateInstance.setDate(todayMax, true); 
           else endDateInput.value = todayMax; // Fallback
           generateBtn.disabled = false;
           generateBtn.innerHTML = '<i data-lucide="download" class="h-4 w-4"></i> Generate Report';
           if (typeof lucide !== 'undefined') lucide.createIcons(); // Re-render icon
           return;
      }
      
      if (new Date(startDate) > new Date(endDate)) {
          // Assuming showToast is defined elsewhere
          // showToast("Start date cannot be after end date.", "error");
          generateBtn.disabled = false;
          generateBtn.innerHTML = '<i data-lucide="download" class="h-4 w-4"></i> Generate Report';
           if (typeof lucide !== 'undefined') lucide.createIcons(); // Re-render icon
          return;
      }


      try {
          const apiUrl = `http://127.0.0.1:8000/api/reports/export-sales?type=${reportType}&start_date=${startDate}&end_date=${endDate}`;

          // Ensure token is defined and accessible (assuming it's globally available as 'token')
          if (typeof token === 'undefined' || !token) {
               throw new Error("Authentication token is missing.");
          }

          const response = await fetch(apiUrl, {
              headers: { 
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json' // Crucial for API to know we want JSON
              }
          });

          if (!response.ok) {
              let errorMsg = `Failed to fetch report data (Status: ${response.status})`;
              try {
                  // Attempt to parse server error message
                  const errData = await response.json(); 
                  errorMsg = errData.message || errData.error || errorMsg; 
              } catch (e) { 
                  // If response is not JSON, use the status text
                  errorMsg = `${errorMsg} - ${response.statusText}`;
              }
              throw new Error(errorMsg);
          }

          // Check content type BEFORE parsing as JSON
          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
             // If the server didn't send JSON (e.g., HTML error page), handle it
             const textResponse = await response.text(); // Get raw response
             console.error("Non-JSON response received:", textResponse);
             throw new Error(`Server returned unexpected content type: ${contentType}. Check server logs.`);
          }


          const data = await response.json();

          // Check if data is specifically an empty array (valid response but no results)
          if (Array.isArray(data) && data.length === 0) {
               // Assuming showToast is defined elsewhere
               // showToast('No data found for the selected criteria.', 'info'); 
               // Do not close modal - let user change dates
          } else if (!data || (Array.isArray(data) && data.length > 0 && !data[0])) { // Improved check for invalid data
               // Assuming showToast is defined elsewhere
               // showToast('Received invalid data structure from server.', 'error');
               console.error("Invalid data structure received:", data);
          }
           else {
              // --- Generate Excel file with better formatting ---
              const ws = XLSX.utils.json_to_sheet(data);

              // Calculate column widths
              const colWidths = [];
               // Check if data[0] exists before trying to get keys
               if (data[0]) {
                   const header = Object.keys(data[0]); // Get header names from the first data row
                   header.forEach((h, index) => {
                       let maxLen = h.length; // Start with header length
                       data.forEach(row => {
                           const cellValue = row[h];
                           // Ensure cellValue is treated as a string for length check, handle null/undefined
                           const cellLen = cellValue !== null && cellValue !== undefined ? String(cellValue).length : 0;
                           if (cellLen > maxLen) {
                               maxLen = cellLen;
                           }
                       });
                       colWidths[index] = { wch: maxLen + 2 }; // Add a little padding
                   });
                   ws['!cols'] = colWidths; // Apply widths to worksheet
               } else {
                   console.warn("Cannot calculate column widths: No data rows returned (but not an empty array).");
               }


              // Add AutoFilter to the header row only if there's data and a range
               if (ws['!ref']) { // Check if worksheet has a range defined
                   ws['!autofilter'] = { ref: XLSX.utils.encode_range(XLSX.utils.decode_range(ws['!ref'])) };
               }

              const wb = XLSX.utils.book_new();
              XLSX.utils.book_append_sheet(wb, ws, 'Sales Report');

              const fileName = `EasePrint_Sales_${reportType}_${startDate}_to_${endDate}.xlsx`;
              XLSX.writeFile(wb, fileName);

               // Assuming showToast is defined elsewhere
               // showToast('Report generated successfully!', 'success'); // Feedback
              closeExportModal(); // Close modal on success
          }

      } catch (error) {
          console.error('Report generation failed:', error);
          // Assuming showToast is defined elsewhere
          // showToast(`Error: ${error.message}`, 'error');
      } finally {
          // Ensure button is re-enabled regardless of outcome
          if (generateBtn) {
              generateBtn.disabled = false;
              // Restore original button content with icon
              generateBtn.innerHTML = '<i data-lucide="download" class="h-4 w-4"></i> Generate Report';
              if (typeof lucide !== 'undefined') {
                lucide.createIcons(); // Re-render the icon
              }
          }
      }
  }


  // --- Consolidated DOMContentLoaded listener ---
  document.addEventListener('DOMContentLoaded', () => {
      // --- Initialize Flatpickr Date Pickers FIRST ---
      try {
          fpStartDateInstance = flatpickr("#exportStartDate", {
              dateFormat: "Y-m-d",
              disableMobile: true, // Recommended for desktop consistency
              onChange: function(selectedDates, dateStr, instance) {
                  // When start date changes, set the minimum date for the end date picker
                  if (fpEndDateInstance && selectedDates[0]) {
                      fpEndDateInstance.set('minDate', selectedDates[0]);
                  }
              }
          });
          
          fpEndDateInstance = flatpickr("#exportEndDate", {
              dateFormat: "Y-m-d",
              disableMobile: true, // Recommended for desktop consistency
              maxDate: "today", // Prevent selecting future dates
              onChange: function(selectedDates, dateStr, instance) {
                  // When end date changes, set the maximum date for the start date picker
                  if (fpStartDateInstance && selectedDates[0]) {
                      fpStartDateInstance.set('maxDate', selectedDates[0]);
                  }
              }
          });
          console.log("Flatpickr initialized successfully.");
      } catch (e) {
          console.error("Error initializing Flatpickr:", e);
      }

      // --- Export Report Listeners ---
      const exportBtn = document.getElementById('exportReportBtn');
      if (exportBtn) {
          exportBtn.addEventListener('click', openExportModal);
      } else {
          console.error("Export button (#exportReportBtn) not found!");
      }

      const exportForm = document.getElementById('exportReportForm');
      if (exportForm) {
          exportForm.addEventListener('submit', handleReportGeneration);
      } else {
           console.error("Export form (#exportReportForm) not found!");
      }

      // --- Other initializers (Keep relevant ones for the full page context) ---
      // Example: If dashboard elements exist:
      const homeElement = document.getElementById('home');
      if (homeElement && !homeElement.classList.contains('hidden')) {
          // updateDashboard(); // Call dashboard update if needed
      }
      // initializeCalendar(); // Initialize mini calendar if needed
      // updateClock(); // Set initial clock time if needed
      // setInterval(updateClock, 1000); // Update clock every second if needed
      
      // Add other listeners from your consolidated block if they exist on this page
      // e.g., Appointments, Login Form, Global Enter Key, etc.

  }); // --- END OF DOMContentLoaded ---
// <!-- ================================================================== -->
// <!-- ==================== END  EXPORT REPORT      ===================== -->
// <!-- ================================================================== -->

// <!-- ================================================================== -->
// <!-- ==================== ANALYTICS         SCRIPT ===================== -->
// <!-- ================================================================== -->
// Global chart instances to prevent duplicates
let salesTrendChartInstance = null;
let earningsChartInstance = null;
let salesByCategoryChartInstance = null;
let isAnalyticsInitialized = false;

function initializeAnalyticsCharts() {
    // This function runs only once to set up the charts and event listeners.
    if (isAnalyticsInitialized) {
        updateAnalyticsData(); // If already set up, just refresh the data.
        return;
    }

    const salesPeriodSelector = document.getElementById('salesPeriod');
    if (salesPeriodSelector) {
        salesPeriodSelector.addEventListener('change', updateAnalyticsData);
    }

    setupAllCharts(); // Create the empty chart canvases.
    isAnalyticsInitialized = true;
}

async function setupAllCharts() {
    // This function creates the chart instances with their initial configurations.

    // 1. Sales Trend Line Chart
    const salesCtx = document.getElementById('salesTrendChart')?.getContext('2d');
    if (salesCtx) {
        if (salesTrendChartInstance) salesTrendChartInstance.destroy();
        salesTrendChartInstance = new Chart(salesCtx, {
            type: 'line',
            data: { labels: [], datasets: [] }, // Initially empty
            options: { // Consistent options
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8 } },
                    tooltip: { mode: 'index', intersect: false, backgroundColor: '#fff', titleColor: '#333', bodyColor: '#666', borderColor: '#ddd', borderWidth: 1, padding: 10, cornerRadius: 8, displayColors: true }
                },
                scales: {
                    y: { beginAtZero: true, grid: { drawBorder: false }, ticks: { callback: value => `₱${value.toFixed(0)}` } },
                    x: { grid: { display: false } }
                },
                elements: {
                     line: { tension: 0.3 } // Smooth lines
                }
            }
        });
    }

    // 2. Earnings Donut Chart
    const earningsCtx = document.getElementById('earningsChart')?.getContext('2d');
    if (earningsCtx) {
        if (earningsChartInstance) earningsChartInstance.destroy();
        earningsChartInstance = new Chart(earningsCtx, {
            type: 'doughnut',
            data: { labels: ['Offline', 'Online'], datasets: [] }, // Set labels initially
            options: { // Consistent options
                 responsive: true,
                 cutout: '75%',
                 plugins: {
                     legend: { display: false }, // Using custom legend div
                     tooltip: {
                        enabled: true,
                        callbacks: { // Format tooltip to show currency
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'PHP' }).format(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                 }
            }
        });
    }

    // 3. Sales by Category Bar Chart
    const categoryCtx = document.getElementById('salesByCategoryChart')?.getContext('2d');
    if (categoryCtx) {
        if (salesByCategoryChartInstance) salesByCategoryChartInstance.destroy();
        salesByCategoryChartInstance = new Chart(categoryCtx, {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: { // Consistent options
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                     tooltip: {
                        callbacks: { // Format tooltip to show currency
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                     label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'PHP' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                     y: { beginAtZero: true, grid: { drawBorder: false }, ticks: { callback: value => `₱${value.toFixed(0)}`, precision: 0 } }, // Currency format
                     x: { grid: { display: false } }
                }
            }
        });
    }

    await updateAnalyticsData(); // Load the initial data into the chart structures.
}

async function updateAnalyticsData() {
    const period = document.getElementById('salesPeriod')?.value || 'month';
    const apiHeaders = { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' };

    try {
        // Fetch data from the specific report endpoints
        const [
            salesTrendsRes,
            earningsBreakdownRes,
            salesByCategoryRes
        ] = await Promise.all([
            fetch(`http://127.0.0.1:8000/api/reports/sales-trends?period=${period}`, { headers: apiHeaders }),
            fetch('http://127.0.0.1:8000/api/reports/earnings-breakdown', { headers: apiHeaders }),
            fetch('http://127.0.0.1:8000/api/reports/sales-by-category', { headers: apiHeaders })
        ]);

        // Check responses
        if (!salesTrendsRes.ok) throw new Error(`Failed to fetch sales trends: ${salesTrendsRes.statusText}`);
        if (!earningsBreakdownRes.ok) throw new Error(`Failed to fetch earnings breakdown: ${earningsBreakdownRes.statusText}`);
        if (!salesByCategoryRes.ok) throw new Error(`Failed to fetch sales by category: ${salesByCategoryRes.statusText}`);

        // Convert responses to JSON
        const salesTrendsData = await salesTrendsRes.json();
        const earningsBreakdownData = await earningsBreakdownRes.json();
        const salesByCategoryData = await salesByCategoryRes.json();

        // --- 1. Update Sales Trend (Line Chart) ---
        if (salesTrendChartInstance) {
            const validTrendsData = Array.isArray(salesTrendsData) ? salesTrendsData : [];
            const labels = validTrendsData.map(entry => entry.period); // Use 'period' field from controller
            const data = validTrendsData.map(entry => entry.total_sales); // Use 'total_sales' field from controller

            salesTrendChartInstance.data.labels = labels;
            salesTrendChartInstance.data.datasets = [{
                label: 'Total Sales', data: data, borderColor: '#EF534F',
                backgroundColor: 'rgba(239, 83, 79, 0.1)', tension: 0.3, fill: true, pointBackgroundColor: '#EF534F', pointRadius: 3, pointHoverRadius: 5
            }];
            salesTrendChartInstance.update();
        }

        // --- 2. Update Earnings Breakdown (Doughnut Chart) ---
        if (earningsChartInstance) {
            // Data structure from controller: { "Offline": value, "Online": value }
            const offlineTotal = earningsBreakdownData?.Offline ?? 0;
            const onlineTotal = earningsBreakdownData?.Online ?? 0;
            const total = Number(offlineTotal) + Number(onlineTotal);

            earningsChartInstance.data.datasets = [{
                 data: [offlineTotal, onlineTotal], backgroundColor: ['#4A90E2', '#F5A623'], borderWidth: 0, hoverOffset: 4
            }];
            // Labels are already set in setupAllCharts
            earningsChartInstance.update();

            // Update DOM elements for legend and total
            const earningsTotalEl = document.getElementById('earningsTotal');
            if (earningsTotalEl) earningsTotalEl.textContent = `₱${total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            const offlineEarningsEl = document.getElementById('offlineEarnings');
            if (offlineEarningsEl) offlineEarningsEl.textContent = `₱${Number(offlineTotal).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            const onlineEarningsEl = document.getElementById('onlineEarnings');
             if (onlineEarningsEl) onlineEarningsEl.textContent = `₱${Number(onlineTotal).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // --- 3. Update Sales by Category (Bar Chart) ---
        if (salesByCategoryChartInstance) {
            // Data structure from controller: [{ product_category: "Name", total_sales_value: value }, ...]
             const validCategoryData = Array.isArray(salesByCategoryData) ? salesByCategoryData : [];
             const labels = validCategoryData.map(entry => entry.product_category); // Use 'product_category'
             const data = validCategoryData.map(entry => entry.total_sales_value); // Use 'total_sales_value'

            salesByCategoryChartInstance.data = {
                labels: labels,
                datasets: [{
                    label: 'Total Sales (₱)',
                    data: data,
                    backgroundColor: 'rgba(239, 83, 79, 0.7)', // Primary color with opacity
                    borderColor: '#EF534F', // Primary color solid
                    borderWidth: 1, borderRadius: 4, barThickness: 'flex', maxBarThickness: 40 // Make bars flexible but limit max width
                }]
            };
            // Y-axis ticks are configured in setupAllCharts
            salesByCategoryChartInstance.update();
        }

    } catch (error) {
        // Handle any errors during data update
        console.error('Analytics update error:', error);
        // Optionally show a toast or error message in the UI
        // Example: showToast(`Error updating analytics: ${error.message}`, 'error');
        // Fallback UI states (optional, could show 'Error' in charts)
        if (salesTrendChartInstance) { /* Clear or show error */ }
        if (earningsChartInstance) { /* Clear or show error */ }
        if (salesByCategoryChartInstance) { /* Clear or show error */ }
    }
}

// <!-- ================================================================== -->
// <!-- ==================== END OF ANALYTICS SCRIPT ===================== -->
// <!-- ================================================================== -->


  const API_URL = "http://localhost:8000/api/custom-shirts"; // Laravel API

    async function fetchRequests() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        const tbody = document.getElementById("requestsBody");
        tbody.innerHTML = "";

        const filterValue = document.getElementById("statusFilter").value;

        const filteredData = filterValue === "All"
          ? data
          : data.filter(req => req.status === filterValue);

        if (filteredData.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center py-6">No ${filterValue} requests found.</td></tr>`;
          return;
        }

        filteredData.forEach(req => {
            // UI UPDATE: This section is heavily modified to fit the new table structure.
            const row = document.createElement("tr");
            
            // Status Badge Logic
            let statusBadge = '';
            switch(req.status.toLowerCase()) {
                case 'approved':
                    statusBadge = `<span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Approved</span>`;
                    break;
                case 'rejected':
                    statusBadge = `<span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>`;
                    break;
                default:
                    statusBadge = `<span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>`;
            }

            // Action Buttons Logic
            let actionButtons = '—'; // Default for non-pending
            if (req.status === 'Pending') {
                actionButtons = `
                    <button onclick="approveRequest(${req.id})" class="px-3 py-1 text-xs font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Approve</button>
                    <button onclick="rejectRequest(${req.id})" class="px-3 py-1 text-xs font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Reject</button>
                `;
            }

            row.innerHTML = `
                <td class="px-6 py-6 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${req.full_name}</div>
                    <div class="text-sm text-gray-500">${req.email}</div>
                    <div class="text-sm text-gray-500">${req.phone}</div>
                </td>
                <td class="px-6 py-6 whitespace-nowrap">
                    <div class="flex items-center text-sm">
                        ${req.design ? `<a href="http://localhost:8000/storage/${req.design}" target="_blank" class="font-medium text-indigo-600 hover:text-indigo-800 flex items-center gap-1"><i data-feather="eye" class="w-4 h-4"></i> View</a>` : '<span>No Design</span>'}
                        <span class="mx-2 text-gray-300">|</span>
                        <div>Size: <span class="font-semibold">${req.size}</span></div>
                        <span class="mx-2 text-gray-300">|</span>
                        <div>Qty: <span class="font-semibold">${req.quantity}</span></div>
                    </div>
                </td>
                <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-600 max-w-xs truncate">${req.notes || ''}</td>
                <td class="px-6 py-6 whitespace-nowrap">${statusBadge}</td>
                <td class="px-6 py-6 whitespace-nowrap">
                    <input type="text" id="note-${req.id}" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Add a note..." value="${req.admin_note || ''}">
                </td>
                <td class="px-6 py-6 whitespace-nowrap text-sm font-medium space-x-2">${actionButtons}</td>
            `;
            tbody.appendChild(row);
        });
        feather.replace(); // Re-initialize icons after drawing table
      } catch (err) {
        console.error("Error fetching requests:", err);
      }
    }

    async function approveRequest(id) {
      const note = document.getElementById(`note-${id}`).value;
      await fetch(`${API_URL}/${id}/approve`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ admin_note: note })
      });
      fetchRequests();
    }

    async function rejectRequest(id) {
      const note = document.getElementById(`note-${id}`).value;
      await fetch(`${API_URL}/${id}/reject`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ admin_note: note })
      });
      fetchRequests();
    }

    fetchRequests();
    




  const API_BASE = 'http://localhost:8000/api';

const appointmentsTbody = document.querySelector('#appointmentsTbl tbody');
const appointmentsStatusFilter = document.getElementById('appointmentsStatusFilter');

function originOf(url) { 
  try { return new URL(url).origin; } 
  catch { return ''; } 
}

function fileUrl(path) { 
  return `${originOf(API_BASE)}/storage/${path}`; 
}

async function loadAppointments() {
  const query = appointmentsStatusFilter.value ? `?status=${appointmentsStatusFilter.value}` : '';
  const res = await fetch(`${API_BASE}/appointments${query}`);
  const json = await res.json();
  const items = json.data || json;
  appointmentsTbody.innerHTML = '';

  if (items.length === 0) {
      appointmentsTbody.innerHTML = `<tr><td colspan="6" class="text-center py-6">No appointments found.</td></tr>`;
      return;
  }

  items.forEach(a => {
    // UI UPDATE: This section is heavily modified to fit the new table structure.
    const tr = document.createElement('tr');

    // Status Badge Logic
    let statusBadge = '';
    switch(a.status.toLowerCase()) {
        case 'approved':
            statusBadge = `<span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Approved</span>`;
            break;
        case 'rejected':
            statusBadge = `<span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>`;
            break;
        default:
            statusBadge = `<span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Pending</span>`;
    }

    // Action Buttons Logic
    let actionButtons = '—'; // Default for non-pending
    if (a.status === 'pending') {
        actionButtons = `
            <button onclick="approveAppointment(${a.id})" class="px-3 py-1 text-xs font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Approve</button>
            <button onclick="rejectAppointment(${a.id})" class="px-3 py-1 text-xs font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Reject</button>
        `;
    }

    tr.innerHTML = `
        <td class="px-6 py-6 whitespace-nowrap text-sm font-medium text-gray-900">${a.full_name}</td>
        <td class="px-6 py-6 whitespace-nowrap">
            <div class="text-sm text-gray-500">${a.email}</div>
            <div class="text-sm text-gray-500">${a.phone}</div>
        </td>
        <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-500">${new Date(a.schedule_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
        <td class="px-6 py-6 whitespace-nowrap">${statusBadge}</td>
        <td class="px-6 py-6 whitespace-nowrap text-sm font-medium">
           <div class="flex items-center space-x-3">
               ${a.qr_code_path ? `<a href="${fileUrl(a.qr_code_path)}" target="_blank" class="text-indigo-600 hover:text-indigo-900">QR</a>` : ''}
               ${a.pdf_path ? `<a href="${fileUrl(a.pdf_path)}" target="_blank" class="text-indigo-600 hover:text-indigo-900">PDF</a>` : ''}
           </div>
        </td>
        <td class="px-6 py-6 whitespace-nowrap text-sm font-medium space-x-2">${actionButtons}</td>
    `;
    appointmentsTbody.appendChild(tr);
  });
}

async function approveAppointment(id) {
  try {
    const response = await fetch(`http://127.0.0.1:8000/api/appointments/${id}/approve`, {
      method: 'PUT',   // ✅ match Laravel route
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      }
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      console.error("Server error:", errorData);
      showToast(`Failed: ${errorData.message || 'Something went wrong.'}`);
      return;
    }

    const data = await response.json();
    console.log("✅ Appointment approved:", data);

    showToast(`✅ ${data.message}\n📄 PDF: ${data.pdf_url}\n🔗 QR: ${data.qr_url}`);

    // reload table after approve
    loadAppointments();

  } catch (err) {
    console.error("Request failed:", err);
    showToast("❌ Could not connect to server. Please try again.");
  }
}

async function rejectAppointment(id) {
  if (!confirm('Reject this appointment?')) return;
  const res = await fetch(`${API_BASE}/appointments/${id}/reject`, { method: 'PUT' });
  let msg = 'Rejected.';
  if (!res.ok) {
    const j = await res.json().catch(()=>({message:'Failed'}));
    msg = 'Error: ' + (j.message || res.status);
  }
  showToast(msg);
  loadAppointments();
}

// <!-- ================================================================== -->
// <!-- ====================   ORDERS SCRIPT     ======================= -->
// <!-- ================================================================== -->

// Orders
async function fetchOrders() {
    const ordersTableBody = document.querySelector('#ordersTable tbody');
    // **UPDATE:** Increased colspan from 8 to 9
    ordersTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-6">Loading orders...</td></tr>';

    try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch('http://127.0.0.1:8000/api/admin/orders', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Fetched orders:", data);

        if (!Array.isArray(data)) {
             console.error("Fetched data is not an array:", data);
             // **UPDATE:** Increased colspan from 8 to 9
             ordersTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-6">Error: Invalid data format received.</td></tr>';
             return;
        }


        if (data.length === 0) {
            // **UPDATE:** Increased colspan from 8 to 9
            ordersTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-6">No orders found.</td></tr>';
            return;
        }

        // **UPDATE:** Add "Payment Proof" header
        const thead = document.querySelector('#ordersTable thead tr');
        thead.innerHTML = `
            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Proof</th> <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        `;

        ordersTableBody.innerHTML = ''; // Clear loading state
        data.forEach(order => {
            // STATUS BADGE LOGIC (no changes needed)
            let statusBadge;
            const normalizedStatus = (order.status || 'pending').toLowerCase(); // Default to pending if null/undefined
            switch (normalizedStatus) {
                case 'approved':
                    statusBadge = `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Approved</span>`;
                    break;
                case 'rejected':
                    statusBadge = `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>`;
                    break;
                case 'for_verification': // Added this status
                     statusBadge = `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">For Verification</span>`;
                     break;
                default: // Handles 'pending' and any other unexpected values
                    statusBadge = `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending Payment</span>`;
            }


            // FORMAT CREATED_AT DATE (no changes needed)
            const createdAt = new Date(order.created_at).toLocaleString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });

            // FORMAT ITEMS (no changes needed)
            // Ensure order.items is an array and each item has product.name
             const items = Array.isArray(order.items)
                ? order.items.map(i => `${i.product?.name || 'Unknown Product'} x${i.quantity}`).join('<br>')
                : 'N/A';


            // **UPDATE:** Add logic for Payment Proof link
            let paymentProofHtml = '<span class="text-gray-400">N/A</span>';
            if (order.payment_screenshot_path) {
                // Assuming your Laravel backend serves storage files correctly via the symlink
                const screenshotUrl = `http://127.0.0.1:8000/storage/${order.payment_screenshot_path}`;
                 paymentProofHtml = `
                    <a href="${screenshotUrl}" target="_blank" class="font-medium text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
                        <i data-feather="image" class="w-4 h-4"></i> View
                    </a>
                    <div class="text-xs text-gray-500 mt-1">Ref: ${order.payment_reference_no || 'None'}</div>`; // Also show ref number
            } else if (normalizedStatus === 'for_verification') {
                 // If status is for_verification but somehow path is missing
                 paymentProofHtml = '<span class="text-red-500 text-xs">Missing Proof</span>';
            }


            // ACTIONS LOGIC
            let actions = '';
            // Allow approve/reject only if status is 'for_verification'
             if (normalizedStatus === 'for_verification') {
                 actions += `
                    <button onclick="updateOrderStatus(${order.id}, 'Approved')" class="inline-flex items-center gap-2 px-4 py-2 text-xs font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">
                        <i data-feather="check" class="w-4 h-4"></i> Approve Payment
                    </button>
                    <button onclick="updateOrderStatus(${order.id}, 'Rejected')" class="inline-flex items-center gap-2 px-4 py-2 text-xs font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 mt-1">
                        <i data-feather="x" class="w-4 h-4"></i> Reject Payment
                    </button>
                `;
            } else if (normalizedStatus === 'approved' || normalizedStatus === 'rejected') {
                // If already approved or rejected, show the status clearly, maybe allow reverting?
                actions += `
                     <span class="text-xs font-semibold ${normalizedStatus === 'approved' ? 'text-green-700' : 'text-red-700'}">
                        Payment ${normalizedStatus.charAt(0).toUpperCase() + normalizedStatus.slice(1)}
                    </span>
                    `;
            } else {
                 // For 'pending_payment' or other statuses
                 actions += '<span class="text-xs text-gray-400">Awaiting Payment</span>';
            }


            // Add delete button regardless of status
            actions += `
                <button onclick="deleteOrder(${order.id})" class="inline-flex items-center justify-center p-2 text-gray-500 bg-gray-100 rounded-lg hover:bg-red-100 hover:text-red-600 ml-2 mt-1" title="Delete Order">
                     <i data-feather="trash-2" class="w-4 h-4"></i>
                 </button>
            `;


            // **UPDATE:** Added the new paymentProofHtml cell
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-6 whitespace-nowrap">
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-900">${order.order_id}</span>
                        <button onclick="copyOrderId('${order.order_id}', this)" class="ml-2 text-gray-400 hover:text-blue-600" title="Copy ID">
                            <i data-feather="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                </td>
                <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-800">${order.delivery_name ?? order.user?.name ?? 'Unknown'}</td>
                <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-500">${order.delivery_phone ?? 'N/A'}</td>
                <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-900 font-semibold">₱${parseFloat(order.total || 0).toFixed(2)}</td>
                <td class="px-6 py-6 text-sm text-gray-500">${items}</td>
                <td class="px-6 py-6 whitespace-nowrap text-sm">${paymentProofHtml}</td> <td class="px-6 py-6 whitespace-nowrap">${statusBadge}</td>
                <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-500">${createdAt}</td>
                <td class="px-6 py-6 whitespace-nowrap text-sm font-medium space-y-1">${actions}</td>
            `;
            ordersTableBody.appendChild(row);
        });

        // RE-INITIALIZE FEATHER ICONS AFTER ROWS ARE ADDED
        feather.replace();

    } catch (error) {
        console.error("Error fetching orders:", error);
        // **UPDATE:** Increased colspan from 8 to 9
        ordersTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-6 text-red-500">Error loading orders: ${error.message}</td></tr>`;
    }
}


// UPDATED COPY FUNCTION FOR FEATHER ICONS
function copyOrderId(orderId, btn) {
    navigator.clipboard.writeText(orderId)
        .then(() => {
            showToast(`Order ID ${orderId} copied`, "success");
            
            const originalIconHTML = btn.innerHTML;
            btn.innerHTML = `<i data-feather="check" class="w-4 h-4 text-green-500"></i>`;
            feather.replace(); // Render the new 'check' icon

            setTimeout(() => {
                btn.innerHTML = originalIconHTML;
                feather.replace(); // Render the original 'copy' icon
            }, 1500);
        })
        .catch(err => {
            console.error("Failed to copy Order ID:", err);
            showToast("Failed to copy Order ID", "error");
        });
}

// THIS IS YOUR EXISTING TOAST FUNCTION, UNCHANGED
// Add this new function near the top of your script
function showToast(message, type = 'success') {
    const toastElement = document.getElementById('toast-notification');
    const toastMessage = document.getElementById('toast-message');

    if (!toastElement || !toastMessage) {
        console.error('Toast elements not found.');
        return;
    }

    // Set message
    toastMessage.textContent = message;

    // Apply styles based on type
    if (type === 'error') {
        toastElement.style.backgroundColor = '#b91c1c'; // Red for error
    } else {
        toastElement.style.backgroundColor = '#1f2937'; // Default dark
    }

    // Show toast
    toastElement.classList.add('toast-active');
    
    // Hide after 3 seconds
    setTimeout(() => {
        toastElement.classList.remove('toast-active');
    }, 3000);
}

// You can now delete the old "showToast" and "showTrackingToast" functions

// THIS IS YOUR EXISTING UPDATEORDERSTATUS FUNCTION, UNCHANGED
async function updateOrderStatus(orderId, status) {
  try {
    const token = localStorage.getItem('adminToken'); 
    const response = await fetch(`http://127.0.0.1:8000/api/admin/orders/${orderId}/status`, {
      method: 'PUT',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}` 
      },
      body: JSON.stringify({ status })
    });

    if (response.ok) {
      const data = await response.json();
      const order = data.order;

      showToast(`Order ${order.order_id} marked as ${status}`, "success");

      const message = `Hello ${order.delivery_name ?? order.user?.name ?? 'Customer'}, your order ${order.order_id} has been ${status}.`;
      if (order.delivery_phone) {
        
        // --- START OF UPDATED SMS LOGIC ---
        try {
          // Add 'await' and get the 'result'
          const smsResult = await window.electronAPI.sendSMS(order.delivery_phone, message);
          
          if (smsResult.success) {
            console.log(`Main process confirmed SMS sent to ${smsResult.phone}`);
          } else {
            console.error(`Main process reported SMS error: ${smsResult.error}`);
          }
        } catch (smsError) {
          console.error('Failed to invoke SMS bridge:', smsError);
        }
        // --- END OF UPDATED SMS LOGIC ---

      } else {
        console.warn('No phone number found for this order.');
      }

      fetchOrders();
    } else {
      console.error("Failed to update order status");
      showToast("Error updating order status", "error");
    }
  } catch (error) {
    if (error.response) {
      console.error("API response error:", error.response);
    } else if (error.request) {
      console.error("No response from API:", error.request);
    } else {
      console.error("Error in request setup:", error.message);
    }
    showToast("Something went wrong while updating status.", "error");
  }
}

// THIS IS YOUR EXISTING HANDLEEDITSTATUS FUNCTION, UNCHANGED
function handleEditStatus(orderId, newStatus) {
  if (!newStatus) return;
  updateOrderStatus(orderId, newStatus);
}

// THIS IS YOUR EXISTING DELETEORDER FUNCTION, UNCHANGED
async function deleteOrder(orderId) {
  // Grab the order_id from the table row for nicer message
  const row = document.querySelector(`#ordersTable tbody tr button[onclick="deleteOrder(${orderId})"]`)?.closest('tr');
  const orderCode = row?.querySelector('td span')?.textContent || orderId;

  if (!confirm(`Are you sure you want to delete Order ${orderCode}?`)) return;

  try {
    const token = localStorage.getItem('adminToken'); 
    const response = await fetch(`http://127.0.0.1:8000/api/admin/orders/${orderId}`, {
      method: 'DELETE',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}` 
      },
    });

    if (response.ok) {
      showToast(`Order ${orderCode} has been deleted`, "success");
      fetchOrders();
    } else {
      console.error("Failed to delete order");
      showToast("Error deleting order", "error");
    }
  } catch (error) {
    console.error("Error deleting order:", error);
    showToast("Something went wrong while deleting the order", "error");
  }
}

// Auto-load
document.addEventListener('DOMContentLoaded', () => {
  fetchOrders();
});



// APPOINTMENTS SYSTE
document.getElementById('appointmentsReloadBtn').addEventListener('click', loadAppointments);
appointmentsStatusFilter.addEventListener('change', loadAppointments);

loadAppointments();


// Enable Enter key to submit forms properly
document.addEventListener('keydown', function(event) {
    if (event.key === "Enter") {
      const active = document.activeElement;

      // Product form
      if (active.closest("#productForm")) {
        event.preventDefault();
        document.getElementById("productForm").dispatchEvent(new Event("submit"));
      }

      // Edit form
      if (active.closest("#editForm")) {
        event.preventDefault();
        document.getElementById("editForm").dispatchEvent(new Event("submit"));
      }

      // Transactions form
      if (active.closest("#transactions")) {
        event.preventDefault();
        submitTransaction();
      }

      // Chat
      if (active.closest("#chat")) {
        event.preventDefault();
        sendMessage();
      }
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
  const loginForm = document.getElementById("loginForm");
  if (loginForm) {
    loginForm.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("loginBtn").click();
      }
    });
  }
});


// TRACKING SYSTEM
async function initializeTracking() {
    // --- DATA & CONFIGURATION ---
    const STAGES = ['Approved', 'Preparing', 'Shipment', 'Shipped Out', 'On Delivery', 'Delivered'];
    const STAGE_ICONS = {
        'Approved': 'check-circle-2', 'Preparing': 'package-search', 'Shipment': 'truck',
        'Shipped Out': 'send', 'On Delivery': 'map-pin', 'Delivered': 'home'
    };
    let orders = [];

    // --- DOM ELEMENTS ---
    const trackingSection = document.getElementById('tracking-section');
    const toastElement = document.getElementById('toast-notification');
    const toastMessage = document.getElementById('toast-message');

    // --- FUNCTIONS ---

    // ADDED: Helper function to format the timestamp string.
    const formatOrderTimestamp = (isoString) => {
        if (!isoString) return 'Not available';
        const date = new Date(isoString);
        const options = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        };
        return date.toLocaleString('en-US', options);
    };

    const showTrackingToast = (message) => {
        toastMessage.textContent = message;
        toastElement.classList.add('toast-active');
        setTimeout(() => {
            toastElement.classList.remove('toast-active');
        }, 3000);
    };

    const updateTrackerUI = (orderCard, currentStage) => {
        const currentStageIndex = STAGES.indexOf(currentStage);
        const steps = orderCard.querySelectorAll('.progress-step');
        steps.forEach((step, index) => {
            step.classList.remove('current', 'completed', 'tracking-pending');
            
            if (index < currentStageIndex) {
                step.classList.add('completed');
            } else if (index === currentStageIndex) {
                step.classList.add('current');
            } else {
                step.classList.add('tracking-pending');
            }
        });
        
        const dropdown = orderCard.querySelector('.stage-select');
        const nextButton = orderCard.querySelector('.next-stage-btn');
        const doneButton = orderCard.querySelector('.done-btn');
        const isDelivered = currentStage === 'Delivered';
        const isAtFinalAdminStage = currentStage === 'On Delivery';

        if (dropdown) {
            dropdown.value = currentStage;
            dropdown.disabled = isDelivered;
        }
        if (nextButton) {
            nextButton.disabled = isAtFinalAdminStage || isDelivered;
        }
        if(doneButton){
            doneButton.disabled = currentStage !== 'On Delivery';
        }
    };

    const renderOrders = () => {
        trackingSection.innerHTML = '';
        if (orders.length === 0) {
            trackingSection.innerHTML = `<p style="text-align: center; color: #6b7280;">No approved orders to track at the moment.</p>`;
            return;
        }
        orders.forEach(order => {
            const orderCard = document.createElement('div');
            orderCard.className = 'tracking-order-card';
            orderCard.dataset.orderDbId = order.id;
            orderCard.dataset.orderPublicId = order.orderId;
            // MODIFIED: Updated text, class, and used the new formatting function.
            orderCard.innerHTML = `
                <div class="tracking-header">
                    <div>
                        <h2 class="tracking-order-id">${order.orderId}</h2>
                        <p class="tracking-customer-name">Customer: ${order.customerName}</p>
                        <p class="tracking-item-name">Item(s): <strong>${order.items}</strong></p>
                        <p class="tracking-total-amount">Total: <strong>₱${parseFloat(order.total).toFixed(2)}</strong></p>
                        <p class="tracking-timestamp">Created order time: ${formatOrderTimestamp(order.createdAt)}</p>
                    </div>
                    <div class="tracking-actions">
    <button class="done-btn bg-green-500 text-white px-5 py-3 rounded-md text-xs hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-1">
        <i data-feather="check-circle" class="w-4 h-4"></i>
        Done
    </button>

    <select class="stage-select">
        ${STAGES.map(stage => `<option value="${stage}" ${order.currentStage === stage ? 'selected' : ''}>${stage}</option>`).join('')}
    </select>

    <button class="next-stage-btn bg-blue-500 text-white px-5 py-3 rounded-md text-xs hover:bg-blue-600 flex items-center gap-1">
        <i data-feather="arrow-right-circle" class="w-5 h-5"></i>
        Next Stage
    </button>
</div>

                </div>
                <div class="progress-tracker-container">
                    ${STAGES.map(stage => `
                        <div class="progress-step" data-stage="${stage}">
                            <div class="status-icon">
                                <i data-lucide="${STAGE_ICONS[stage]}" style="width:20px; height:20px;"></i>
                            </div>
                            <p class="status-text">${stage}</p>
                        </div>`).join('')}
                </div>`;
            trackingSection.appendChild(orderCard);
            updateTrackerUI(orderCard, order.currentStage);
        });
        lucide.createIcons();
    };

    const updateOrderStatusAPI = async (orderDbId, newStage) => {
        console.log(`🚀 API Request: Updating order ${orderDbId} to "${newStage}"...`);
        try {
            const res = await fetch(`http://127.0.0.1:8000/api/tracking/orders/${orderDbId}/tracking-stage`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ tracking_stage: newStage })
            });
            if (!res.ok) throw new Error('API update failed');
            console.log('✅ API Update Successful');
            return true;
        } catch (error) {
            console.error('❌ API Update Failed:', error);
            return false;
        }
    };
    
    // --- EVENT LISTENERS ---
    trackingSection.addEventListener('click', async (event) => {
        if (event.target.classList.contains('next-stage-btn')) {
            const button = event.target;
            const orderCard = button.closest('.tracking-order-card');
            const orderDbId = orderCard.dataset.orderDbId;
            const order = orders.find(o => o.id == orderDbId);
            const currentStageIndex = STAGES.indexOf(order.currentStage);
            
            if (currentStageIndex < STAGES.indexOf('On Delivery')) {
                const newStage = STAGES[currentStageIndex + 1];
                button.disabled = true;
                const success = await updateOrderStatusAPI(order.id, newStage);
                if (success) {
                    order.currentStage = newStage;
                    updateTrackerUI(orderCard, newStage);
                    showTrackingToast(`Order ${order.orderId} moved to ${newStage}.`);
                } else {
                    showTrackingToast(`Failed to update ${order.orderId}.`);
                    button.disabled = false;
                }
            }
        }
        
        if (event.target.classList.contains('done-btn')) {
            const button = event.target;
            const orderCard = button.closest('.tracking-order-card');
            const orderDbId = orderCard.dataset.orderDbId;
            const order = orders.find(o => o.id == orderDbId);
            const newStage = 'Delivered';
             if (confirm(`Mark order ${order.orderId} as Delivered? This action cannot be undone.`)) {
                button.disabled = true;
                const success = await updateOrderStatusAPI(order.id, newStage);
                 if (success) {
                    order.currentStage = newStage;
                    updateTrackerUI(orderCard, newStage);
                    showTrackingToast(`Order ${order.orderId} has been marked as Delivered.`);
                } else {
                    showTrackingToast(`Failed to update ${order.orderId}.`);
                    button.disabled = false;
                }
            }
        }
    });

    trackingSection.addEventListener('change', async (event) => {
        if (event.target.classList.contains('stage-select')) {
            const dropdown = event.target;
            const newStage = dropdown.value;
            const orderCard = dropdown.closest('.tracking-order-card');
            const orderDbId = orderCard.dataset.orderDbId;
            const order = orders.find(o => o.id == orderDbId);

            if (newStage === 'Delivered') {
                showTrackingToast("'Delivered' status can only be set by the customer.");
                dropdown.value = order.currentStage;
                return;
            }

            if (order.currentStage !== newStage) {
                dropdown.disabled = true;
                const success = await updateOrderStatusAPI(order.id, newStage);
                if (success) {
                    order.currentStage = newStage;
                    updateTrackerUI(orderCard, newStage);
                    showTrackingToast(`Order ${order.orderId} updated to ${newStage}.`);
                } else {
                    showTrackingToast(`Failed to update ${order.orderId}.`);
                    dropdown.value = order.currentStage;
                }
                dropdown.disabled = newStage === 'Delivered';
            }
        }
    });

    // --- INITIALIZATION ---
    try {
        const response = await fetch('http://127.0.0.1:8000/api/admin/orders', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if(!response.ok) throw new Error('Failed to fetch orders for tracking.');
        const allOrders = await response.json();
        
        orders = allOrders
            .filter(o => o.status === 'Approved')
            .map(order => ({
                id: order.id,
                orderId: order.order_id,
                customerName: order.delivery_name ?? order.user?.name ?? 'Unknown',
                currentStage: order.tracking_stage || 'Approved',
                createdAt: order.created_at,
                items: order.items.map(i => `${i.product.name} (x${i.quantity})`).join(', '),
                total: order.total
            }));
        renderOrders();
    } catch (error) {
        console.error("Error initializing tracking section:", error);
        trackingSection.innerHTML = `<p style="text-align: center; color: red;">Could not load tracking data.</p>`;
    }
}
  </script>
</body>
</html>
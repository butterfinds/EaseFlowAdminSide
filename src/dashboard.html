<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EASEPrint Admin Dashboard</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Other libraries -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- ICONS UPDATE: Added Feather Icons for the new UI -->
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- Your Custom Stylesheet (Last) -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /* --- FONT FIXES START --- */
    
    /* 1. Restore the original font for the entire app */
    body {
        font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* 2. APPLY THE NEW 'INTER' FONT TO ALL UPDATED UI SECTIONS */
    #transactions, #appointments, #orders {
        font-family: 'Inter', sans-serif;
    }

    /* 3. EXPLICITLY RE-STYLE HEADINGS THAT WERE RESET BY TAILWIND */
    .sidebar h2 {
        color: #FBB3C8;
        text-align: center;
        margin: 0 0 30px 0;
        padding: 0 20px;
        font-size: 1.5rem;
        font-weight: 700; /* Restore bold weight */
    }
    
    /* UPDATE: EXCLUDE NEW UI SECTIONS FROM OLD HEADING STYLES */
    .main > div:not(#transactions):not(#appointments):not(#orders) h1,
    .main > div:not(#transactions):not(#appointments):not(#orders) h2,
    .main > div:not(#transactions):not(#appointments):not(#orders) h3 {
        font-weight: 700; 
        color: #3F1A2B;  
    }
    /* UPDATE: EXCLUDE NEW UI SECTIONS FROM OLD HEADING STYLES */
    .main > div:not(#transactions):not(#appointments):not(#orders) h1 {
        font-size: 2rem;
        border-bottom: 2px solid #FBB3C8;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .main > div:not(#transactions):not(#appointments):not(#orders) h2 {
        font-size: 1.5rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    /* --- FONT FIXES END --- */

    /* ORDERS TABLE EDITED */
    #orders table th, #orders table td,
    #appointments table th, #appointments table td {
      border: 2vh;
      padding: 3vh; 
    }

    .hidden { display: none; }
    #editModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #editModal form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 100%;
    }

    .main > div:not(#transactions):not(#appointments):not(#orders) {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    img { max-width: 100%; }
    /* UI UPDATE: OLD TABLE STYLES KEPT FOR SECTIONS THAT STILL USE THEM */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 10px; text-align: left; }
    button { padding: 5px 10px; margin: 2px; cursor: pointer; }
    textarea { width: 100%; height: 40px; }
    .approved { background-color: #d4f8d4; }
    .rejected { background-color: #ffdada; }
    .pending { background-color: #fff5d1; }
    .filter-box { margin-bottom: 15px; }
    select { padding: 5px; }
    
    /* Toast */
    #toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #1f2937;
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        font-size: 0.875rem;
        transition: opacity 0.3s, transform 0.3s;
        opacity: 0;
        z-index: 100;
    }
    @keyframes fadeInOut {
        0%, 100% { opacity: 0; transform: translateY(20px); }
        10%, 90% { opacity: 1; transform: translateY(0); }
    }
    .toast-active {
        animation: fadeInOut 3s forwards;
    }
    
    /* UI UPDATE: Added custom scrollbar style from the new design */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    ::-webkit-scrollbar-track {
        background: #f1f5f9;
    }
    ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="sidebar">
  <h2>EASEPrint</h2>
  <ul>
    <li onclick="showSection('home')"><i class="fas fa-home"></i> Dashboard</li>
    <li onclick="showSection('products')"><i class="fas fa-box-open"></i> Products</li>
    <li onclick="showSection('orders')"><i class="fas fa-shopping-cart"></i> Orders</li>
    <li onclick="showSection('appointments')"><i class="fas fa-calendar-alt"></i> Appointments</li>
    <li onclick="showSection('tracking')"><i class="fas fa-truck"></i> Tracking</li>
    <li onclick="showSection('transactions')"><i class="fas fa-receipt"></i> Transactions</li>
    <li onclick="showSection('analytics')"><i class="fas fa-chart-line"></i> Analytics</li>
    <li onclick="showSection('chat')"><i class="fas fa-comments"></i> Chat</li>
    <li onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</li>
  </ul>
</div>

<!-- ================================================================== -->
<!-- ====================   DASHBOARD SECTION      ==================== -->
<!-- ================================================================== -->
<div class="main">
    <div id="home">
      <h1>Dashboard</h1>
      <p>Overview of orders, sales, and top products.</p>

<div id="topSalesSection" class="hidden">
  <h2><i class="fas fa-trophy"></i> Top Sales</h2>
  <ul id="topSalesList"></ul>

  <div id="topSalesChartSection">
    <h2><i class="fas fa-chart-pie"></i> Top Sales Pie Chart</h2>
    <canvas id="topSalesChart" width="400" height="400"></canvas>
  </div>
</div>
</div>
<!-- ================================================================== -->
<!-- ==================== END OF DASHBOARD SECTION ==================== -->
<!-- ================================================================== -->



<!-- ================================================================== -->
<!-- ====================   PRODUCTS SECTION       ==================== -->
<!-- ================================================================== -->
    <div id="products" class="hidden">
      <h1>Product Upload</h1>
      <form id="productForm">
        <input type="text" id="productName" placeholder="Product Name" required>
        <input type="number" id="productPrice" placeholder="Price" required>
        <input type="number" id="productStock" placeholder="Stock" required>
        <textarea id="productDescription" placeholder="Description"></textarea>
        <input type="file" id="productImage" required>

        <select id="productCategory" required>
          <option value="">Select Category</option>
          <option value="1">Jerseys</option>
          <option value="2">Shirts</option>
          <option value="3">Shorts</option>
          <option value="4">Jackets</option>
          <option value="5">Others</option>
        </select>

        <button type="submit">Upload</button>
      </form>


      <h2>Uploaded Products</h2>
      <table id="productTable" border="1">
        <thead>
          <tr>
            <th>Image</th>
            <th>Name</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
<!-- ================================================================== -->
<!-- ==================== END OF PRODUCTS SECTION  ==================== -->
<!-- ================================================================== -->



<!-- ================================================================== -->
<!-- ====================    ORDERS SECTION        ==================== -->
<!-- ================================================================== -->
<div id="orders" class="hidden">
    <div class="w-full p-4 sm:p-6 lg:p-8" style="padding: 0; max-width: 100%;">
        <!-- PAGE HEADER UPDATED: PINK LINE REMOVED -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Orders</h1>
        </header>

        <!-- CONTROLS -->
        <div class="mb-6">
             <button onclick="fetchOrders()" class="flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                <i data-feather="refresh-cw" class="w-4 h-4"></i>
                <span>Refresh</span>
            </button>
        </div>

        <!-- ORDERS TABLE CARD -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div>
                <table id="ordersTable" class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- THIS WILL BE POPULATED BY THE UPDATED fetchOrders() FUNCTION -->
                         <tr><td colspan="8" class="text-center py-6">Loading orders...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- ================================================================== -->
<!-- =======================END OF ORDER SECTION======================= -->
<!-- ================================================================== -->



<!-- ================================================================== -->
<!-- ======================= APPOINTMENT SECTION ====================== -->
<!-- ================================================================== -->

<div id="appointments" class="hidden">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8" style="padding: 0; max-width: 100%;">
        <!-- PAGE HEADER UPDATED: PINK LINE REMOVED -->
        <header class="mb-8">
             <h1 class="text-3xl font-bold text-gray-900">Appointments</h1>
            <p class="text-gray-500 mt-2">Manage custom requests and scheduled appointments.</p>
        </header>

        <!-- Main Content Grid -->
        <div class="flex flex-col gap-8">

            <!-- Custom Shirt Requests Card -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="p-6">
                    <!-- Card Header with Theme Line -->
                    <div class="border-b-2 border-pink-500 pb-4 mb-4">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Custom Shirt Requests</h2>
                            <div class="flex items-center space-x-2">
                                <label for="statusFilter" class="text-sm font-medium">Show:</label>
                                <!-- ID is kept as "statusFilter" to match your existing JS -->
                                <select id="statusFilter" onchange="fetchRequests()" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                                    <option>All</option>
                                    <option>Pending</option>
                                    <option>Approved</option>
                                    <option>Rejected</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Requests Table -->
                    <div>
                        <!-- Table ID and tbody ID are kept to match your existing JS -->
                        <table id="requestsTable" class="w-full divide-y divide-gray-200" style="border: none;">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Design / Specs</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admin Note</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="requestsBody" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="text-center py-4">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Appointments Schedule Card -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="p-6">
                    <!-- Card Header with Theme Line -->
                    <div class="border-b-2 border-pink-500 pb-4 mb-4">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Appointments Schedule</h2>
                            <div class="flex items-center space-x-2">
                                <label for="appointmentsStatusFilter" class="text-sm font-medium">Filter:</label>
                                <!-- ID is kept as "appointmentsStatusFilter" to match your existing JS -->
                                <select id="appointmentsStatusFilter" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                                    <option value="">All</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <!-- ID is kept as "appointmentsReloadBtn" to match your existing JS -->
                                <button id="appointmentsReloadBtn" class="p-2 rounded-md hover:bg-gray-100 active:bg-gray-200">
                                    <i data-feather="refresh-cw" class="w-4 h-4 text-gray-500"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Table -->
                    <!-- Table ID is kept as "appointmentsTbl" to match your existing JS -->
                    <table id="appointmentsTbl" class="w-full divide-y divide-gray-200" style="border: none;">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assets</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- This will be populated by your loadAppointments() function -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- ================================================================== -->
<!-- ================ END OF APPOINTMENT SECTION ====================== -->
<!-- ================================================================== -->



<!-- ================================================================== -->
<!-- ================     TRACKING SECTION       ====================== -->
<!-- ================================================================== -->
<div id="tracking" class="hidden">
    <h1>Order Tracking</h1>
    <div id="tracking-section">
    </div>
</div>
<!-- ================================================================== -->
<!-- ================  END OF TRACKING SECTION   ====================== -->
<!-- ================================================================== -->



<!-- ================================================================== -->
<!-- ================     TRANSACTION SECTION    ====================== -->
<!-- ================================================================== -->
 <div id="transactions" class="hidden">
        <div>
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Sales & Transactions</h1>
                <p class="text-gray-500 mt-1">Manually record sales and view the complete transaction history.</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-900 border-b pb-3 mb-6">Record a New Sale</h3>
                    
                    <div class="space-y-5">
                        <div>
                            <label for="item" class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                            <input type="text" id="item" placeholder="e.g., Custom Jersey Print" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                        </div>

                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
                                <input type="number" id="price" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                            </div>
                            <div class="flex-1">
                                <label for="qty" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                <input type="number" id="qty" placeholder="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="orderStatus" class="block text-sm font-medium text-gray-700 mb-1">Order Status</label>
                                <select id="orderStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                                    <option value="Pending">Pending</option>
                                    <option value="Successful">Successful</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label for="paymentStatus" class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                                <select id="paymentStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                                    <option value="Pending">Pending</option>
                                    <option value="Done">Done</option>
                                </select>
                            </div>
                        </div>

                        <button onclick="submitTransaction()" class="w-full bg-[#ED4A69] text-white font-semibold py-3 px-4 rounded-lg hover:bg-[#d4435d] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#ED4A69] transition-transform transform hover:scale-105">
                            <i class="fas fa-plus-circle mr-2"></i> Add Transaction
                        </button>
                        <div id="response" class="text-center mt-2"></div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white rounded-xl shadow-md">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-semibold text-gray-900">Sales History</h3>
                    </div>
                    <div class="table-container max-h-[600px] overflow-y-auto">
                        <table class="w-full text-sm text-left text-gray-500" style="border: none;">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0" style="border: none;">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Date</th>
                                    <th scope="col" class="px-6 py-3">Item Name</th>
                                    <th scope="col" class="px-6 py-3 text-right">Unit Price</th>
                                    <th scope="col" class="px-6 py-3 text-center">Quantity</th>
                                    <th scope="col" class="px-6 py-3 text-center">Order Status</th>
                                    <th scope="col" class="px-6 py-3 text-center">Payment Status</th>
                                    <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="transactionModal" class="hidden">
      <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
        <h3 class="text-xl font-semibold text-gray-900 border-b pb-3 mb-6">Edit Transaction</h3>
        <input id="editTransactionId" type="hidden" />
        <div class="space-y-5">
            <div>
                <label for="editItem" class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                <input type="text" id="editItem" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
            </div>
            <div class="flex space-x-4">
                <div class="flex-1">
                    <label for="editPrice" class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
                    <input type="number" id="editPrice" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                </div>
                <div class="flex-1">
                    <label for="editQty" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                    <input type="number" id="editQty" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                </div>
            </div>
            <div class="flex space-x-4">
                <div class="flex-1">
                    <label for="editOrderStatus" class="block text-sm font-medium text-gray-700 mb-1">Order Status</label>
                    <select id="editOrderStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                        <option value="Pending">Pending</option>
                        <option value="Successful">Successful</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label for="editPaymentStatus" class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                    <select id="editPaymentStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ED4A69] focus:border-[#ED4A69] transition">
                        <option value="Pending">Pending</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button onclick="closeTransactionModal()" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button onclick="saveEdit()" class="px-6 py-2 bg-[#ED4A69] text-white rounded-lg hover:bg-[#d4435d] transition">Save Changes</button>
            </div>
        </div>
      </div>
    </div>
<!-- ================================================================== -->
<!-- ================ END OF TRANSACTION SECTION ====================== -->
<!-- ================================================================== -->



<!-- ================================================================== -->
<!-- ================       ANALYTICS SECTION    ====================== -->
<!-- ================================================================== -->
<div id="analytics" class="hidden">
      <h1>Analytics</h1>
      
    <div>
  <label for="salesPeriod">Select Period:</label>
  <select id="salesPeriod">
    <option value="day">Daily</option>
    <option value="week">Weekly</option>
    <option value="month" selected>Monthly</option>
    <option value="year">Yearly</option>
  </select>
</div>

  <div id="salesTrendsSection">
    <h2><i class="fas fa-chart-bar"></i> Sales Trends</h2>
    <canvas id="salesLineChart" width="600" height="300"></canvas>
    <canvas id="salesBarChart" width="600" height="300" style="margin-top:20px;"></canvas>
  </div>
  </div>

<!-- ================================================================== -->
<!-- =======================END OF ANALYTICS SECTION ================== -->
<!-- ================================================================== -->


<!-- ================================================================== -->
<!-- ================         CHAT SECTION       ====================== -->
<!-- ================================================================== -->
  <div id="chat" class="hidden">
    <div class="chat-header">
      <h1 id="chatTitle">Customer Support Chat</h1>
    </div>

    <div class="chat-header-row">
      <div id="activeCustomer" class="active-customer">No customer selected</div>

      <div class="custom-select" id="customerSelectWrapper">
        <button id="customerSelectBtn" class="select-btn" aria-haspopup="listbox" aria-expanded="false">
          -- Select a Customer -- <i class="fas fa-caret-down" style="margin-left:8px"></i>
        </button>
        <ul id="customerList" class="select-list hidden" role="listbox" tabindex="-1"></ul>
      </div>
    </div>

    <div id="chatBox"></div>

    <div class="chat-input-row">
      <input id="chatInput" type="text" placeholder="Type a message..." />
      <button id="sendMsgBtn" onclick="sendMessage()">Send</button>
    </div>
  </div>
<!-- ================================================================== -->
<!-- ================  END OF CHAT SECTION       ====================== -->
<!-- ================================================================== -->


  <div id="settings" class="hidden">
    <h1>Account Settings</h1>
    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </div>
  </div>


  <div id="editModal">
    <form id="editForm" enctype="multipart/form-data">
      <h3>Edit Product</h3>
      <input type="hidden" id="editProductId" />
      <input type="text" id="editName" placeholder="Product Name" required />
      <input type="number" id="editprice" placeholder="Price (e.g. 99.99)" step="0.01" min="0" required />
      <input type="number" id="editStock" placeholder="Stock" required />
      <textarea id="editDescription" placeholder="Description" required></textarea>
      <input type="file" id="editImage" accept="image/*" />
      <button type="submit">Save</button>
      <button type="button" onclick="closeEditModal()">Cancel</button>
    </form>
  </div>

  <div id="toast-notification">
      <p id="toast-message"></p>
  </div>


  <script>
    const token = localStorage.getItem('adminToken');
    if (!token) window.location.href = './index.html';

    function showSection(id) {
        document.querySelectorAll('.main > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if (id === 'products') loadProducts();
        if (id === 'orders') fetchOrders();
        if (id === 'transactions') fetchTransactions();
        if (id === 'tracking') initializeTracking();
        // UI UPDATE: INITIALIZE FEATHER ICONS FOR NEW UI SECTIONS
        if (id === 'appointments' || id === 'orders') {
            feather.replace();
        }
    }

    function logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminEmail');
      window.location.href = './index.html';
    }

// Product Upload
document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const formData = new FormData();
  formData.append('name', document.getElementById('productName').value);
  formData.append('price', document.getElementById('productPrice').value);
  formData.append('stock', document.getElementById('productStock').value);
  formData.append('description', document.getElementById('productDescription').value);
  formData.append('image', document.getElementById('productImage').files[0]);
  formData.append('category_id', document.getElementById('productCategory').value);

  try {
    const res = await fetch('http://127.0.0.1:8000/api/admin/products', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${token}`
      },
      body: formData
    });

    const result = await res.json();
    if (!res.ok) throw new Error(result.message || 'Upload failed');

    // Reset form and reload
    e.target.reset();
    loadProducts();

    // Show success toast
    showToast('Product uploaded successfully!', 'success');
  } catch (err) {
    console.error('Upload error:', err);

    // Show error toast
    showToast('Upload failed: ' + err.message, 'error');
  }
});

// Load categories into the dropdown
async function loadCategories() {
  const res = await fetch('http://127.0.0.1:8000/api/categories', {
    headers: { Authorization: `Bearer ${token}` }
  });
  const categories = await res.json();

  const categorySelect = document.getElementById('productCategory');
  categorySelect.innerHTML = '<option value="">-- Select Category --</option>';

  categories.forEach(c => {
    categorySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
  });
}

// Call it when the page loads
loadCategories();


async function loadProducts() {
  const res = await fetch('http://127.0.0.1:8000/api/admin/products', {
    headers: { Authorization: `Bearer ${token}` }
  });
  const products = await res.json();
  const tbody = document.querySelector('#productTable tbody');
  tbody.innerHTML = '';

  products.forEach(p => {
    const imageSrc = p.image_url || 'placeholder.png'; // fallback if no image
    const row = `
      <tr>
        <td><img src="${imageSrc}" width="50" /></td>
        <td>${p.name}</td>
        <td>${p.price}</td>
        <td>${p.stock}</td>
        <td>${p.description}</td>
        <td>
          <button class="edit-btn" onclick="editProduct(${p.id})">
            <i class="fas fa-edit"></i> Edit
          </button>
          <button class="delete-btn" onclick="deleteProduct(${p.id})">
            <i class="fas fa-trash"></i> Delete
          </button>
        </td>
      </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', row);
  });
}

    function editProduct(id) {
      fetch('http://127.0.0.1:8000/api/admin/products', {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(products => {
        const p = products.find(prod => prod.id === id);
        if (!p) return alert('Product not found.');
        document.getElementById('editProductId').value = p.id;
        document.getElementById('editName').value = p.name;
        document.getElementById('editprice').value = p.price;
        document.getElementById('editStock').value = p.stock;
        document.getElementById('editDescription').value = p.description;
        document.getElementById('editModal').style.display = 'flex';
      });
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

document.getElementById('editForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = document.getElementById('editProductId').value;
  const formData = new FormData();
  formData.append('name', document.getElementById('editName').value);
  formData.append('price', document.getElementById('editprice').value);
  formData.append('stock', document.getElementById('editStock').value);
  formData.append('description', document.getElementById('editDescription').value);

  const newImage = document.getElementById('editImage').files[0];
  if (newImage) {
    formData.append('image', newImage);
  }
  formData.append('_method', 'PUT');

  try {
    const res = await fetch(`http://127.0.0.1:8000/api/admin/products/${id}`, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${token}`
      },
      body: formData
    });

    const result = await res.json();
    if (!res.ok) {
      throw new Error(result.message || 'Failed to update product');
    }

    closeEditModal();
    loadProducts();
    alert('Product updated successfully!');
  } catch (err) {
    console.error('Update error:', err);
    alert('Error updating product: ' + err.message);
  }
});


async function deleteProduct(id) {
  if (!confirm('Are you sure you want to delete this product?')) return;

  try {
    const res = await fetch(`http://127.0.0.1:8000/api/admin/products/${id}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });

    const result = await res.json();
    
    if (!res.ok) {
      throw new Error(result.message || 'Delete failed');
    }
    
    // Reset the product form
    document.getElementById('productForm').reset();
    
    // Reload products after a short delay
    loadProducts();
  } catch (err) {
    console.error('Delete error:', err);
    alert('Delete failed: ' + err.message);
  }
}


document.addEventListener('DOMContentLoaded', () => {
  loadCustomers();
  setInterval(fetchMessages, 3000); // auto refresh
  setInterval(checkAllCustomersForNewMessages, 3000);
});
const hasNewMessageMap = {};

let selectedCustomerId = null;

async function loadCustomers() {
  const res = await fetch('http://127.0.0.1:8000/api/customers');
  const customers = await res.json();
  const select = document.getElementById('customerSelect');

  select.innerHTML = '<option disabled selected value="">-- Select a Customer --</option>';

  customers.forEach(c => {
    const option = document.createElement('option');
    option.value = c.id;
    option.textContent = c.name;

    // Initialize lastReadMessageId for new customers
    if (!(c.id in lastReadMessageIdPerCustomer)) {
      lastReadMessageIdPerCustomer[c.id] = 0;
    }

    select.appendChild(option);
  });

  updateCustomerUnreadIndicators();
}

// escape helper
function escapeHtml(str) {
  return String(str).replace(/[&<>"'`=\/]/g, function(s) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s];
  });
}

async function loadCustomers() {
  try {
    const res = await fetch('http://127.0.0.1:8000/api/customers');
    const customers = await res.json();

    const list = document.getElementById('customerList');
    const btn = document.getElementById('customerSelectBtn');

    // reset
    list.innerHTML = '';
    btn.textContent = '-- Select a Customer -- ';
    btn.removeAttribute('data-id');
    btn.setAttribute('aria-expanded', 'false');

    customers.forEach(c => {
      const li = document.createElement('li');
      li.className = 'customer-item';
      li.dataset.id = c.id;
      li.innerHTML = `
        <span class="customer-name">${escapeHtml(c.name)}</span>
        <span class="unread-dot"></span>
      `;
      li.addEventListener('click', () => selectCustomer(c));
      list.appendChild(li);
    });

    updateCustomerUnreadIndicators();
  } catch (err) {
    console.error('Failed to load customers:', err);
  }
}

function selectCustomer(c) {
  const btn = document.getElementById('customerSelectBtn');
  const list = document.getElementById('customerList');

  btn.textContent = c.name;
  btn.dataset.id = c.id;
  btn.setAttribute('aria-expanded', 'false');
  list.classList.add('hidden');

  selectedCustomerId = c.id;

  // ✅ Update header
  document.getElementById('activeCustomer').textContent = c.name;

  // clear unread dot for this customer
  const dot = document.querySelector(`#customerList li[data-id="${c.id}"] .unread-dot`);
  if (dot) dot.innerHTML = '';

  // remove button dot if no other unread
  const stillUnread = Array.from(document.querySelectorAll('#customerList .unread-dot'))
    .some(d => d.innerHTML.trim() !== '');
  const btnDot = btn.querySelector('.btn-unread-dot');
  if (btnDot && !stillUnread) btnDot.remove();

  fetchMessages();
  markMessagesRead(c.id);
}

async function updateCustomerUnreadIndicators() {
  const items = Array.from(document.querySelectorAll('#customerList li'));
  for (const li of items) {
    const id = li.dataset.id;
    const placeholder = li.querySelector('.unread-dot');

    let unread = !!hasNewMessageMap[id];
    if (!unread) {
      try { unread = await hasUnread(id); } catch { unread = false; }
    }

    if (unread) {
      placeholder.innerHTML = `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle></svg>`;
    } else {
      placeholder.innerHTML = '';
    }
  }

  // button dot
  const anyUnread = items.some(li => li.querySelector('.unread-dot').innerHTML.trim() !== '');
  const btn = document.getElementById('customerSelectBtn');
  if (btn) {
    if (anyUnread) {
      if (!btn.querySelector('.btn-unread-dot')) {
        const dot = document.createElement('span');
        dot.className = 'btn-unread-dot';
        dot.style.cssText = 'display:inline-block;width:10px;height:10px;border-radius:50%;background:#28a745;margin-left:8px;';
        btn.appendChild(dot);
      }
    } else {
      const old = btn.querySelector('.btn-unread-dot');
      if (old) old.remove();
    }
  }
}

// dropdown toggle
document.addEventListener('click', function(e) {
  const wrapper = document.getElementById('customerSelectWrapper');
  const btn = document.getElementById('customerSelectBtn');
  const list = document.getElementById('customerList');
  if (!wrapper) return;

  if (e.target.closest('#customerSelectBtn')) {
    const isOpen = !list.classList.contains('hidden');
    list.classList.toggle('hidden', isOpen);
    btn.setAttribute('aria-expanded', String(!isOpen));
    return;
  }

  if (!e.target.closest('#customerSelectWrapper')) {
    list.classList.add('hidden');
    btn.setAttribute('aria-expanded', 'false');
  }
});

document.addEventListener('DOMContentLoaded', loadCustomers);

async function hasUnread(customerId) {
  if (hasNewMessageMap[customerId]) {
    return true;
  }

  try {
    const res = await fetch(`http://127.0.0.1:8000/api/messages/${customerId}`);
    const messages = await res.json();
    if (messages.length === 0) return false;

    const lastReadId = lastReadMessageIdPerCustomer[customerId] || 0;
    const latestMsgId = messages[messages.length - 1].id;
    return latestMsgId > lastReadId;
  } catch {
    return false;
  }
}


function handleCustomerChange() {
  selectedCustomerId = document.getElementById('customerSelect').value;
  fetchMessages();

  // When switching customer, mark messages as read by updating lastReadMessageId
  markMessagesRead(selectedCustomerId);
  updateCustomerUnreadIndicators();
}

function formatTimestamp(dateString) {
  const date = new Date(dateString);
  const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const day = date.toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' });
  return `${day} at ${time}`;
}

let lastReadMessageIdPerCustomer = JSON.parse(localStorage.getItem('lastReadIds')) || {};
let lastFetchedMessageId = 0;

async function fetchMessages() {
  if (!selectedCustomerId) return;

  const res = await fetch(`http://127.0.0.1:8000/api/messages/${selectedCustomerId}`);
  const messages = await res.json();
  const chatBox = document.getElementById('chatBox');

  const isAtBottom = chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 50;

  // Detect new messages
  if (messages.length > 0) {
    const latestMsgId = messages[messages.length - 1].id;
    if (latestMsgId > lastFetchedMessageId) {
      if (selectedCustomerId !== null && latestMsgId !== lastFetchedMessageId) {
        notifyNewMessage(messages[messages.length - 1]);
      }
      lastFetchedMessageId = latestMsgId;
    }
  }

  chatBox.innerHTML = '';

  messages.forEach(msg => {
    const isSent = msg.is_admin;
    const timestamp = formatTimestamp(msg.created_at);

    const lastReadId = lastReadMessageIdPerCustomer[selectedCustomerId] || 0;
    const isUnread = msg.id > lastReadId;

    const wrapper = document.createElement('div');
    wrapper.classList.add('message-wrapper', isSent ? 'sent-wrapper' : 'received-wrapper');

    wrapper.innerHTML = `
      <div class="message ${isSent ? 'sent' : 'received'} ${isUnread ? 'unread' : 'read'}">
        ${msg.message}
      </div>
      <div class="timestamp-only">${timestamp}</div>
    `;


    chatBox.appendChild(wrapper);
  });

  // Mark messages as read and persist to localStorage
  if (messages.length > 0) {
    const lastMsgId = messages[messages.length - 1].id;
    lastReadMessageIdPerCustomer[selectedCustomerId] = lastMsgId;
    localStorage.setItem('lastReadIds', JSON.stringify(lastReadMessageIdPerCustomer));
  }

  if (isAtBottom) {
    chatBox.scrollTop = chatBox.scrollHeight;
  }
}



function markMessagesRead(customerId) {
  fetch(`http://127.0.0.1:8000/api/messages/${customerId}`)
    .then(res => res.json())
    .then(messages => {
      if (messages.length === 0) return;
      lastReadMessageIdPerCustomer[customerId] = messages[messages.length - 1].id;

      hasNewMessageMap[customerId] = false; // ✅ clear red dot flag

      updateCustomerUnreadIndicators();
    });
}


async function sendMessage() {
  const msg = document.getElementById('chatInput').value;
  if (!selectedCustomerId || !msg.trim()) return;

  await fetch('http://127.0.0.1:8000/api/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      sender_id: 0,
      receiver_id: selectedCustomerId,
      message: msg,
      is_admin: true
    })
  });

  document.getElementById('chatInput').value = '';
  fetchMessages();
}

// Desktop notification for new messages
function notifyNewMessage(msg) {
  console.log("🔔 Notification triggered:", msg);
  if (document.hidden && Notification.permission === 'granted') {
    const notification = new Notification(`New message from ${msg.is_admin ? 'Admin' : msg.sender.name}`, {
      body: msg.message,
      icon: 'chat-icon.png', // optional: path to your icon
    });

    notification.onclick = () => {
      window.focus();
      // Optionally, switch to customer chat if you have UI for that
    };
  }
}




let lastFetchedMessageIdMap = {}; // per customer

async function checkAllCustomersForNewMessages() {
  const res = await fetch('http://127.0.0.1:8000/api/customers');
  const customers = await res.json();

  for (const customer of customers) {
    try {
      const res = await fetch(`http://127.0.0.1:8000/api/messages/${customer.id}`);
      const messages = await res.json();

      if (messages.length === 0) continue;

      const latestMsg = messages[messages.length - 1];

      // Only notify if the message is NOT from admin
      if (!latestMsg.is_admin) {
        const lastFetchedId = lastFetchedMessageIdMap[customer.id] || 0;

        if (latestMsg.id > lastFetchedId) {
          lastFetchedMessageIdMap[customer.id] = latestMsg.id;

          hasNewMessageMap[customer.id] = true;
          updateCustomerUnreadIndicators(); // ✅ Add this


          notifyNewMessage(latestMsg);
        }
      }
    } catch (err) {
      console.error(`Failed to check messages for customer ${customer.id}:`, err);
    }
  }
}

// Request notification permission once on page load
if ('Notification' in window && Notification.permission !== 'granted') {
  Notification.requestPermission();
}


let selectedTransactionId = null;

// TRANSACTIONS SYSTEM
  fetchTransactions();

async function fetchTransactions() {
  const res = await fetch('http://127.0.0.1:8000/api/transactions', {
    headers: { Authorization: `Bearer ${token}` }
  });
  const transactions = await res.json();
  const list = document.getElementById('transactionsList');
  list.innerHTML = '';

  transactions.forEach(tx => {
    const date = new Date(tx.created_at).toLocaleString('en-US', {
      month: 'short', day: 'numeric', year: 'numeric',
      hour: 'numeric', minute: 'numeric', hour12: true
    });

    const itemNameEscaped = tx.item_name.replace(/'/g, "\\'");

    const row = document.createElement('tr');
    row.className = "bg-white border-b hover:bg-gray-50";
    row.style.border = "none";

    row.innerHTML = `
        <td class="px-6 py-4 text-gray-900 whitespace-nowrap" style="border:none">${date}</td>
        <td class="px-6 py-4 font-medium text-gray-900" style="border:none">${tx.item_name}</td>
        <td class="px-6 py-4 text-right" style="border:none">₱${parseFloat(tx.unit_price).toFixed(2)}</td>
        <td class="px-6 py-4 text-center" style="border:none">${tx.quantity}</td>
        <td class="px-6 py-4 text-center" style="border:none">
            <span class="status-pill ${tx.order_status === 'Successful' ? 'status-successful' : 'status-pending'}">${tx.order_status}</span>
        </td>
        <td class="px-6 py-4 text-center" style="border:none">
            <span class="status-pill ${tx.payment_status === 'Done' ? 'status-done' : 'status-pending'}">${tx.payment_status}</span>
        </td>
        <td class="px-6 py-4 text-right" style="border:none">
            <button onclick="openEditModal(${tx.id}, '${itemNameEscaped}', ${tx.unit_price}, ${tx.quantity}, '${tx.order_status}', '${tx.payment_status}')" class="text-[#ED4A69] hover:text-[#c13b56]"><i class="fas fa-edit fa-fw"></i></button>
            <button onclick="deleteTransaction(${tx.id})" class="text-red-600 hover:text-red-900 ml-2"><i class="fas fa-trash fa-fw"></i></button>
        </td>
    `;
    list.appendChild(row);
  });
}

async function submitTransaction() {
  const item = document.getElementById("item").value;
  const price = parseFloat(document.getElementById("price").value);
  const qty = parseInt(document.getElementById("qty").value);
  const orderStatus = document.getElementById("orderStatus").value;
  const paymentStatus = document.getElementById("paymentStatus").value;

  const responseDiv = document.getElementById("response");

  try {
      const res = await fetch('http://127.0.0.1:8000/api/transactions', {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
      body: JSON.stringify({
        item_name: item,
        unit_price: price,
        quantity: qty,
        order_status: orderStatus,
        payment_status: paymentStatus
      })
    });

    const data = await res.json();
    responseDiv.innerText = data.message || 'Transaction added!';
    responseDiv.style.color = "green";

    document.getElementById("item").value = '';
    document.getElementById("price").value = '';
    document.getElementById("qty").value = '';
    document.getElementById("orderStatus").value = 'Pending';
    document.getElementById("paymentStatus").value = 'Pending';

    fetchTransactions();
  } catch (err) {
    responseDiv.innerText = 'Error saving transaction.';
    responseDiv.style.color = "red";
    console.error(err);
  }
}

function openEditModal(id, item_name, unit_price, quantity, order_status, payment_status) {
  selectedTransactionId = id;
  document.getElementById('editTransactionId').value = id;
  document.getElementById('editItem').value = item_name;
  document.getElementById('editPrice').value = unit_price;
  document.getElementById('editQty').value = quantity;
  document.getElementById('editOrderStatus').value = order_status;
  document.getElementById('editPaymentStatus').value = payment_status;
  const modal = document.getElementById('transactionModal');
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
}

function closeTransactionModal() {
  const modal = document.getElementById('transactionModal');
  modal.classList.add('hidden');
  modal.style.display = 'none';
}

async function saveEdit() {
  const id = document.getElementById('editTransactionId').value;
  const item = document.getElementById('editItem').value;
  const price = parseFloat(document.getElementById('editPrice').value);
  const qty = parseInt(document.getElementById('editQty').value);
  const orderStatus = document.getElementById('editOrderStatus').value;
  const paymentStatus = document.getElementById('editPaymentStatus').value;

  try {
    await fetch(`http://127.0.0.1:8000/api/transactions/${id}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
      body: JSON.stringify({
        item_name: item,
        unit_price: price,
        quantity: qty,
        order_status: orderStatus,
        payment_status: paymentStatus
      })
    });

    closeTransactionModal();
    fetchTransactions();
  } catch (err) {
    console.error("Update failed:", err);
  }
}

async function deleteTransaction(id) {
  if (!confirm("Are you sure you want to delete this transaction?")) return;

  try {
    const res = await fetch(`http://127.0.0.1:8000/api/transactions/${id}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });

    if (!res.ok) {
      throw new Error('Failed to delete transaction');
    }

    document.getElementById("response").innerText = 'Transaction deleted successfully!';
    document.getElementById("response").style.color = 'green';
    
    fetchTransactions();
  } catch (err) {
    console.error("Delete error:", err);
    alert("Error deleting transaction: " + err.message);
  }
}

// TOP SALES SECTION
async function fetchTopSales() {
  try {
    const res = await fetch('http://127.0.0.1:8000/api/top-sales');
    const data = await res.json();

    const section = document.getElementById('topSalesSection');
    const list = document.getElementById('topSalesList');
    list.innerHTML = ''; 

    if (data.length > 0) {
      section.classList.remove('hidden'); // 👈 Show the section if there's data
    } else {
      section.classList.add('hidden'); // 👈 Hide if no data
    }

    data.forEach((item, index) => {
      const li = document.createElement('li');
      li.textContent = `${index + 1}. ${item.item_name} — ${item.total_quantity} pcs`;
      list.appendChild(li);
    });
  } catch (err) {
    console.error('Error fetching top sales:', err);
  }
}


setInterval(() => {
  fetchTopSales();
}, 1000);


let topSalesChartInstance = null;

async function renderTopSalesPieChart() {
  try {
    const res = await fetch('http://127.0.0.1:8000/api/top-sales');
    const data = await res.json();

    const labels = data.map(item => item.item_name);
    const quantities = data.map(item => item.total_quantity);

    const ctx = document.getElementById('topSalesChart').getContext('2d');

    // Destroy old chart if it exists
    if (topSalesChartInstance) {
      topSalesChartInstance.destroy();
    }

    topSalesChartInstance = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          label: 'Top Sales',
          data: quantities,
          backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56',
            '#4BC0C0', '#9966FF', '#FF9F40'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
          },
          title: {
            display: true,
            text: 'Top Selling Products'
          }
        }
      }
    });

  } catch (err) {
    console.error('Error rendering Top Sales Pie Chart:', err);
  }
}

// Auto-refresh every 5 seconds
setInterval(renderTopSalesPieChart, 5000);

// Load once on page load
document.addEventListener('DOMContentLoaded', renderTopSalesPieChart);

//chartttsss

let salesLineChartInstance = null;
let salesBarChartInstance = null;

async function renderSalesTrendsCharts() {
  const period = document.getElementById('salesPeriod').value;

  try {
    const res = await fetch(`http://127.0.0.1:8000/api/sales-trends?period=${period}`);
    const data = await res.json();

    const labels = data.map(entry => entry.period);
    const sales = data.map(entry => parseFloat(entry.total_sales));

    // ===== Line Chart =====
    const ctxLine = document.getElementById('salesLineChart').getContext('2d');
    if (salesLineChartInstance) salesLineChartInstance.destroy();
    salesLineChartInstance = new Chart(ctxLine, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: `Sales (${period})`,
          data: sales,
          borderColor: '#36A2EB',
          backgroundColor: 'rgba(54,162,235,0.2)',
          fill: true,
          tension: 0.3
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    // ===== Bar Chart =====
    const ctxBar = document.getElementById('salesBarChart').getContext('2d');
    if (salesBarChartInstance) salesBarChartInstance.destroy();
    salesBarChartInstance = new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: `Sales (${period})`,
          data: sales,
          backgroundColor: '#FF6384'
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

  } catch (err) {
    console.error('Error rendering sales trends charts:', err);
  }
}

// Refresh when dropdown changes
document.getElementById('salesPeriod').addEventListener('change', renderSalesTrendsCharts);

// Auto-refresh every 10 seconds
setInterval(renderSalesTrendsCharts, 10000);

// Initial load
document.addEventListener('DOMContentLoaded', renderSalesTrendsCharts);



  const API_URL = "http://localhost:8000/api/custom-shirts"; // Laravel API

    async function fetchRequests() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        const tbody = document.getElementById("requestsBody");
        tbody.innerHTML = "";

        const filterValue = document.getElementById("statusFilter").value;

        const filteredData = filterValue === "All"
          ? data
          : data.filter(req => req.status === filterValue);

        if (filteredData.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center py-6">No ${filterValue} requests found.</td></tr>`;
          return;
        }

        filteredData.forEach(req => {
            // UI UPDATE: This section is heavily modified to fit the new table structure.
            const row = document.createElement("tr");
            
            // Status Badge Logic
            let statusBadge = '';
            switch(req.status.toLowerCase()) {
                case 'approved':
                    statusBadge = `<span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Approved</span>`;
                    break;
                case 'rejected':
                    statusBadge = `<span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>`;
                    break;
                default:
                    statusBadge = `<span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>`;
            }

            // Action Buttons Logic
            let actionButtons = '—'; // Default for non-pending
            if (req.status === 'Pending') {
                actionButtons = `
                    <button onclick="approveRequest(${req.id})" class="px-3 py-1 text-xs font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Approve</button>
                    <button onclick="rejectRequest(${req.id})" class="px-3 py-1 text-xs font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Reject</button>
                `;
            }

            row.innerHTML = `
                <td class="px-6 py-6 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${req.full_name}</div>
                    <div class="text-sm text-gray-500">${req.email}</div>
                    <div class="text-sm text-gray-500">${req.phone}</div>
                </td>
                <td class="px-6 py-6 whitespace-nowrap">
                    <div class="flex items-center text-sm">
                        ${req.design ? `<a href="http://localhost:8000/storage/${req.design}" target="_blank" class="font-medium text-indigo-600 hover:text-indigo-800 flex items-center gap-1"><i data-feather="eye" class="w-4 h-4"></i> View</a>` : '<span>No Design</span>'}
                        <span class="mx-2 text-gray-300">|</span>
                        <div>Size: <span class="font-semibold">${req.size}</span></div>
                        <span class="mx-2 text-gray-300">|</span>
                        <div>Qty: <span class="font-semibold">${req.quantity}</span></div>
                    </div>
                </td>
                <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-600 max-w-xs truncate">${req.notes || ''}</td>
                <td class="px-6 py-6 whitespace-nowrap">${statusBadge}</td>
                <td class="px-6 py-6 whitespace-nowrap">
                    <input type="text" id="note-${req.id}" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Add a note..." value="${req.admin_note || ''}">
                </td>
                <td class="px-6 py-6 whitespace-nowrap text-sm font-medium space-x-2">${actionButtons}</td>
            `;
            tbody.appendChild(row);
        });
        feather.replace(); // Re-initialize icons after drawing table
      } catch (err) {
        console.error("Error fetching requests:", err);
      }
    }

    async function approveRequest(id) {
      const note = document.getElementById(`note-${id}`).value;
      await fetch(`${API_URL}/${id}/approve`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ admin_note: note })
      });
      fetchRequests();
    }

    async function rejectRequest(id) {
      const note = document.getElementById(`note-${id}`).value;
      await fetch(`${API_URL}/${id}/reject`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ admin_note: note })
      });
      fetchRequests();
    }

    fetchRequests();
    




  const API_BASE = 'http://localhost:8000/api';

const appointmentsTbody = document.querySelector('#appointmentsTbl tbody');
const appointmentsStatusFilter = document.getElementById('appointmentsStatusFilter');

function originOf(url) { 
  try { return new URL(url).origin; } 
  catch { return ''; } 
}

function fileUrl(path) { 
  return `${originOf(API_BASE)}/storage/${path}`; 
}

async function loadAppointments() {
  const query = appointmentsStatusFilter.value ? `?status=${appointmentsStatusFilter.value}` : '';
  const res = await fetch(`${API_BASE}/appointments${query}`);
  const json = await res.json();
  const items = json.data || json;
  appointmentsTbody.innerHTML = '';

  if (items.length === 0) {
      appointmentsTbody.innerHTML = `<tr><td colspan="6" class="text-center py-6">No appointments found.</td></tr>`;
      return;
  }

  items.forEach(a => {
    // UI UPDATE: This section is heavily modified to fit the new table structure.
    const tr = document.createElement('tr');

    // Status Badge Logic
    let statusBadge = '';
    switch(a.status.toLowerCase()) {
        case 'approved':
            statusBadge = `<span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Approved</span>`;
            break;
        case 'rejected':
            statusBadge = `<span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>`;
            break;
        default:
            statusBadge = `<span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Pending</span>`;
    }

    // Action Buttons Logic
    let actionButtons = '—'; // Default for non-pending
    if (a.status === 'pending') {
        actionButtons = `
            <button onclick="approveAppointment(${a.id})" class="px-3 py-1 text-xs font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Approve</button>
            <button onclick="rejectAppointment(${a.id})" class="px-3 py-1 text-xs font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Reject</button>
        `;
    }

    tr.innerHTML = `
        <td class="px-6 py-6 whitespace-nowrap text-sm font-medium text-gray-900">${a.full_name}</td>
        <td class="px-6 py-6 whitespace-nowrap">
            <div class="text-sm text-gray-500">${a.email}</div>
            <div class="text-sm text-gray-500">${a.phone}</div>
        </td>
        <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-500">${new Date(a.schedule_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
        <td class="px-6 py-6 whitespace-nowrap">${statusBadge}</td>
        <td class="px-6 py-6 whitespace-nowrap text-sm font-medium">
           <div class="flex items-center space-x-3">
                ${a.qr_code_path ? `<a href="${fileUrl(a.qr_code_path)}" target="_blank" class="text-indigo-600 hover:text-indigo-900">QR</a>` : ''}
                ${a.pdf_path ? `<a href="${fileUrl(a.pdf_path)}" target="_blank" class="text-indigo-600 hover:text-indigo-900">PDF</a>` : ''}
           </div>
        </td>
        <td class="px-6 py-6 whitespace-nowrap text-sm font-medium space-x-2">${actionButtons}</td>
    `;
    appointmentsTbody.appendChild(tr);
  });
}

async function approveAppointment(id) {
  try {
    const response = await fetch(`http://127.0.0.1:8000/api/appointments/${id}/approve`, {
      method: 'PUT',    // ✅ match Laravel route
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      }
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      console.error("Server error:", errorData);
      alert(`Failed: ${errorData.message || 'Something went wrong.'}`);
      return;
    }

    const data = await response.json();
    console.log("✅ Appointment approved:", data);

    alert(`✅ ${data.message}\n📄 PDF: ${data.pdf_url}\n🔗 QR: ${data.qr_url}`);

    // reload table after approve
    loadAppointments();

  } catch (err) {
    console.error("Request failed:", err);
    alert("❌ Could not connect to server. Please try again.");
  }
}

async function rejectAppointment(id) {
  if (!confirm('Reject this appointment?')) return;
  const res = await fetch(`${API_BASE}/appointments/${id}/reject`, { method: 'PUT' });
  let msg = 'Rejected.';
  if (!res.ok) {
    const j = await res.json().catch(()=>({message:'Failed'}));
    msg = 'Error: ' + (j.message || res.status);
  }
  alert(msg);
  loadAppointments();
}

// <!-- ================================================================== -->
// <!-- ====================      ORDERS SCRIPT     ====================== -->
// <!-- ================================================================== -->

// Orders
async function fetchOrders() {
    const ordersTableBody = document.querySelector('#ordersTable tbody');
    ordersTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-6">Loading orders...</td></tr>';

    try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch('http://127.0.0.1:8000/api/admin/orders', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const data = await response.json();
        console.log("Fetched orders:", data);

        if (data.length === 0) {
            ordersTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-6">No orders found.</td></tr>';
            return;
        }

        ordersTableBody.innerHTML = '';
        data.forEach(order => {
            // STATUS BADGE LOGIC
            let statusBadge;
            switch (order.status) {
                case 'Approved':
                    statusBadge = `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Approved</span>`;
                    break;
                case 'Rejected':
                    statusBadge = `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>`;
                    break;
                default:
                    statusBadge = `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>`;
            }

            // FORMAT CREATED_AT DATE
            const createdAt = new Date(order.created_at).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // FORMAT ITEMS
            const items = order.items.map(i => `${i.product.name} x${i.quantity}`).join('<br>');

            // ACTIONS LOGIC
            let actions = '';
            const normalizedStatus = (order.status || '').toLowerCase();

              if (normalizedStatus === 'pending') {
                  // UI UPDATE: BIGGER BUTTONS WITH ICONS
                  actions += `
                      <button onclick="updateOrderStatus(${order.id}, 'Approved')" class="inline-flex items-center gap-3 px-5 py-3 text-xs font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">
                          <i data-feather="check" class="w-4 h-4"></i> Approve
                      </button>
                      <button onclick="updateOrderStatus(${order.id}, 'Rejected')" class="inline-flex items-center gap-3 px-5 py-3 text-xs font-medium text-white bg-gray-500 rounded-lg hover:bg-gray-600">
                          <i data-feather="x" class="w-4 h-4"></i> Reject
                      </button>
                  `;
              } else {
                  // UI UPDATE: DROPDOWN SAME SIZE AS BUTTONS
                  actions += `
                      <div class="relative inline-flex items-center">
                          <i data-feather="${order.status === 'Approved' ? 'check' : 'x'}" class="absolute left-4 w-4 h-4 pointer-events-none ${order.status === 'Approved' ? 'text-green-800' : 'text-red-800'}"></i>
                          <select onchange="handleEditStatus(${order.id}, this.value)" 
                              class="appearance-none pl-10 pr-10 py-3 text-xs font-medium rounded-lg border border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 
                              ${order.status === 'Approved' ? 'bg-green-100 text-green-800 font-semibold' : 'bg-red-100 text-red-800 font-semibold'}">
                              <option value="Approved" ${order.status === 'Approved' ? 'selected' : ''}>Approved</option>
                              <option value="Rejected" ${order.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                          </select>
                          <i data-feather="chevron-down" class="absolute right-3 w-4 h-4 pointer-events-none ${order.status === 'Approved' ? 'text-green-800' : 'text-red-800'}"></i>
                      </div>
                  `;
              }

            // UI UPDATE: BIGGER DELETE BUTTON
            actions += `
                <button onclick="deleteOrder(${order.id})" class="inline-flex items-center justify-center p-3 text-gray-500 bg-gray-100 rounded-lg hover:bg-red-100 hover:text-red-600" title="Delete">
                     <i data-feather="trash-2" class="w-4 h-4"></i>
                </button>
            `;

            // NEW ROW STRUCTURE
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-6 whitespace-nowrap">
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-900">${order.order_id}</span>
                        <button onclick="copyOrderId('${order.order_id}', this)" class="ml-3 text-gray-400 hover:text-blue-600" title="Copy ID">
                            <i data-feather="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                </td>
                <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-800">${order.delivery_name ?? order.user?.name ?? 'Unknown'}</td>
                <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-500">${order.delivery_phone ?? 'N/A'}</td>
                <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-900 font-semibold">₱${order.total}</td>
                <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-500">${items}</td>
                <td class="px-6 py-6 whitespace-nowrap">${statusBadge}</td>
                <td class="px-6 py-6 whitespace-nowrap text-sm text-gray-500">${createdAt}</td>
                <td class="px-6 py-6 whitespace-nowrap text-sm font-medium space-x-2">${actions}</td>
            `;
            ordersTableBody.appendChild(row);
        });
        
        // RE-INITIALIZE FEATHER ICONS AFTER ROWS ARE ADDED
        feather.replace();

    } catch (error) {
        console.error("Error fetching orders:", error);
        ordersTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-6">Error loading orders.</td></tr>';
    }
}


// UPDATED COPY FUNCTION FOR FEATHER ICONS
function copyOrderId(orderId, btn) {
    navigator.clipboard.writeText(orderId)
        .then(() => {
            showToast(`Order ID ${orderId} copied`, "success");
            
            const originalIconHTML = btn.innerHTML;
            btn.innerHTML = `<i data-feather="check" class="w-4 h-4 text-green-500"></i>`;
            feather.replace(); // Render the new 'check' icon

            setTimeout(() => {
                btn.innerHTML = originalIconHTML;
                feather.replace(); // Render the original 'copy' icon
            }, 1500);
        })
        .catch(err => {
            console.error("Failed to copy Order ID:", err);
            showToast("Failed to copy Order ID", "error");
        });
}

// THIS IS YOUR EXISTING TOAST FUNCTION, UNCHANGED
function showToast(message, type = "success") {
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.innerText = message;

  document.body.appendChild(toast);

  setTimeout(() => toast.classList.add("show"), 100);

  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// THIS IS YOUR EXISTING UPDATEORDERSTATUS FUNCTION, UNCHANGED
async function updateOrderStatus(orderId, status) {
  try {
    const token = localStorage.getItem('adminToken'); 
    const response = await fetch(`http://127.0.0.1:8000/api/admin/orders/${orderId}/status`, {
      method: 'PUT',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}` 
      },
      body: JSON.stringify({ status })
    });

    if (response.ok) {
      const data = await response.json();
      const order = data.order;

      showToast(`Order ${order.order_id} marked as ${status}`, "success");

      const message = `Hello ${order.delivery_name ?? order.user?.name ?? 'Customer'}, your order ${order.order_id} has been ${status}.`;
      if (order.delivery_phone) {
        try {
          window.electronAPI.sendSMS(order.delivery_phone, message);
          console.log(`SMS sent to ${order.delivery_phone}`);
        } catch (smsError) {
          console.error('Failed to send SMS:', smsError);
        }
      } else {
        console.warn('No phone number found for this order.');
      }

      fetchOrders();
    } else {
      console.error("Failed to update order status");
      showToast("Error updating order status", "error");
    }
  } catch (error) {
    if (error.response) {
      console.error("API response error:", error.response);
    } else if (error.request) {
      console.error("No response from API:", error.request);
    } else {
      console.error("Error in request setup:", error.message);
    }
    showToast("Something went wrong while updating status.", "error");
  }
}

// THIS IS YOUR EXISTING HANDLEEDITSTATUS FUNCTION, UNCHANGED
function handleEditStatus(orderId, newStatus) {
  if (!newStatus) return;
  updateOrderStatus(orderId, newStatus);
}

// THIS IS YOUR EXISTING DELETEORDER FUNCTION, UNCHANGED
async function deleteOrder(orderId) {
  // Grab the order_id from the table row for nicer message
  const row = document.querySelector(`#ordersTable tbody tr button[onclick="deleteOrder(${orderId})"]`)?.closest('tr');
  const orderCode = row?.querySelector('td span')?.textContent || orderId;

  if (!confirm(`Are you sure you want to delete Order ${orderCode}?`)) return;

  try {
    const token = localStorage.getItem('adminToken'); 
    const response = await fetch(`http://127.0.0.1:8000/api/admin/orders/${orderId}`, {
      method: 'DELETE',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}` 
      },
    });

    if (response.ok) {
      showToast(`Order ${orderCode} has been deleted`, "success");
      fetchOrders();
    } else {
      console.error("Failed to delete order");
      showToast("Error deleting order", "error");
    }
  } catch (error) {
    console.error("Error deleting order:", error);
    showToast("Something went wrong while deleting the order", "error");
  }
}

// Auto-load
document.addEventListener('DOMContentLoaded', () => {
  fetchOrders();
});




document.getElementById('appointmentsReloadBtn').addEventListener('click', loadAppointments);
appointmentsStatusFilter.addEventListener('change', loadAppointments);

loadAppointments();


// Enable Enter key to submit forms properly
document.addEventListener('keydown', function(event) {
    if (event.key === "Enter") {
      const active = document.activeElement;

      // Product form
      if (active.closest("#productForm")) {
        event.preventDefault();
        document.getElementById("productForm").dispatchEvent(new Event("submit"));
      }

      // Edit form
      if (active.closest("#editForm")) {
        event.preventDefault();
        document.getElementById("editForm").dispatchEvent(new Event("submit"));
      }

      // Transactions form
      if (active.closest("#transactions")) {
        event.preventDefault();
        submitTransaction();
      }

      // Chat
      if (active.closest("#chat")) {
        event.preventDefault();
        sendMessage();
      }
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
  const loginForm = document.getElementById("loginForm");
  if (loginForm) {
    loginForm.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("loginBtn").click();
      }
    });
  }
});


// TRACKING SYSTEM
async function initializeTracking() {
    // --- DATA & CONFIGURATION ---
    const STAGES = ['Approved', 'Preparing', 'Shipment', 'Shipped Out', 'On Delivery', 'Delivered'];
    const STAGE_ICONS = {
        'Approved': 'check-circle-2', 'Preparing': 'package-search', 'Shipment': 'truck',
        'Shipped Out': 'send', 'On Delivery': 'map-pin', 'Delivered': 'home'
    };
    let orders = [];

    // --- DOM ELEMENTS ---
    const trackingSection = document.getElementById('tracking-section');
    const toastElement = document.getElementById('toast-notification');
    const toastMessage = document.getElementById('toast-message');

    // --- FUNCTIONS ---

    // ADDED: Helper function to format the timestamp string.
    const formatOrderTimestamp = (isoString) => {
        if (!isoString) return 'Not available';
        const date = new Date(isoString);
        const options = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        };
        return date.toLocaleString('en-US', options);
    };

    const showTrackingToast = (message) => {
        toastMessage.textContent = message;
        toastElement.classList.add('toast-active');
        setTimeout(() => {
            toastElement.classList.remove('toast-active');
        }, 3000);
    };

    const updateTrackerUI = (orderCard, currentStage) => {
        const currentStageIndex = STAGES.indexOf(currentStage);
        const steps = orderCard.querySelectorAll('.progress-step');
        steps.forEach((step, index) => {
            step.classList.remove('current', 'completed', 'tracking-pending');
            
            if (index < currentStageIndex) {
                step.classList.add('completed');
            } else if (index === currentStageIndex) {
                step.classList.add('current');
            } else {
                step.classList.add('tracking-pending');
            }
        });
        
        const dropdown = orderCard.querySelector('.stage-select');
        const nextButton = orderCard.querySelector('.next-stage-btn');
        const isDelivered = currentStage === 'Delivered';
        const isAtFinalAdminStage = currentStage === 'On Delivery';

        if (dropdown) {
            dropdown.value = currentStage;
            dropdown.disabled = isDelivered;
        }
        if (nextButton) {
            nextButton.disabled = isAtFinalAdminStage || isDelivered;
        }
    };

    const renderOrders = () => {
        trackingSection.innerHTML = '';
        if (orders.length === 0) {
            trackingSection.innerHTML = `<p style="text-align: center; color: #6b7280;">No approved orders to track at the moment.</p>`;
            return;
        }
        orders.forEach(order => {
            const orderCard = document.createElement('div');
            orderCard.className = 'tracking-order-card';
            orderCard.dataset.orderDbId = order.id;
            orderCard.dataset.orderPublicId = order.orderId;
            // MODIFIED: Updated text, class, and used the new formatting function.
            orderCard.innerHTML = `
                <div class="tracking-header">
                    <div>
                        <h2 class="tracking-order-id">${order.orderId}</h2>
                        <p class="tracking-customer-name">Customer: ${order.customerName}</p>
                        <p class="tracking-timestamp">Created order time: ${formatOrderTimestamp(order.createdAt)}</p>
                    </div>
                    <div class="tracking-actions">
                        <select class="stage-select">
                            ${STAGES.map(stage => `<option value="${stage}" ${order.currentStage === stage ? 'selected' : ''}>${stage}</option>`).join('')}
                        </select>
                        <button class="next-stage-btn">Next Stage</button>
                    </div>
                </div>
                <div class="progress-tracker-container">
                    ${STAGES.map(stage => `
                        <div class="progress-step" data-stage="${stage}">
                            <div class="status-icon">
                                <i data-lucide="${STAGE_ICONS[stage]}" style="width:20px; height:20px;"></i>
                            </div>
                            <p class="status-text">${stage}</p>
                        </div>`).join('')}
                </div>`;
            trackingSection.appendChild(orderCard);
            updateTrackerUI(orderCard, order.currentStage);
        });
        lucide.createIcons();
    };

    const updateOrderStatusAPI = async (orderDbId, newStage) => {
        console.log(`🚀 API Request: Updating order ${orderDbId} to "${newStage}"...`);
        try {
            const res = await fetch(`http://127.0.0.1:8000/api/tracking/orders/${orderDbId}/tracking-stage`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ tracking_stage: newStage })
            });
            if (!res.ok) throw new Error('API update failed');
            console.log('✅ API Update Successful');
            return true;
        } catch (error) {
            console.error('❌ API Update Failed:', error);
            return false;
        }
    };
    
    // --- EVENT LISTENERS ---
    trackingSection.addEventListener('click', async (event) => {
        if (event.target.classList.contains('next-stage-btn')) {
            const button = event.target;
            const orderCard = button.closest('.tracking-order-card');
            const orderDbId = orderCard.dataset.orderDbId;
            const order = orders.find(o => o.id == orderDbId);
            const currentStageIndex = STAGES.indexOf(order.currentStage);
            
            if (currentStageIndex < STAGES.indexOf('On Delivery')) {
                const newStage = STAGES[currentStageIndex + 1];
                button.disabled = true;
                const success = await updateOrderStatusAPI(order.id, newStage);
                if (success) {
                    order.currentStage = newStage;
                    updateTrackerUI(orderCard, newStage);
                    showTrackingToast(`Order ${order.orderId} moved to ${newStage}.`);
                } else {
                    showTrackingToast(`Failed to update ${order.orderId}.`);
                    button.disabled = false;
                }
            }
        }
    });

    trackingSection.addEventListener('change', async (event) => {
        if (event.target.classList.contains('stage-select')) {
            const dropdown = event.target;
            const newStage = dropdown.value;
            const orderCard = dropdown.closest('.tracking-order-card');
            const orderDbId = orderCard.dataset.orderDbId;
            const order = orders.find(o => o.id == orderDbId);

            if (newStage === 'Delivered') {
                showTrackingToast("'Delivered' status can only be set by the customer.");
                dropdown.value = order.currentStage;
                return;
            }

            if (order.currentStage !== newStage) {
                dropdown.disabled = true;
                const success = await updateOrderStatusAPI(order.id, newStage);
                if (success) {
                    order.currentStage = newStage;
                    updateTrackerUI(orderCard, newStage);
                    showTrackingToast(`Order ${order.orderId} updated to ${newStage}.`);
                } else {
                    showTrackingToast(`Failed to update ${order.orderId}.`);
                    dropdown.value = order.currentStage;
                }
                dropdown.disabled = newStage === 'Delivered';
            }
        }
    });

    // --- INITIALIZATION ---
    try {
        const response = await fetch('http://127.0.0.1:8000/api/admin/orders', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if(!response.ok) throw new Error('Failed to fetch orders for tracking.');
        const allOrders = await response.json();
        
        orders = allOrders
            .filter(o => o.status === 'Approved')
            .map(order => ({
                id: order.id,
                orderId: order.order_id,
                customerName: order.delivery_name ?? order.user?.name ?? 'Unknown',
                currentStage: order.tracking_stage || 'Approved',
                createdAt: order.created_at
            }));
        renderOrders();
    } catch (error) {
        console.error("Error initializing tracking section:", error);
        trackingSection.innerHTML = `<p style="text-align: center; color: red;">Could not load tracking data.</p>`;
    }
}
  </script>
</body>
</html>

